let ChatHistory=[],ChatVectorLimit=20,ArticleSimilarRate=1,MatchRelevantArticlesBasedOnConversation=!0;var currentMode="",showChatter=!1,runningAI=!1,relativeArticles=[],extraTranslationRequirement="";let UIList={},UIAction={},renderI18N=(a,e)=>{[...e.querySelectorAll("[titlePath]")].forEach(e=>{var t=e.getAttribute("titlePath");"IMG"===e.tagName?e.title=readData(a,t):e.innerText=readData(a,t)}),[...e.querySelectorAll("[htmlPath]")].forEach(e=>{var t=e.getAttribute("htmlPath");e.innerHTML=readData(a,t)}),[...e.querySelectorAll("[placeholderName]")].forEach(e=>{var t=e.getAttribute("placeholderName");e.placeholder=readData(a,t)||t})},mountPage=t=>{var e=(e=globalThis.PageContents.mainPage).replace(/\{extension_root\}/gi,chrome.runtime.getURL("").replace(/\/\s*$/,"")),a=newEle("div");a.style.display="none",a.innerHTML=e,[...a.querySelectorAll("*")].forEach(i=>{var e=i.getAttribute("id");e&&(UIList[e]=i).removeAttribute("id"),[...i.attributes].forEach(e=>{var t,a=e.nodeName;a.match(/^@/)&&(a=a.replace(/^@+/,""))&&(t=UIAction[e.nodeValue])&&(i.addEventListener(a,t),i.removeAttribute(e.nodeName))}),i.classList.add("cyprite")}),[...a.children].forEach(e=>{renderI18N(t,e),document.body.appendChild(e)}),a.innerHTML="",a=null},generateAIPanel=async e=>{await waitForMountUtil("panel"),mountPage(e),UIList.TranslationLanguage.value=LangName[myLang]||myLang,generateTranslationExtraRequirementPanel(),document.body.appendChild(UIList.Container)},generateModelList=async()=>{var e=await chrome.storage.local.get(["apiKey","AImodel"]),i=e.AImodel||"",t=e.apiKey||{};ModelList.splice(0),ModelOrder.forEach(e=>{t[e]&&AI2Model[e]&&ModelList.push(...AI2Model[e])}),UIList.ModelList.innerHTML="",ModelList.forEach(e=>{var t,a=ModelNameList[e];a&&((t=newEle("div","cyprite","panel_model_item")).innerText=a,t.setAttribute("name",e),e===i&&t.classList.add("current"),UIList.ModelList.appendChild(t))})},generateTranslationExtraRequirementPanel=()=>{var t=UIList.Container.querySelector(".panel_extrareq_inputform textarea");UIList.Container.querySelector(".panel_extrareq_inputform div.input_sender").addEventListener("click",()=>{extraTranslationRequirement=t.value;var e=UIList.TranslationLanguage.value||translationInfo.lang||myLang;translatePage(!0,e,translationInfo.content||"",extraTranslationRequirement)})},addSummaryAndRelated=(e,t,a,i)=>{t.innerHTML=marked.parse(a,{breaks:!0})||e.conversation.AIFailed;var a=newEle("h2","cyprite","related_articles_area"),r=(a.innerText=e.summarizeArticle.relatedArticles,newEle("ul","cyprite","related_articles_list"));i&&i.length?i.forEach(e=>{var t=newEle("li","cyprite","related_articles_item"),a=newEle("a","cyprite","related_articles_link");a.innerText=e.title,a.href=e.url,a.target="_blank",t.appendChild(a),r.appendChild(t)}):r.innerHTML="<li>"+e.summarizeArticle.noRelatedArticle+"</li>",t.appendChild(a),t.appendChild(r)},addChatItem=(e,t)=>{var a=I18NMessages[myLang]||I18NMessages.en,i=newEle("div","cyprite","chat_item"),r=!1,n=newEle("div","cyprite","chat_title");if("human"===t?(n.innerText=a.conversation.yourTalkPrompt,i.classList.add("human")):"cyprite"===t?(n.innerText=a.cypriteName+":",i.classList.add("ai")):(r=!0,n.innerText=t,i.classList.add("other")),i.appendChild(n),e){t=newEle("div","cyprite","chat_content");t.innerHTML=marked.parse(e,{breaks:!0})||a.conversation.AIFailed,t._data=e,i.appendChild(t)}else if(!r)return;n=newEle("div","cyprite","operator_bar");n.innerHTML='<img button="true" action="copyContent" src="'+chrome.runtime.getURL("/images/copy.svg")+'">',i.appendChild(n),UIList.HistoryList.appendChild(i),wait(60).then(()=>{UIList.History.scrollTop=UIList.History.scrollHeight-UIList.History.clientHeight})},resizeHistoryArea=e=>{resizeHistoryArea.timer&&clearTimeout(resizeHistoryArea.timer);e=isBoolean(e)?e?0:250:isNumber(e)?e:250;resizeHistoryArea.timer=setTimeout(()=>{resizeHistoryArea.timer=null;var e=UIList.Asker.parentNode.getBoundingClientRect(),e=UIList.History.parentNode.getBoundingClientRect().height-20-e.height-25;UIList.History.style.height=e+"px"},e)},showPageSummary=(UIAction.onCloseMeByMask=({target:e})=>{(e.classList.contains("panel_mask")||e.classList.contains("panel_frame"))&&UIAction.onCloseMe()},UIAction.updateModelList=async a=>{var e;a&&isString(a)||(e=await chrome.storage.local.get(["AImodel"]),a=e.AImodel||""),[...UIList.ModelList.querySelectorAll(".panel_model_item")].forEach(e=>{var t=e.getAttribute("name");a===t?e.classList.add("current"):e.classList.remove("current")})},UIAction.onChooseModel=async({target:e})=>{e.classList.contains("panel_model_item")&&(e=e.getAttribute("name"),chrome.storage.local.set({AImodel:e}),UIAction.updateModelList(e),e=I18NMessages[myLang]||I18NMessages.en,Notification.show(e.cypriteName,e.mentions.changeModelSuccess,"middleTop","success",2e3))},UIAction.onCloseMe=()=>{document.body.classList.remove("showCypritePanel"),document.body.classList.add("showCypriteAccess")},UIAction.onShowPanel=()=>{document.body.classList.remove("showCypriteAccess"),UIList.QuickAccess.classList.remove("showDialogInputter"),UIAction.onShowPageSummary()},UIAction.onShowDialogInputter=async()=>{UIList.QuickAccess.classList.add("showDialogInputter"),await wait(300),UIList.DialogInputter.focus()},UIAction.onQuickSend=async e=>{if("Enter"===e.key&&e.ctrlKey){e=UIList.DialogInputter.value;if(e){UIList.DialogInputter.value="",runningAI=!0;var t=I18NMessages[myLang]||I18NMessages.en,a=(UIList.QuickAccess.classList.remove("showDialogInputter"),Notification.show(t.cypriteName,t.thinkingHeartBeating,"middleBottom","mention",864e5));if(MatchRelevantArticlesBasedOnConversation)try{n=await askAIandWait("embeddingContent",{title:"Request",article:e})}catch(e){n=void 0,Notification.show(t.cypriteName,e,"middleTop","error",5e3)}var i=null;if(n){if(!conversationVector&&pageVector&&(conversationVector=[],pageVector.forEach(e=>{conversationVector.push({weight:e.weight,vector:[...e.vector]})})),conversationVector){conversationVector.push(...n),conversationVector.length>ChatVectorLimit&&(conversationVector=conversationVector.splice(conversationVector.length-ChatVectorLimit,ChatVectorLimit));try{i=await askSWandWait("FindSimilarArticle",{url:location.href,vector:conversationVector})}catch(e){i=[],Notification.show(t.cypriteName,e,"middleTop","error",5e3)}findRelativeArticles(),relativeArticles.forEach(t=>{var a;i.some(e=>{if(e.hash&&t.hash){if(e.hash===t.hash)return a=e,!0}else if(e.url===t.url)return a=e,!0}),a?(a.similar<t.similar&&(a.similar=t.similar),a.similar*=ArticleSimilarRate):i.push(t)}),i.sort((e,t)=>t.similar-e.similar)}}else i=[...relativeArticles];var r,i=filterSimilarArticle(i,10),{title:n,content:o}=pageInfo,o=o||getPageContent(document.body,!0);try{r=await askAIandWait("askArticle",{url:location.href,title:n,content:o,question:e,related:i})}catch(e){Notification.show(t.cypriteName,e,"middleTop","error",5e3)}r=r||t.conversation.AIFailed,r=marked.parse(r,{breaks:!0})||t.conversation.AIFailed,UIList.QuickReplyContent.innerHTML=r,UIList.QuickAccess.classList.add("showQuickReply"),a._hide(),runningAI=!1,MatchRelevantArticlesBasedOnConversation&&conversationVector&&askAIandWait("embeddingContent",{title:"Request",article:r}).then(e=>{e&&(conversationVector.push(...e),conversationVector.length>ChatVectorLimit)&&(conversationVector=conversationVector.splice(conversationVector.length-ChatVectorLimit,ChatVectorLimit))}).catch(e=>{Notification.show(t.cypriteName,e,"middleTop","error",5e3)})}}},UIAction.onCloseQuickDialog=()=>{UIList.QuickAccess.classList.remove("showDialogInputter")},UIAction.onCloseQuickReply=()=>{UIList.QuickAccess.classList.remove("showQuickReply"),UIList.QuickReplyContent.innerHTML=""},UIAction.onChatTrigger=async()=>{if(UIList.ChatTrigger){var e=I18NMessages[myLang]||I18NMessages.en;if(showChatter=!showChatter){for(var t of UIList.Panel.querySelectorAll('.panel_tabs_area .panel_button[group="'+currentMode+'"]'))t.classList.add("show");UIList.ChatTrigger.innerText=e.buttons.hideChatPanel,UIList.Panel.setAttribute("chat","true"),await wait(100),UIList.Asker.focus(),resizeHistoryArea(!0),await wait(60),UIList.History.scrollTop=UIList.History.scrollHeight-UIList.History.clientHeight}else{for(var a of UIList.Panel.querySelectorAll('.panel_tabs_area .panel_button[group="'+currentMode+'"]'))a.classList.remove("show");UIList.ChatTrigger.innerText=e.buttons.showChatPanel,UIList.Panel.setAttribute("chat","false")}}},UIAction.onContentPaste=e=>{e.preventDefault();var t=e.clipboardData.getData("text/html"),e=e.clipboardData.getData("text/plain")||e.clipboardData.getData("text"),t=t?getPageContent(t,!0):e;t&&document.execCommand("insertText",!1,t)},UIAction.onAfterInput=e=>{resizeHistoryArea(),e.ctrlKey&&"Enter"===e.key&&(e.preventDefault(),UIAction.onSendToCyprite())},UIAction.onSendToCyprite=async()=>{runningAI=!0;var r,n=I18NMessages[myLang]||I18NMessages.en,o=getPageContent(UIList.Asker,!0);if(o){if(addChatItem(o,"human"),UIList.Asker.innerText=n.conversation.waitForAI,UIList.Asker.setAttribute("contentEditable","false"),resizeHistoryArea(60),"summary"===currentMode){let t;if(MatchRelevantArticlesBasedOnConversation)try{t=await askAIandWait("embeddingContent",{title:"Request",article:o})}catch(e){t=null,Notification.show(n.cypriteName,e,"middleTop","error",5e3)}let i=null;if(t){if(!conversationVector&&pageVector&&(conversationVector=[],pageVector.forEach(e=>{conversationVector.push({weight:e.weight,vector:[...e.vector]})})),conversationVector){conversationVector.push(...t),conversationVector.length>ChatVectorLimit&&(conversationVector=conversationVector.splice(conversationVector.length-ChatVectorLimit,ChatVectorLimit));try{i=await askSWandWait("FindSimilarArticle",{url:location.href,vector:conversationVector})}catch(e){i=[],Notification.show(n.cypriteName,e,"middleTop","error",5e3)}findRelativeArticles(),relativeArticles.forEach(t=>{var a;i.some(e=>{if(e.hash&&t.hash){if(e.hash===t.hash)return a=e,!0}else if(e.url===t.url)return a=e,!0}),a?(a.similar<t.similar&&(a.similar=t.similar),a.similar*=ArticleSimilarRate):i.push(t)}),i.sort((e,t)=>t.similar-e.similar)}}else i=[...relativeArticles];i=filterSimilarArticle(i,10);let{title:e,content:a}=pageInfo;a=a||getPageContent(document.body,!0);try{r=await askAIandWait("askArticle",{url:location.href,title:e,content:a,question:o,related:i})}catch(e){Notification.show(n.cypriteName,e,"middleTop","error",5e3)}}else if("translate"===currentMode){var e=UIList.TranslationLanguage.value||translationInfo.lang||myLang,e=chooseTargetLanguage(e);try{r=await askAIandWait("translateSentence",{lang:e,content:o})}catch(e){Notification.show(n.cypriteName,e,"middleTop","error",5e3)}}r=r||n.conversation.AIFailed,addChatItem(r,"cyprite"),UIList.Asker.innerText="",UIList.Asker.setAttribute("contentEditable","true"),resizeHistoryArea(60),await wait(),UIList.Asker.focus(),runningAI=!1,MatchRelevantArticlesBasedOnConversation&&conversationVector&&askAIandWait("embeddingContent",{title:"Request",article:r}).then(e=>{e&&(conversationVector.push(...e),conversationVector.length>ChatVectorLimit)&&(conversationVector=conversationVector.splice(conversationVector.length-ChatVectorLimit,ChatVectorLimit))}).catch(e=>{Notification.show(n.cypriteName,e,"middleTop","error",5e3)})}},UIAction.clearSummaryConversation=async()=>{runningAI?Notification.show(messages.cypriteName,messages.mentions.clearConversationWhileRunning,"middleTop","warn",2e3):(askSWandWait("ClearSummaryConversation",location.href).catch(e=>{Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}),UIList.HistoryList.innerHTML="")},UIAction.summarizePage=async()=>{summarizePage(!0)},UIAction.onClickChatItem=({target:e})=>{for(;"true"!==e.getAttribute("button");)if((e=e.parentNode)===document.body)return;"copyContent"===e.getAttribute("action")&&onCopyContent(e)},UIAction.onShowPageSummary=()=>{showPageSummary(pageSummary||"")},UIAction.onShowTranslationResult=()=>{showTranslationResult(translationInfo.translation)},UIAction.onShowComprehensive=()=>{sendMessage("GotoConversationPage",null,"BackEnd")},UIAction.copyReplyContent=async()=>{"summary"===currentMode?e=pageSummary:"translate"===currentMode&&(e=translationInfo.translation),await navigator.clipboard.writeText(e);var e=I18NMessages[myLang]||I18NMessages.en;Notification.show(e.cypriteName,e.mentions.contentCopied,"middleTop","success",2e3)},async(e,t=!1)=>{currentMode="summary";var a=await restoreConversation(),i=I18NMessages[myLang]||I18NMessages.en;UIList.Container||await generateAIPanel(i),generateModelList(),addSummaryAndRelated(i,UIList.Container.querySelector(".content_container"),e),restoreHistory(a),resizeHistoryArea(!0),switchPanel("summary"),t?(document.body.classList.remove("showCypritePanel"),document.body.classList.add("showCypriteAccess")):(document.body.classList.add("showCypritePanel"),document.body.classList.remove("showCypriteAccess"),findRelativeArticles())}),showTranslationResult=async(e,t)=>{currentMode="translate";var a=I18NMessages[myLang]||I18NMessages.en,i=(UIList.Container||await generateAIPanel(a),UIList.TranslationLanguage.value=translationInfo.lang||LangName[myLang]||myLang,[]);i.push(["ai",a.translation.instantTranslateHint]),t&&t.length&&i.push(...t),generateModelList(),UIList.Container.querySelector(".content_container").innerHTML=marked.parse(e||a.translation.noTranslatedYet,{breaks:!0})||a.conversation.AIFailed,restoreHistory(i),resizeHistoryArea(!0),switchPanel("translate"),document.body.classList.add("showCypritePanel"),document.body.classList.remove("showCypriteAccess")},switchPanel=e=>{var t,a,i,r="show"+e[0].toUpperCase()+e.substring(1);UIList.Panel.setAttribute("name",e);for(t of UIList.Panel.querySelectorAll(".panel_tabs_area .panel_tab"))t.classList.remove("active");UIList.Panel.querySelector(`.panel_tabs_area .panel_tab[action="${r}"]`).classList.add("active");for(a of UIList.Panel.querySelectorAll(".panel_container .panel_button"))a.classList.remove("active");for(i of UIList.Panel.querySelectorAll(`.panel_container .panel_button[group="${e}"]`))i.classList.add("active")},onCopyContent=async e=>{for(;!e.classList.contains("chat_item");)if((e=e.parentElement)===document.body)return;var t=(t=(e=e.querySelector(".chat_content"))._data)||getPageContent(e,!0),t=(await navigator.clipboard.writeText(t),I18NMessages[myLang]||I18NMessages.en);Notification.show(t.cypriteName,t.mentions.contentCopied,"middleTop","success",2e3),UIList.Asker.focus()},restoreHistory=e=>{UIList.HistoryList.innerHTML="",e&&e.forEach(e=>{"human"===e[0]?addChatItem(e[1],"human"):"ai"===e[0]&&addChatItem(e[1],"cyprite")})},restoreConversation=async()=>{if(pageInfo&&pageInfo.title)try{await askSWandWait("GetConversation",location.href)}catch(e){Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}},normalVector=e=>{var t=0,i=[],a=0;e.forEach(e=>{a=Math.max(e.vector.length,a)});for(let e=0;e<a;e++)i.push(0);return e.forEach(a=>{t+=a.weight,a.vector.forEach((e,t)=>{i[t]+=e*a.weight})}),i=i.map(e=>e/t),a=0,i.forEach(e=>a+=e**2),a=a**.5,i=i.map(e=>e/a),{weight:t,vector:i}},filterSimilarArticle=(e,t)=>{var a=[];if(!e)return[];(e=e.filter(e=>!a.includes(e.hash)&&(a.push(e.hash),!0))).length>t&&e.splice(t);var i=[];return e=e.map(e=>(i.push({title:e.title,similar:e.similar}),{url:e.url,title:e.title,similar:e.similar,hash:e.hash})),logger.info("Content","Similar Articles:"),console.table(i),e},findRelativeArticles=()=>{var t;pageInfo&&(t=[],[...UIList.HistoryList.querySelectorAll(".chat_item.human .chat_content")].forEach(e=>{t.push(e._data)}),sendMessage("FindRelativeArticles",{url:location.href,hash:pageHash,vector:pageVector,content:[pageInfo.content],requests:t},"BackEnd"))};