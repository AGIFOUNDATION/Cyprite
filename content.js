let PageName="FrontEnd",RegChar=/[\u4e00-\u9fa5]|[\w-]+|[\d\.]+/g,CypriteNotify={},TagNameWeight={ARTICLE:5,POST:3,SECTION:2,CONTENT:1.5,CONTAINER:1,MAIN:1,DIV:.1},TagClassWeight={article:3,post:1.5,content:1,notion:.5,page:.2,container:.1};var myLang=DefaultLang;chrome.storage.sync.onChanged.addListener(e=>{e=e.lang;e&&(myLang=e.newValue)}),chrome.storage.sync.get("lang",e=>{myLang=e.lang||myLang});let isRuntimeAvailable=()=>{try{return chrome.runtime,!!chrome.runtime&&!!chrome.runtime.connect&&!!chrome.runtime.id}catch{return!1}};var port,runtimeID=chrome.runtime.id,sendMessage=(e,t,a,n,i=PageName)=>{if(!port){if(!isRuntimeAvailable())return void logger.error("Runtime","Runtime cannot connect");logger.info("Runtime","Runtime Reconnect: "+runtimeID),!chrome.runtime?.id&&globalThis.Notification&&Notification.show(messages.cypriteName,messages.refreshHint,"rightTop","fetal",1e4),(port=chrome.runtime.connect(runtimeID,{name:"cyberbutler_contentscript"})).onDisconnect.addListener(onPortDisconnect),port.onMessage.addListener(onPortMessage)}port.postMessage({event:e,data:t,target:a,tid:n,sender:i})};let sendMessageToCyprite=(e,t,a,n)=>{window.postMessage({extension:"CypriteTheCyberButler",type:"F2P",data:{event:e,data:t,sender:a,sid:n}})},onPortDisconnect=()=>{logger.info("PORT","Disconnected"),port=null},onPortMessage=e=>{var t;e.target===PageName?(t=EventHandler[e.event])&&t(e.data,e.sender||"BackEnd",e.sid):"PageEnd"===e.target&&sendMessageToCyprite(e.event,e.data,e.sender,e.sid)};chrome.runtime.onConnect.addListener(()=>{logger.info("Runtime","HeartBeated")});var pageVector,pageInfo=null,pageHash=null;let findContainer=()=>{var l,e,t,a,n,i,r,o,s,g,c={},d=0,m=document.body.querySelectorAll("p, div, span");for(e of m)e.classList&&e.classList.contains("cyprite")||(a=c[t=e.tagName]||{total:0,value:0},0<(i=(i=clearHTML(e.innerHTML,!1).match(RegChar))?i.length:0)&&(n=(n=e.textContent.match(RegChar))?n.length:0,a.total++,a.value+=n/i,c[t]=a));for(r in c){var h=c[r],u=h.value/h.total;d<u&&(d=u,l=r),h.weight=u,h.density=h.value/h.total}for(o of m=document.body.querySelectorAll(l))o.classList&&o.classList.contains("cyprite")||(s=(s=o.textContent.match(RegChar))?s.length:0,g=(g=clearHTML(o.innerHTML,!1).match(RegChar))?g.length:0,o._density=0<g?s/g:0,o._tagWeight=calculateTagWeight(o),o._value=s*o._tagWeight,o._weight=s*o._density);return(m=(m=[...m=document.body.querySelectorAll("article, section, div, main, container, app, post, content, entry")]).filter(e=>!!e.textContent.trim().length)).sort((e,t)=>e.textContent.length-t.textContent.length),(m=m.map(e=>{if(!(e.tagName===l||e.classList&&e.classList.contains("cyprite"))){var t,a=(a=e.textContent.match(RegChar))?a.length:0,n=(n=clearHTML(e.innerHTML,!1).match(RegChar))?n.length:0,i=(e._density=0<n?a/n:0,0),r=0;for(t of e.children)r++,i+=t._weight||1;var o,s=0,g=0;for(o of e.querySelectorAll(l))g++,s+=o._weight;return r++,g++,e._tagWeight=calculateTagWeight(e),e._value=(i+s)*e._tagWeight,e._weight=(i+s*r/g)/2*e._density,e}})).sort((e,t)=>t._value-e._value),target=m[0]},calculateTagWeight=t=>{var a,n,i,r,e=1,o=0;for(a in e+=TagNameWeight[t.tagName]||0,TagClassWeight){let e=t.id;!e||(e=e.toLowerCase()).indexOf(a)<0||o<(n=TagClassWeight[a])&&(o=n)}for(i in e+=o,o=0,TagClassWeight){let e=t.className;!e||(e=e.toLowerCase()).indexOf(i)<0||o<(r=TagClassWeight[i]/2)&&(o=r)}return e+=o},removeChildren=(e,t)=>{var a;for(a of e.querySelectorAll(t))a.parentNode.removeChild(a)},checkIsArticle=e=>{var t=(t=document.body.textContent.match(RegChar))?t.length:0,a=0,n=(a=(a=e&&e.textContent?e.textContent.match(RegChar):a)?a.length:0,0===t?0:a/t),i=document.body.innerHTML.replace(/<([\w\-]+)(\s+[\w\W]*?)?>/g,(e,t)=>"<"+t+">").match(RegChar),t=0===(i=i?i.length:0)?0:t/i,e=(i=0)===(i=(i=e&&e.innerHTML?e.innerHTML.replace(/<([\w\-]+)(\s+[\w\W]*?)?>/g,(e,t)=>"<"+t+">").match(RegChar):i)?i.length:0)?0:a/i,i=1.5*n+.35*t+e/t/.9*1.15;return i*=a/(400+a),logger.log("DOC","Article Density Weights:",Math.round(1e4*n)/100+"%",Math.round(1e4*t)/100+"%",Math.round(1e4*e)/100+"%",Math.round(i/1.4*1e4)/100+"%"),1.4<i},getPageTitle=e=>{var i=clearHTML(document.querySelector("html").innerHTML),a=clearHTML(e.outerHTML),r=[],o=(e.tagName||"").length+2,t=(i.replace(a,(e,t)=>{r.push([t,t+a.length])}),document.querySelectorAll('header, h1, h2, [id*="title"], [name*="title"], [property*="title"], [id*="Title"], [name*="Title"], [property*="Title"], [id*="TITLE"], [name*="TITLE"], [property*="TITLE"]'));if(0===(t=(t=[...t]).map(e=>{if(e.outerHTML){var t=e.textContent||e.content||e.getAttribute("content")||e.value||e.getAttribute("value")||"";if(t=t.trim()){var a=clearHTML(e.outerHTML),n=[];if(i.replace(a,(e,t)=>{r.forEach(e=>{t<e[0]?n.push(e[0]-t-a.length):t<e[1]&&n.push(t-e[0]-o)})}),0!==(n=n.filter(e=>0<=e)).length)return n.sort((e,t)=>e-t),[e,n[0],t]}}}).filter(e=>!!e)).length)return document.title.trim();t.sort((e,t)=>e[1]-t[1]);var n,s,g,l,e=t[0][0],c=t[0][2];logger.strong("DOC",e),t=[[],[],[]];for(n of e.childNodes){let e=n.textContent||n.content||"";(e=e.trim())&&(s=n.nodeName,g=(n.className||"").toLowerCase(),l=(n.id||"").toLowerCase(),["TITLE","H1"].includes(s)||0<=l.indexOf("title")?t[0].push(e):(["H2"].includes(s)||0<=g.indexOf("title")||["DIV","P"].includes(s))&&t[1].push(e))}return 0<t[0].length?t[0].join(" "):0<t[1].length?t[1][0]:0<t[2].length?t[2][0]:c},getPageDescription=(e,t)=>e?(1===(e=(e=getPageContent(t)).split(/\n+/)).length?302<=(desc=e[0]).length&&(desc=desc.substr(0,150)+"..."+desc.substr(desc.length-150)):desc=e.map(e=>e.length<52?e:e.substr(0,25)+"..."+e.substr(e.length-25)).join("\n"),desc):((t=[...t=document.head.querySelectorAll('[name*="description"], [property*="description"]')].map(e=>(e.content||"").trim()).filter(e=>!!e)).sort((e,t)=>t.length-e.length),t[0]),getPageInfo=async()=>{var e={},t=findContainer();logger.strong("DOC",t),e.isArticle=checkIsArticle(t),e.isArticle?(e.title=getPageTitle(t),e.content=getPageContent(t,!0)):(e.title=document.title.trim(),e.content=getPageContent(document.body,!1));try{var a=await askSWandWait("CalculateHash",e.content);e.hash=a}catch(e){Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}return e.description=getPageDescription(e.isArticle,t),logger.em("DOC",e),e},chooseTargetLanguage=e=>{if(e&&e.toLowerCase()!==myLang&&LangName[myLang].toLowerCase()!==e.toLowerCase())return LangName[e]||e;for(var t in LangName)if(t!==myLang){e=LangName[t];break}return e};var notificationMounted=!1,notificationMountingRes=[];let UtilsState={},waitForMountUtil=a=>new Promise(e=>{var t=UtilsState[a];if(t||(t={loaded:!1,reses:[]},UtilsState[a]=t),t.loaded)return e();t.reses.push(e),sendMessage("MountUtil",a,"BackEnd")});var pageSummary=null,conversationVector=null;let summarizePage=async(e=!1)=>{runningAI=!0,UIList.ContentContainer&&(UIList.ContentContainer.innerHTML="");var t=(pageInfo=await getPageInfo()).content,a=pageInfo.hash,t="TITLE: "+pageInfo.title+"\n\n"+t;if(!e&&pageSummary&&pageHash&&a===pageHash)showPageSummary(pageSummary);else{var n,i,r=I18NMessages[myLang]||I18NMessages[DefaultLang],e=Notification.show(r.cypriteName,r.summarizeArticle.running,e?"middleTop":"rightTop","message",864e5);try{(i=await askAIandWait("summarizeArticle",{title:pageInfo.title,article:t}))&&(n=i.embedding,i=i.summary)}catch(e){Notification.show(r.cypriteName,e,"middleTop","error",5e3)}e._hide(),i?(pageSummary=i,pageHash=a,pageVector=n,sendMessage("SavePageSummary",{title:pageInfo.title,summary:i,hash:a,embedding:n,content:pageInfo.content},"BackEnd"),showPageSummary(i)):(Notification.show(r.cypriteName,r.summarizeArticle.failed,"rightTop","fail",5e3),showPageSummary(""))}runningAI=!1};var translationInfo={lang:"",content:"",translation:""};let translatePage=async(e=!1,t,a,n)=>{runningAI=!0,UIList.ContentContainer&&(UIList.ContentContainer.innerHTML=""),a=a||(pageInfo=pageInfo||await getPageInfo()).content;var i,r=I18NMessages[myLang]||I18NMessages.en,e=Notification.show(r.cypriteName,r.translation.translatingArticle,e?"middleTop":"rightTop","message",864e5);t=t||myLang,t=LangName[t]||t,translationInfo.lang=t,translationInfo.content=a;try{i=await askAIandWait("translateContent",{lang:t,content:a,requirement:n}),translationInfo.translation=i}catch(e){Notification.show(r.cypriteName,e,"middleTop","error",5e3)}i&&await showTranslationResult(i),e._hide(),runningAI=!1},translateSelection=async e=>{runningAI=!0,UIList.ContentContainer&&(UIList.ContentContainer.innerHTML="");var t,a,n=I18NMessages[myLang]||I18NMessages.en,i=Notification.show(n.cypriteName,n.translation.translatingSelection,"rightTop","message",864e5),r=(UIList.TranslationLanguage&&(t=UIList.TranslationLanguage.value),t=chooseTargetLanguage(t),document.getSelection());if(r.isCollapsed)o=e;else{var o=r.getRangeAt(0).cloneContents();let t=newEle("div"),e=[...o.childNodes];e.forEach(e=>t.appendChild(e)),o=getPageContent(t,!1)}try{a=await askAIandWait("translateSentence",{lang:t,content:o})}catch(e){Notification.show(n.cypriteName,e,"middleTop","error",5e3)}a&&await showTranslationResult("",[["human",o],["ai",a]]),showChatter||await UIAction.onChatTrigger(),i._hide(),runningAI=!1},checkPageNeedAI=async(e,t,a)=>{e=e.replace(/^[\w\-\d_]*?:\/\//i,"");try{n=await askSWandWait("CheckPageNeedAI",{page:e,path:t,host:a})}catch(e){return Notification.show(messages.cypriteName,e,"middleTop","error",5e3),!1}var e=(n.page.need+1)/(n.page.visited+1),t=(n.path.need+1)/(n.path.visited+1),a=(n.host.need+1)/(n.host.visited+1),n=1<e+t+a;return logger.info("Page",e,t,a,n),n},updatePageNeedAIInfo=async(e,t,a,n)=>{e=e.replace(/^[\w\-\d_]*?:\/\//i,"");try{await askSWandWait("UpdatePageNeedAIInfo",{page:e,path:t,host:a,need:n})}catch(e){Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}},NeedAIChecker={},askSWandWait=(n,i)=>new Promise((e,t)=>{for(var a=newID();NeedAIChecker[a];)a=newID();NeedAIChecker[a]=[e,t],sendMessage("AskSWAndWait",{id:a,action:n,data:i},"BackEnd")}),askAIandWait=(n,i)=>new Promise((e,t)=>{for(var a=newID();NeedAIChecker[a];)a=newID();NeedAIChecker[a]=[e,t],sendMessage("AskAIAndWait",{id:a,action:n,data:i},"BackEnd")}),EventHandler={getPageInfo:async(e,t)=>{"BackEnd"===t&&(logger.log("Page","Analyze Page Info: "+document.readyState),pageInfo=pageInfo||await getPageInfo(),sendMessage("GotPageInfo",pageInfo,"BackEnd"))},utilMounted:e=>{var t=UtilsState[e];t&&(t.loaded=!0,logger.info("Page","Util Loaded: "+e),e=t.reses,delete t.reses,e.forEach(e=>e()))},requestCypriteNotify:async e=>{var t=!!e&&!!e.forceShow;if(!t){e=await checkPageNeedAI(location.href,location.host+location.pathname,location.hostname);if(logger.log("Page","Need AI: "+e),!e)return}if((await waitForMountUtil("notification"),t&&pageSummary&&pageHash&&pageInfo)&&(await getPageInfo()).hash===pageHash)return void showPageSummary(pageSummary);var a=I18NMessages[myLang]||I18NMessages.en;if(!CypriteNotify.RequestOperation){var n=Notification.show(a.cypriteName,a.newArticleMentionMessage,"rightTop","message",2e4),i=!1;let e=async e=>{if("BUTTON"===e.target.tagName){e=e.target.name;if("summarize"===e){if(i=!0,!pageSummary)try{(pageSummary=await askSWandWait("LoadPageSummary"))&&(pageVector=pageSummary.embedding,pageHash=pageSummary.hash,pageSummary=pageSummary.description)}catch(e){Notification.show(a.cypriteName,e,"middleTop","error",5e3)}n._hide(),await summarizePage()}else"translate"===e?(i=!0,n._hide(),await translatePage()):n._hide()}};n.addEventListener("click",e),n.onclose=async()=>{t||await updatePageNeedAIInfo(location.href,location.host+location.pathname,location.hostname,i),n.removeEventListener("click",e),n.onclose=null,CypriteNotify.RequestOperation=null},CypriteNotify.RequestOperation=n}},replyAskAndWait:e=>{var t=e.id,a=e.result,n=!0,i=null;if(!t&&e.data){if(t=(a=e.data).id,n=!1!==e.ok,!t)return;a=a.result,i=e.error}e=NeedAIChecker[t];e&&(delete NeedAIChecker[t],n?e[0](a):e[1](i))},onContextMenuAction:async e=>{if(await waitForMountUtil("notification"),"launchCyprite"===e.action){if(!pageSummary)try{(pageSummary=await askSWandWait("LoadPageSummary"))&&(pageVector=pageSummary.embedding,pageHash=pageSummary.hash,pageSummary=pageSummary.description)}catch(e){Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}await summarizePage()}else"translateSelection"===e.action&&await translateSelection(e.text)},foundRelativeArticles:e=>{var t,n;e&&e.length&&(t=[],relativeArticles=[...e].filter(e=>!t.includes(e.hash)&&(t.push(e.hash),!0)),n=UIList.Panel.querySelector(".related_articles_list"))&&(n.innerHTML="",relativeArticles.forEach(e=>{var t=newEle("li","cyprite","related_articles_item"),a=newEle("a","cyprite","related_articles_link");a.innerText=e.title,a.href=e.url,a.target="_blank",t.appendChild(a),n.appendChild(t)}))},requestHeartBeating:()=>{logger.log("AI","HeartBeating..."),UIList.ThingkingHint1&&(UIList.ThingkingHint1.classList.add("show"),UIList.ThingkingHint1.__timer&&clearTimeout(UIList.ThingkingHint1.__timer),UIList.ThingkingHint1.__timer=setTimeout(()=>{UIList.ThingkingHint1.__timer=null,UIList.ThingkingHint1.classList.remove("show")},2e3)),UIList.ThingkingHint2&&(UIList.ThingkingHint2.classList.add("show"),UIList.ThingkingHint2.__timer&&clearTimeout(UIList.ThingkingHint2.__timer),UIList.ThingkingHint2.__timer=setTimeout(()=>{UIList.ThingkingHint2.__timer=null,UIList.ThingkingHint2.classList.remove("show")},2e3))}},initArticleInfo=(document.onreadystatechange=async()=>{logger.log("Page","Ready State Changed: "+document.readyState),pageInfo=null,pageInfo=await getPageInfo(),"complete"===document.readyState&&sendMessage("PageStateChanged",{state:"loaded",url:location.href,pageInfo:pageInfo},"BackEnd")},document.addEventListener("visibilitychange",()=>{document.hidden?sendMessage("VisibilityChanged","hide","BackEnd"):sendMessage("VisibilityChanged","show","BackEnd")}),window.addEventListener("beforeunload",()=>{pageHash=pageSummary="",pageVector=pageInfo=null,sendMessage("VisibilityChanged","close","BackEnd")}),window.addEventListener("idle",()=>{sendMessage("VisibilityChanged","idle","BackEnd")}),window.addEventListener("load",()=>{logger.log("WIN","Loaded"),initArticleInfo()}),window.addEventListener("message",({data:e})=>{"CypriteTheCyberButler"===e.extension&&"P2F"===e.type&&((e=e.data).target===PageName&&null==e.tid?onPortMessage(e):sendMessage(e.event,e.data,e.target,e.tid,e.sender))}),async()=>{var e;try{e=await askSWandWait("LoadPageSummary")}catch(e){Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}e&&(pageSummary=e.description||pageSummary,pageHash=e.hash||pageHash,pageVector=e.embedding||pageVector,pageSummary)&&showPageSummary(pageSummary,!0)});sendMessage("PageStateChanged",{state:"open",url:location.href},"BackEnd");