let PageName="ConfigPage";var currentTabId=0;ActionCenter.saveConfig=async(e,n)=>{myInfo.name=n.name||myInfo.name,myInfo.info=n.info||"",myInfo.lang=n.lang,myInfo.lang&&(myInfo.lang=myInfo.lang.toLowerCase(),i18nList.includes(myInfo.lang))||(myInfo.lang=DefaultLang),myInfo.apiKey=n.apiKey||{},myInfo.useLocalKV=!ForceBackend&&!n.wsHost;var a={name:myInfo.name,info:myInfo.info,lang:myInfo.lang},a=(await Promise.all([chrome.storage.local.set({apiKey:myInfo.apiKey}),chrome.storage.sync.set(a)]),document.querySelector("html").setAttribute("lang",myInfo.lang),I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]);document.title=a.configPage.configurationTitle,Notification.show(a.cypriteName,a.configPage.configurationSaved,"rightBottom","success",3e3),sendMessage("SetConfig",n),renderI18N("configPage")},ActionCenter.goBack=()=>{location.href="./newtab.html"},ActionCenter.resetUsage=async()=>{await chrome.storage.local.remove(["llm_usage_record","model_usage_record"]),showUsage("LLMList",{}),showUsage("ModelList",{})},EventHandler.getWebSiteURLFailed=e=>{e.ok||(e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],Notification.show(e.cypriteName,e.configPage.connectFailed,"rightBottom","fail",3e3))},EventHandler.connectWSHost=async e=>{var n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];e&&e.ok?(await chrome.storage.local.set({wsHost:e.wsHost}),e.wsHost?(console.log("[WS] Connect Knowledge Vault: "+e.wsHost),Notification.show(n.cypriteName,n.configPage.wsConnected,"rightBottom","success",3e3)):(console.log("[WS] Use Edged Knowledge Vault."),Notification.show(n.cypriteName,n.configPage.useEdgedVault,"rightBottom","warn",5e3))):Notification.show(n.cypriteName,n.configPage.wsConnectFailed,"rightBottom","fail",5e3)};let loadAIUsage=async()=>{var e=await chrome.storage.local.get(["llm_usage_record","model_usage_record"]),n=e.llm_usage_record,a=e.model_usage_record,o={},t={};if(n)for(var i in n)o[i]=n[i];if(a)for(var s in a)t[s]=a[s];return{llm:o,model:t}},newLine=(e,n,a,o)=>{var t=newEle("div","tableLine"),i=newEle("span","tableItem");return i.innerText=e||"",t.appendChild(i),(i=newEle("span","tableItem")).innerText=n||"",t.appendChild(i),(i=newEle("span","tableItem")).innerText=a||"",t.appendChild(i),(i=newEle("span","tableItem")).innerText=o||"",t.appendChild(i),t},showUsage=(n,a)=>{var e;(n=document.querySelector('.tableList[name="'+n+'"]'))&&(n.innerHTML="",e=newLine("Name","Request","Input Tokens","Output Tokens"),n.appendChild(e),(a=Object.keys(a).map(e=>{var n=a[e];return{name:e,count:n.count,input:n.input,output:n.output}})).sort((e,n)=>n.count-e.count),a.forEach(e=>{e=newLine(e.name,e.count,e.input,e.output);n.appendChild(e)}))},init=async()=>{var[e,n]=await Promise.all([chrome.tabs.getCurrent(),loadAIUsage(),getConfig()]),a=I18NMessages[myInfo.lang]||I18NMessages.en,[e,a]=(currentTabId=e.id,ForceBackend&&[...document.body.querySelectorAll('[caseGroup="forceServer"]')].forEach(e=>{e.style.display="none"}),renderI18N("configPage"),document.querySelector("html").setAttribute("lang",myInfo.lang),document.title=a.configPage.configurationTitle,setGroupSwitcher(),registerAction(),await Promise.all([chrome.storage.local.get(["wsHost","apiKey"]),chrome.storage.sync.get(["name","info","lang"])])),a={name:a.name||"",lang:a.lang||DefaultLang,info:a.info||"",wsHost:e.wsHost||"",apiKey:e.apiKey};a.apiKey&&isString(a.apiKey)&&(a.apiKey={},a.apiKey.gemini=e.apiKey),setDataGroup("configuration",a),showUsage("LLMList",n.llm),showUsage("ModelList",n.model),changeTab("groupPersonel")};window.onload=init;