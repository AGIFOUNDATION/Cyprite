globalThis.AI=globalThis.AI||{},globalThis.AI.Claude={};let DefaultChatModel=AI2Model.claude[0],convertClaudeChinese=e=>(e=e&&e.trim())?e=(e=(e=e.split(/\r*\n\r*/)).map(e=>e=(e=(e=(e=(e=e.replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*[\(\)]|[\(\)]\s*[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/gi,e=>e=e.replace(/\s*([\(\)])\s*/g,(e,a)=>","===a?"，":":"===a?"：":";"===a?"；":"?"===a?"？":"!"===a?"！":"("===a?"（":")"===a?"）":a))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*[,:;\?\!]/gi,e=>e=e.replace(/\s*([,:;\?\!\(\)])\s*/g,(e,a)=>","===a?"，":":"===a?"：":";"===a?"；":"?"===a?"？":"!"===a?"！":"("===a?"（":")"===a?"）":a))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*\.+/gi,e=>e=e.replace(/\s*(\.+)\s*/g,(e,a)=>1===a.length?"。":"……"))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*\-{2,}|\-{2,}\s*[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/gi,e=>e=e.replace(/\s*(\-{2,})\s*/g,(e,a)=>"——"))).replace(/[\(（]\s*([\w\d_\-\+\*\\\/:;,\.\?\!@%#\^\&\(\)=]+)\s*[\)）]/g,(e,a)=>"("+a+")"))).join("\n"):"";AI.Claude.chat=async(e,a=DefaultChatModel,t={})=>{var u=[],s=Object.assign({},ModelDefaultConfig.Claude.chat,(ModelDefaultConfig[a]||{}).chat||{},t),t=(s.model=a,s.messages=u,Object.assign({},ModelDefaultConfig.Claude.header,(ModelDefaultConfig[a]||{}).header||{})),t=(t["x-api-key"]=myInfo.apiKey.claude,{method:"POST",headers:t});e.forEach(e=>{"system"===e[0]?s.system=e[1]:"human"===e[0]?u.push({role:"user",content:e[1]}):"ai"===e[0]&&u.push({role:"assistant",content:e[1]})}),"assistant"!==u[u.length-1].role&&u.push({role:"assistant",content:""}),t.body=JSON.stringify(s);e=Date.now();try{await requestRateLimitLock(a),updateRateLimitLock(a,!0),f=await waitUntil(fetch("https://api.anthropic.com/v1/messages",t)),updateRateLimitLock(a,!1)}catch(e){throw updateRateLimitLock(a,!1),e}e=Date.now()-e,logger.info("Claude","Chat: "+e/1e3+"s");var f,t=f=await f.json(),a=f.usage,e=(a&&(logger.info("Claude",`Usage: Input ${a.input_tokens}, Output: `+a.output_tokens),AIUsage.request++,AIUsage.input+=a.input_tokens,AIUsage.output+=a.output_tokens),f.content);if(e=e&&e[0])return e=convertClaudeChinese(e.text);throw e="",a=t.error?.message||"Error Occur!",logger.error("Claude",a),new Error(a)};