globalThis.AI=globalThis.AI||{},globalThis.AI.Claude={};let DefaultChatModel=AI2Model.claude[0],convertClaudeChinese=e=>(e=e&&e.trim())?e=(e=(e=e.split(/\r*\n\r*/)).map(e=>e=(e=(e=(e=(e=e.replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*[\(\)]|[\(\)]\s*[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/gi,e=>e=e.replace(/\s*([\(\)])\s*/g,(e,a)=>","===a?"，":":"===a?"：":";"===a?"；":"?"===a?"？":"!"===a?"！":"("===a?"（":")"===a?"）":a))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*[,:;\?\!]/gi,e=>e=e.replace(/\s*([,:;\?\!\(\)])\s*/g,(e,a)=>","===a?"，":":"===a?"：":";"===a?"；":"?"===a?"？":"!"===a?"！":"("===a?"（":")"===a?"）":a))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*\.+/gi,e=>e=e.replace(/\s*(\.+)\s*/g,(e,a)=>1===a.length?"。":"……"))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*\-{2,}|\-{2,}\s*[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/gi,e=>e=e.replace(/\s*(\-{2,})\s*/g,(e,a)=>"——"))).replace(/[\(（]\s*([\w\d_\-\+\*\\\/:;,\.\?\!@%#\^\&\(\)=]+)\s*[\)）]/g,(e,a)=>"("+a+")"))).join("\n"):"",assembleConversation=e=>{var a={messages:[]};return e.forEach(e=>{"system"===e[0]?a.system=e[1]:"human"===e[0]?a.messages.push({role:"user",content:e[1]}):"ai"===e[0]&&a.messages.push({role:"assistant",content:e[1]})}),"assistant"!==a.messages[a.messages.length-1].role&&a.messages.push({role:"assistant",content:""}),a};AI.Claude.chat=async(t,s=DefaultChatModel,e={})=>{for(var a=Object.assign({},ModelDefaultConfig.Claude.header,(ModelDefaultConfig[s]||{}).header||{}),u=(a["x-api-key"]=myInfo.apiKey.claude,Object.assign({},ModelDefaultConfig.Claude.chat,(ModelDefaultConfig[s]||{}).chat||{},e)),o=(u.model=s,Object.assign(u,assembleConversation(t)),{method:"POST",headers:a,body:JSON.stringify(u)}),n=[],r={count:0,input:0,output:0},f=!0,e=Date.now();;){let e;try{await requestRateLimitLock(s),updateRateLimitLock(s,!0),e=await waitUntil(fetch("https://api.anthropic.com/v1/messages",o)),updateRateLimitLock(s,!1)}catch(e){throw updateRateLimitLock(s,!1),e}e=await e.json(),logger.info("Claude",e);var i=e.usage;r.count++,i&&(r.input+=i.input_tokens,r.output+=i.output_tokens);let a=e.content;if(!(a=a&&a[0]))throw a="",i=e.error?.message||"Error Occur!",logger.error("Claude",i),new Error(i);if(a=convertClaudeChinese(a.text),n.push(a),"max_tokens"!==(e.stop_reason||"").toLowerCase())break;f?(t.push(["ai",a]),t.push(["human",PromptLib.continueOutput]),f=!1):t[t.length-2][1]=n.join(" "),Object.assign(u,assembleConversation(t)),o.body=JSON.stringify(u)}return e=Date.now()-e,logger.info("Claude","Timespent: "+e/1e3+"s; Input: "+r.input+"; Output: "+r.output),recordAIUsage(s,"Claude",r),n.join(" ")};