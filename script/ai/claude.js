globalThis.AI=globalThis.AI||{},globalThis.AI.Claude={};let DefaultChatModel=AI2Model.claude[0],convertClaudeChinese=e=>(e=e&&e.trim())?e=(e=(e=e.split(/\r*\n\r*/)).map(e=>e=(e=(e=(e=(e=e.replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*[\(\)]|[\(\)]\s*[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/gi,e=>e=e.replace(/\s*([\(\)])\s*/g,(e,a)=>","===a?"，":":"===a?"：":";"===a?"；":"?"===a?"？":"!"===a?"！":"("===a?"（":")"===a?"）":a))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*[,:;\?\!]/gi,e=>e=e.replace(/\s*([,:;\?\!\(\)])\s*/g,(e,a)=>","===a?"，":":"===a?"：":";"===a?"；":"?"===a?"？":"!"===a?"！":"("===a?"（":")"===a?"）":a))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*\.+/gi,e=>e=e.replace(/\s*(\.+)\s*/g,(e,a)=>1===a.length?"。":"……"))).replace(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]\s*\-{2,}|\-{2,}\s*[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/gi,e=>e=e.replace(/\s*(\-{2,})\s*/g,(e,a)=>"——"))).replace(/[\(（]\s*([\w\d_\-\+\*\\\/:;,\.\?\!@%#\^\&\(\)=]+)\s*[\)）]/g,(e,a)=>"("+a+")"))).join("\n"):"";AI.Claude.chat=async(e,a=DefaultChatModel,u={})=>{var t=[],s=Object.assign({},ModelDefaultConfig.Claude.chat,(ModelDefaultConfig[a]||{}).chat||{},u),u=(s.model=a,s.messages=t,Object.assign({},ModelDefaultConfig.Claude.header,(ModelDefaultConfig[a]||{}).header||{})),a=(u["x-api-key"]=myInfo.apiKey.claude,{method:"POST",headers:u});e.forEach(e=>{"system"===e[0]?s.system=e[1]:"human"===e[0]?t.push({role:"user",content:e[1]}):"ai"===e[0]&&t.push({role:"assistant",content:e[1]})}),"assistant"!==t[t.length-1].role&&t.push({role:"assistant",content:""}),a.body=JSON.stringify(s);u=Date.now();try{f=await waitUntil(fetch("https://api.anthropic.com/v1/messages",a))}catch(e){throw e}u=Date.now()-u,logger.info("Claude","Chat: "+u/1e3+"s");var f,e=f=await f.json(),a=f.usage,u=(a&&(logger.info("Claude",`Usage: Input ${a.input_tokens}, Output: `+a.output_tokens),AIUsage.request++,AIUsage.input+=a.input_tokens,AIUsage.output+=a.output_tokens),f.content);if(u=u&&u[0])return u=convertClaudeChinese(u.text);throw u="",a=e.error?.message||"Error Occur!",logger.error("Claude",a),new Error(a)};