globalThis.AI=globalThis.AI||{},globalThis.AI.OpenAI={},globalThis.AI.MoonShot={},globalThis.AI.DeepSeek={},globalThis.AI.GLM={};let DefaultOpenAIChatModel=AI2Model.openai[0],DefaultOpenAIDrawModel="dall-e-3",DefaultMoonShotChatModel=AI2Model.moonshot[0],DefaultDeepSeekChatModel=AI2Model.deepseek[0],DefaultGLMChatModel=AI2Model.glm[0],DefaultGLMDrawModel="cogview-3-plus",assembleMessages=(e,s=!0,n=!0)=>{var i=[];return e.forEach(e=>{var t,a=e[1],o=null,e=("system"===e[0]?n?t="system":(t="user",a=e[1]+"\n\nKeep in mind the above requirements and instructions.",o={role:"assistant",content:s?[{type:"text",text:"I remembered it."}]:"I remembered it."}):"human"===e[0]?t="user":"ai"===e[0]&&(t="assistant"),s?[{type:"text",text:a}]:a);i.push({role:t,content:e}),o&&i.push(o)}),i},assembleDataPack=(e,t,a)=>{var o=Model2AI[e],s=Object.assign({},ModelDefaultConfig[o].header,(ModelDefaultConfig[e]||{}).header||{}),o=Object.assign({},ModelDefaultConfig[o].chat,(ModelDefaultConfig[e]||{}).chat||{},t||{});return s.Authorization="Bearer "+a,o.model=e,[s,o]},scoreContent=e=>{var t=0;return e=(e=(e=e.replace(/[a-zA-Z]+/g,()=>(t+=2.5," "))).replace(/[\d\.]+/g,()=>(t+=1," "))).replace(/[\u4e00-\u9fa5]/g,()=>(t+=1," ")),Math.floor(t)};AI.OpenAI.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai}},a=Date.now();try{e=await waitUntil(fetch("https://api.openai.com/v1/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("OpenAI","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.OpenAI.chat=async(s,n=DefaultOpenAIChatModel,e={})=>{for(var i="o1-preview"===n||"o1-mini"===n,r=assembleMessages(s,!0,!i),[e,p]=assembleDataPack(n,e,myInfo.apiKey.openai),u=(p.messages=r,i&&(p.max_completion_tokens=p.max_tokens,delete p.max_tokens),{method:"POST",headers:e,body:JSON.stringify(p)}),l=[],h={input:0,output:0},c=!0,e=Date.now();;){let t;try{await requestRateLimitLock(n),updateRateLimitLock(n,!0),t=await waitUntil(fetch("https://api.openai.com/v1/chat/completions",u)),updateRateLimitLock(n,!1)}catch(e){throw updateRateLimitLock(n,!1),e}let e=await t.text();try{e.match(/^\s*b'\{[\w\W]+\}'\s*$/)&&(e=e.replace(/^\s*b'|'\s*$/g,"").replace(/\\n/g,"\n")),t=JSON.parse(e)}catch(e){logger.error("OpenAI",e),t={}}logger.info("OpenAI",t);let a=t.usage,o=t.choices;a&&(h.input+=a.prompt_tokens,h.output+=a.completion_tokens);var m,g=(o=o&&o[0]).finish_reason||"";if(!(o=o&&o.message?.content))throw o="",m=t.error?.message||"Error Occur!",logger.error("OpenAI",m),new Error(m);if(o=o.trim(),l.push(o),"length"!==g.toLowerCase())break;c?(s.push(["ai",o]),s.push(["human",PromptLib.continueOutput]),c=!1):s[s.length-2][1]=l.join(" "),r=assembleMessages(s,!0,!i),p.messages=r,u.body=JSON.stringify(p)}return e=Date.now()-e,logger.info("OpenAI","Timespent: "+e/1e3+"s; Input: "+h.input+"; Output: "+h.output),AIUsage.request++,AIUsage.input+=h.input,AIUsage.output+=h.output,l.join(" ")},AI.OpenAI.draw=async(e,t=DefaultOpenAIDrawModel,a={})=>{t={model:t,prompt:e,n:a.n||1,quality:a.quality||"standard",size:a.size||"1024x1024",style:a.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai},body:JSON.stringify(t)},a=Date.now();try{o=await waitUntil(fetch("https://api.openai.com/v1/images/generations",e))}catch(e){throw e}a=Date.now()-a,logger.info("OpenAI","Chat: "+a/1e3+"s");var o,t=o=await o.json(),e=o.data;if(e)return e=e.map(e=>e.url);throw a=t.error?.message||"Error Occur!",logger.error("OpenAI",a),new Error(a)},AI.MoonShot.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.moonshot}},a=Date.now();try{e=await waitUntil(fetch("https://api.moonshot.cn/v1/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("MoonShot","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.MoonShot.chat=async(o,s=DefaultMoonShotChatModel,e={})=>{for(var n=assembleMessages(o,!1),[e,i]=assembleDataPack(s,e,myInfo.apiKey.moonshot),r=(i.messages=n,{method:"POST",headers:e,body:JSON.stringify(i)}),p=[],u={input:0,output:0},l=!0,e=Date.now();;){let e;try{await requestRateLimitLock(s),updateRateLimitLock(s,!0),e=await waitUntil(fetch("https://api.moonshot.cn/v1/chat/completions",r)),updateRateLimitLock(s,!1)}catch(e){throw updateRateLimitLock(s,!1),e}e=await e.json(),logger.info("MoonShot",e);let t=e.usage,a=e.choices;t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var h,c=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",h=e.error?.message||"Error Occur!",logger.error("MoonShot",h),new Error(h);if(a=a.trim(),p.push(a),"length"!==c.toLowerCase())break;l?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),l=!1):o[o.length-2][1]=p.join(" "),n=assembleMessages(o,!1),i.messages=n,r.body=JSON.stringify(i)}return e=Date.now()-e,logger.info("MoonShot","Timespent: "+e/1e3+"s; Input: "+u.input+"; Output: "+u.output),AIUsage.request++,AIUsage.input+=u.input,AIUsage.output+=u.output,p.join(" ")},AI.DeepSeek.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+myInfo.apiKey.deepseek}},a=Date.now();try{e=await waitUntil(fetch("https://api.deepseek.com/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("DeepSeek","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.DeepSeek.chat=async(o,s=DefaultDeepSeekChatModel,e={})=>{for(var n=assembleMessages(o,!1),[e,i]=assembleDataPack(s,e,myInfo.apiKey.deepseek),r=(i.messages=n,{method:"POST",headers:e,body:JSON.stringify(i)}),p=[],u={input:0,output:0},l=!0,e=Date.now();;){let e;try{await requestRateLimitLock(s),updateRateLimitLock(s,!0),e=await waitUntil(fetch("https://api.deepseek.com/beta/chat/completions",r)),updateRateLimitLock(s,!1)}catch(e){throw updateRateLimitLock(s,!1),e}e=await e.json(),logger.info("DeepSeek",e);let t=e.usage,a=e.choices;t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var h,c=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",h=e.error?.message||"Error Occur!",logger.error("DeepSeek",h),new Error(h);if(a=a.trim(),p.push(a),"length"!==c.toLowerCase())break;l?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),l=!1):o[o.length-2][1]=p.join(" "),n=assembleMessages(o,!1),i.messages=n,r.body=JSON.stringify(i)}return e=Date.now()-e,logger.info("DeepSeek","Timespent: "+e/1e3+"s; Input: "+u.input+"; Output: "+u.output),AIUsage.request++,AIUsage.input+=u.input,AIUsage.output+=u.output,p.join(" ")},AI.GLM.chat=async(o,s=DefaultGLMChatModel,e={})=>{for(var n=assembleMessages(o,!1),t=JWSgenerate(myInfo.apiKey.glm,31536e3),[e,i]=assembleDataPack(s,e,t),r=(i.messages=n,{method:"POST",headers:e,body:JSON.stringify(i)}),p=[],u={input:0,output:0},l=!0,t=Date.now();;){let e;try{await requestRateLimitLock(s),updateRateLimitLock(s,!0),e=await waitUntil(fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions",r)),updateRateLimitLock(s,!1)}catch(e){throw updateRateLimitLock(s,!1),e}e=await e.json(),logger.info("GLM",e);let t=e.usage,a=e.choices;t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var h,c=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",h=e.error?.message||"Error Occur!",logger.error("GLM",h),new Error(h);if(a=a.trim(),p.push(a),"length"!==c.toLowerCase())break;l?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),l=!1):o[o.length-2][1]=p.join(" "),n=assembleMessages(o,!1),i.messages=n,r.body=JSON.stringify(i)}return t=Date.now()-t,logger.info("GLM","Timespent: "+t/1e3+"s; Input: "+u.input+"; Output: "+u.output),AIUsage.request++,AIUsage.input+=u.input,AIUsage.output+=u.output,p.join(" ")},AI.GLM.draw=async(e,t=DefaultGLMDrawModel,a={})=>{t={model:t,prompt:e,n:a.n||1,quality:a.quality||"standard",size:a.size||"1024x1024",style:a.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+JWSgenerate(myInfo.apiKey.glm,31536e3)},body:JSON.stringify(t)},a=Date.now();try{o=await waitUntil(fetch("https://open.bigmodel.cn/api/paas/v4/images/generations",e))}catch(e){throw e}a=Date.now()-a,logger.info("GLM","Chat: "+a/1e3+"s");var o,t=o=await o.json(),e=o.data;if(e)return e=e.map(e=>e.url);throw a=t.error?.message||"Error Occur!",logger.error("GLM",a),new Error(a)};