globalThis.AI=globalThis.AI||{},globalThis.AI.OpenAI={},globalThis.AI.MoonShot={},globalThis.AI.DeepSeek={},globalThis.AI.GLM={},globalThis.AI.MiniMax={};let DefaultOpenAIChatModel=AI2Model.openai[0],DefaultOpenAIDrawModel="dall-e-3",DefaultMoonShotChatModel=AI2Model.moonshot[0],DefaultDeepSeekChatModel=AI2Model.deepseek[0],DefaultGLMChatModel=AI2Model.glm[0],DefaultGLMDrawModel="cogview-3-plus",DefaultMiniMaxChatModel=AI2Model.minimax[0],assembleMessages=(e,n=!0,i=!0)=>{var s=[];return e.forEach(e=>{var t,a=e[1],o=null,e=("system"===e[0]?i?t="system":(t="user",a=e[1]+"\n\nKeep in mind the above requirements and instructions.",o={role:"assistant",content:n?[{type:"text",text:"I remembered it."}]:"I remembered it."}):"human"===e[0]?t="user":"ai"===e[0]&&(t="assistant"),n?[{type:"text",text:a}]:a);s.push({role:t,content:e}),o&&s.push(o)}),s},assembleDataPack=(e,t,a)=>{var o=Model2AI[e],n=Object.assign({},ModelDefaultConfig[o].header,(ModelDefaultConfig[e]||{}).header||{}),o=Object.assign({},ModelDefaultConfig[o].chat,(ModelDefaultConfig[e]||{}).chat||{},t||{});return n.Authorization="Bearer "+a,o.model=e,[n,o]},scoreContent=e=>{var t=0;return e=(e=(e=e.replace(/[a-zA-Z]+/g,()=>(t+=2.5," "))).replace(/[\d\.]+/g,()=>(t+=1," "))).replace(/[\u4e00-\u9fa5]/g,()=>(t+=1," ")),Math.floor(t)};AI.OpenAI.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai}},a=Date.now();try{e=await waitUntil(fetch("https://api.openai.com/v1/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("OpenAI","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.OpenAI.chat=async(n,i=DefaultOpenAIChatModel,e={})=>{for(var s="o1-preview"===i||"o1-mini"===i,r=assembleMessages(n,!0,!s),[e,p]=assembleDataPack(i,e,myInfo.apiKey.openai),u=(p.messages=r,s&&(p.max_completion_tokens=p.max_tokens,delete p.max_tokens),{method:"POST",headers:e,body:JSON.stringify(p)}),l=[],c={count:0,input:0,output:0},h=!0,e=Date.now();;){let t;try{await requestRateLimitLock(i),updateRateLimitLock(i,!0),t=await waitUntil(fetch("https://api.openai.com/v1/chat/completions",u)),updateRateLimitLock(i,!1)}catch(e){throw updateRateLimitLock(i,!1),e}let e=await t.text();try{e.match(/^\s*b'\{[\w\W]+\}'\s*$/)&&(e=e.replace(/^\s*b'|'\s*$/g,"").replace(/\\n/g,"\n")),t=JSON.parse(e)}catch(e){logger.error("OpenAI",e),t={}}logger.info("OpenAI",t);let a=t.usage,o=t.choices;c.count++,a&&(c.input+=a.prompt_tokens,c.output+=a.completion_tokens);var m,g=(o=o&&o[0]).finish_reason||"";if(!(o=o&&o.message?.content))throw o="",m=t.error?.message||"Error Occur!",logger.error("OpenAI",m),new Error(m);if(o=o.trim(),l.push(o),"length"!==g.toLowerCase())break;h?(n.push(["ai",o]),n.push(["human",PromptLib.continueOutput]),h=!1):n[n.length-2][1]=l.join(" "),r=assembleMessages(n,!0,!s),p.messages=r,u.body=JSON.stringify(p)}return e=Date.now()-e,logger.info("OpenAI","Timespent: "+e/1e3+"s; Input: "+c.input+"; Output: "+c.output),recordAIUsage(i,"OpenAI",c),l.join(" ")},AI.OpenAI.draw=async(e,t=DefaultOpenAIDrawModel,a={})=>{t={model:t,prompt:e,n:a.n||1,quality:a.quality||"standard",size:a.size||"1024x1024",style:a.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai},body:JSON.stringify(t)},a=Date.now();try{o=await waitUntil(fetch("https://api.openai.com/v1/images/generations",e))}catch(e){throw e}a=Date.now()-a,logger.info("OpenAI","Chat: "+a/1e3+"s");var o,t=o=await o.json(),e=o.data;if(e)return e=e.map(e=>e.url);throw a=t.error?.message||"Error Occur!",logger.error("OpenAI",a),new Error(a)},AI.MoonShot.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.moonshot}},a=Date.now();try{e=await waitUntil(fetch("https://api.moonshot.cn/v1/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("MoonShot","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.MoonShot.chat=async(o,n=DefaultMoonShotChatModel,e={})=>{for(var i=assembleMessages(o,!1),[e,s]=assembleDataPack(n,e,myInfo.apiKey.moonshot),r=(s.messages=i,{method:"POST",headers:e,body:JSON.stringify(s)}),p=[],u={count:0,input:0,output:0},l=!0,e=Date.now();;){let e;try{await requestRateLimitLock(n),updateRateLimitLock(n,!0),e=await waitUntil(fetch("https://api.moonshot.cn/v1/chat/completions",r)),updateRateLimitLock(n,!1)}catch(e){throw updateRateLimitLock(n,!1),e}e=await e.json(),logger.info("MoonShot",e);let t=e.usage,a=e.choices;u.count++,t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var c,h=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",c=e.error?.message||"Error Occur!",logger.error("MoonShot",c),new Error(c);if(a=a.trim(),p.push(a),"length"!==h.toLowerCase())break;l?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),l=!1):o[o.length-2][1]=p.join(" "),i=assembleMessages(o,!1),s.messages=i,r.body=JSON.stringify(s)}return e=Date.now()-e,logger.info("MoonShot","Timespent: "+e/1e3+"s; Input: "+u.input+"; Output: "+u.output),recordAIUsage(n,"MoonShot",u),p.join(" ")},AI.DeepSeek.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+myInfo.apiKey.deepseek}},a=Date.now();try{e=await waitUntil(fetch("https://api.deepseek.com/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("DeepSeek","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.DeepSeek.chat=async(o,n=DefaultDeepSeekChatModel,e={})=>{for(var i=assembleMessages(o,!1),[e,s]=assembleDataPack(n,e,myInfo.apiKey.deepseek),r=(s.messages=i,{method:"POST",headers:e,body:JSON.stringify(s)}),p=[],u={count:0,input:0,output:0},l=!0,e=Date.now();;){let e;try{await requestRateLimitLock(n),updateRateLimitLock(n,!0),e=await waitUntil(fetch("https://api.deepseek.com/beta/chat/completions",r)),updateRateLimitLock(n,!1)}catch(e){throw updateRateLimitLock(n,!1),e}e=await e.json(),logger.info("DeepSeek",e);let t=e.usage,a=e.choices;u.count++,t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var c,h=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",c=e.error?.message||"Error Occur!",logger.error("DeepSeek",c),new Error(c);if(a=a.trim(),p.push(a),"length"!==h.toLowerCase())break;l?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),l=!1):o[o.length-2][1]=p.join(" "),i=assembleMessages(o,!1),s.messages=i,r.body=JSON.stringify(s)}return e=Date.now()-e,logger.info("DeepSeek","Timespent: "+e/1e3+"s; Input: "+u.input+"; Output: "+u.output),recordAIUsage(n,"DeepSeek",u),p.join(" ")},AI.GLM.chat=async(o,n=DefaultGLMChatModel,e={})=>{for(var i=assembleMessages(o,!1),t=JWSgenerate(myInfo.apiKey.glm,31536e3),[e,s]=assembleDataPack(n,e,t),r=(s.messages=i,{method:"POST",headers:e,body:JSON.stringify(s)}),p=[],u={count:0,input:0,output:0},l=!0,t=Date.now();;){let e;try{await requestRateLimitLock(n),updateRateLimitLock(n,!0),e=await waitUntil(fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions",r)),updateRateLimitLock(n,!1)}catch(e){throw updateRateLimitLock(n,!1),e}e=await e.json(),logger.info("GLM",e);let t=e.usage,a=e.choices;u.count++,t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var c,h=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",c=e.error?.message||"Error Occur!",logger.error("GLM",c),new Error(c);if(a=a.trim(),p.push(a),"length"!==h.toLowerCase())break;l?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),l=!1):o[o.length-2][1]=p.join(" "),i=assembleMessages(o,!1),s.messages=i,r.body=JSON.stringify(s)}return t=Date.now()-t,logger.info("GLM","Timespent: "+t/1e3+"s; Input: "+u.input+"; Output: "+u.output),recordAIUsage(n,"GLM",u),p.join(" ")},AI.GLM.draw=async(e,t=DefaultGLMDrawModel,a={})=>{t={model:t,prompt:e,n:a.n||1,quality:a.quality||"standard",size:a.size||"1024x1024",style:a.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+JWSgenerate(myInfo.apiKey.glm,31536e3)},body:JSON.stringify(t)},a=Date.now();try{o=await waitUntil(fetch("https://open.bigmodel.cn/api/paas/v4/images/generations",e))}catch(e){throw e}a=Date.now()-a,logger.info("GLM","Chat: "+a/1e3+"s");var o,t=o=await o.json(),e=o.data;if(e)return e=e.map(e=>e.url);throw a=t.error?.message||"Error Occur!",logger.error("GLM",a),new Error(a)},AI.MiniMax.chat=async(o,n=DefaultMiniMaxChatModel,e={})=>{for(var i=assembleMessages(o,!1),[e,s]=assembleDataPack(n,e,myInfo.apiKey.minimax),r=(s.messages=i,{method:"POST",headers:e,body:JSON.stringify(s)}),p=[],u={count:0,input:0,output:0},l=!0,e=Date.now();;){let e;try{await requestRateLimitLock(n),updateRateLimitLock(n,!0),e=await waitUntil(fetch("https://api.minimax.chat/v1/text/chatcompletion_v2",r)),updateRateLimitLock(n,!1)}catch(e){throw updateRateLimitLock(n,!1),e}e=await e.json(),logger.info("MiniMax",e);let t=e.usage,a=e.choices;u.count++,t&&(u.output+=t.total_tokens);var c,h=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",c=e.error?.message||"Error Occur!",logger.error("MiniMax",c),new Error(c);if(a=a.trim(),p.push(a),"length"!==h.toLowerCase())break;l?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),l=!1):o[o.length-2][1]=p.join(" "),i=assembleMessages(o,!1),s.messages=i,r.body=JSON.stringify(s)}return e=Date.now()-e,logger.info("MiniMax","Timespent: "+e/1e3+"s; Input: "+u.input+"; Output: "+u.output),recordAIUsage(n,"MiniMax",u),p.join(" ")};