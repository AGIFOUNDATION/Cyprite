globalThis.AI=globalThis.AI||{},globalThis.AI.OpenAI={},globalThis.AI.MoonShot={},globalThis.AI.DeepSeek={},globalThis.AI.GLM={},globalThis.AI.MiniMax={};let DefaultOpenAIChatModel=AI2Model.openai[0],DefaultOpenAIDrawModel="dall-e-3",DefaultMoonShotChatModel=AI2Model.moonshot[0],DefaultDeepSeekChatModel=AI2Model.deepseek[0],DefaultGLMChatModel=AI2Model.glm[0],DefaultGLMDrawModel="cogview-3-plus",DefaultMiniMaxChatModel=AI2Model.minimax[0],assembleMessages=(e,i=!0,n=!0)=>{var s=[];return e.forEach(e=>{var t,a=e[1],o=null,e=("system"===e[0]?n?t="system":(t="user",a=e[1]+"\n\nKeep in mind the above requirements and instructions.",o={role:"assistant",content:i?[{type:"text",text:"I remembered it."}]:"I remembered it."}):"human"===e[0]?t="user":"ai"===e[0]&&(t="assistant"),i?[{type:"text",text:a}]:a);s.push({role:t,content:e}),o&&s.push(o)}),s},assembleDataPack=(e,t,a)=>{var o=Model2AI[e],i=Object.assign({},ModelDefaultConfig[o].header,(ModelDefaultConfig[e]||{}).header||{}),o=Object.assign({},ModelDefaultConfig[o].chat,(ModelDefaultConfig[e]||{}).chat||{},t||{});return i.Authorization="Bearer "+a,o.model=e,[i,o]},scoreContent=e=>{var t=0;return e=(e=(e=e.replace(/[a-zA-Z]+/g,()=>(t+=2.5," "))).replace(/[\d\.]+/g,()=>(t+=1," "))).replace(/[\u4e00-\u9fa5]/g,()=>(t+=1," ")),Math.floor(t)};AI.OpenAI.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai}},a=Date.now();try{e=await waitUntil(fetchWithCheck("https://api.openai.com/v1/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("OpenAI","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.OpenAI.chat=async(i,n=DefaultOpenAIChatModel,e={})=>{for(var s="o1-preview"===n||"o1-mini"===n,r=assembleMessages(i,!0,!s),[e,p]=assembleDataPack(n,e,myInfo.apiKey.openai),u=(p.messages=r,s&&(p.max_completion_tokens=p.max_tokens,delete p.max_tokens),{method:"POST",headers:e,body:JSON.stringify(p)}),h=[],l={count:0,input:0,output:0},c=!0,e=Date.now(),m=0;;){let t;try{await requestRateLimitLock(n),updateRateLimitLock(n,!0),t=await waitUntil(fetchWithCheck("https://api.openai.com/v1/chat/completions",u)),updateRateLimitLock(n,!1)}catch(e){throw updateRateLimitLock(n,!1),e}let e=await t.text();try{e.match(/^\s*b'\{[\w\W]+\}'\s*$/)&&(e=e.replace(/^\s*b'|'\s*$/g,"").replace(/\\n/g,"\n")),t=JSON.parse(e)}catch(e){logger.error("OpenAI",e),t={}}logger.info("OpenAI",t);let a=t.usage,o=t.choices;l.count++,a&&(l.input+=a.prompt_tokens,l.output+=a.completion_tokens);var g,d=(o=o&&o[0]).finish_reason||"";if(!(o=o&&o.message?.content))throw o="",g=t.error?.message||"Error Occur!",logger.error("OpenAI",g),new Error(g);if(o=o.trim(),h.push(o),"length"!==d.toLowerCase())break;if(c?(i.push(["ai",o]),i.push(["human",PromptLib.continueOutput]),c=!1):i[i.length-2][1]=h.join(" "),r=assembleMessages(i,!0,!s),p.messages=r,u.body=JSON.stringify(p),++m>=ModelContinueRequestLoopLimit)break}return e=Date.now()-e,logger.info("OpenAI","Timespent: "+e/1e3+"s; Input: "+l.input+"; Output: "+l.output),recordAIUsage(n,"OpenAI",l),h.join(" ")},AI.OpenAI.draw=async(e,t=DefaultOpenAIDrawModel,a={})=>{t={model:t,prompt:e,n:a.n||1,quality:a.quality||"standard",size:a.size||"1024x1024",style:a.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai},body:JSON.stringify(t)},a=Date.now();try{o=await waitUntil(fetchWithCheck("https://api.openai.com/v1/images/generations",e))}catch(e){throw e}a=Date.now()-a,logger.info("OpenAI","Chat: "+a/1e3+"s");var o,t=o=await o.json(),e=o.data;if(e)return e=e.map(e=>e.url);throw a=t.error?.message||"Error Occur!",logger.error("OpenAI",a),new Error(a)},AI.MoonShot.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.moonshot}},a=Date.now();try{e=await waitUntil(fetchWithCheck("https://api.moonshot.cn/v1/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("MoonShot","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.MoonShot.chat=async(o,i=DefaultMoonShotChatModel,e={})=>{for(var n=assembleMessages(o,!1),[e,s]=assembleDataPack(i,e,myInfo.apiKey.moonshot),r=(s.messages=n,{method:"POST",headers:e,body:JSON.stringify(s)}),p=[],u={count:0,input:0,output:0},h=!0,e=Date.now(),l=0;;){let e;try{await requestRateLimitLock(i),updateRateLimitLock(i,!0),e=await waitUntil(fetchWithCheck("https://api.moonshot.cn/v1/chat/completions",r)),updateRateLimitLock(i,!1)}catch(e){throw updateRateLimitLock(i,!1),e}e=await e.json(),logger.info("MoonShot",e);let t=e.usage,a=e.choices;u.count++,t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var c,m=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",c=e.error?.message||"Error Occur!",logger.error("MoonShot",c),new Error(c);if(a=a.trim(),p.push(a),"length"!==m.toLowerCase())break;if(h?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),h=!1):o[o.length-2][1]=p.join(" "),n=assembleMessages(o,!1),s.messages=n,r.body=JSON.stringify(s),++l>=ModelContinueRequestLoopLimit)break}return e=Date.now()-e,logger.info("MoonShot","Timespent: "+e/1e3+"s; Input: "+u.input+"; Output: "+u.output),recordAIUsage(i,"MoonShot",u),p.join(" ")},AI.DeepSeek.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+myInfo.apiKey.deepseek}},a=Date.now();try{e=await waitUntil(fetchWithCheck("https://api.deepseek.com/models",t))}catch(e){throw e}return a=Date.now()-a,logger.info("DeepSeek","List: "+a/1e3+"s"),e=(e=await e.json()).data||e},AI.DeepSeek.chat=async(o,i=DefaultDeepSeekChatModel,e={})=>{for(var n=assembleMessages(o,!1),[e,s]=assembleDataPack(i,e,myInfo.apiKey.deepseek),r=(s.messages=n,{method:"POST",headers:e,body:JSON.stringify(s)}),p=[],u={count:0,input:0,output:0},h=!0,e=Date.now(),l=0;;){let e;try{await requestRateLimitLock(i),updateRateLimitLock(i,!0),e=await waitUntil(fetchWithCheck("https://api.deepseek.com/beta/chat/completions",r)),updateRateLimitLock(i,!1)}catch(e){throw updateRateLimitLock(i,!1),e}e=await e.json(),logger.info("DeepSeek",e);let t=e.usage,a=e.choices;u.count++,t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var c,m=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",c=e.error?.message||"Error Occur!",logger.error("DeepSeek",c),new Error(c);if(a=a.trim(),p.push(a),"length"!==m.toLowerCase())break;if(h?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),h=!1):o[o.length-2][1]=p.join(" "),n=assembleMessages(o,!1),s.messages=n,r.body=JSON.stringify(s),++l>=ModelContinueRequestLoopLimit)break}return e=Date.now()-e,logger.info("DeepSeek","Timespent: "+e/1e3+"s; Input: "+u.input+"; Output: "+u.output),recordAIUsage(i,"DeepSeek",u),p.join(" ")},AI.GLM.chat=async(o,i=DefaultGLMChatModel,e={})=>{for(var n=assembleMessages(o,!1),t=JWSgenerate(myInfo.apiKey.glm,31536e3),[e,s]=assembleDataPack(i,e,t),r=(s.messages=n,{method:"POST",headers:e,body:JSON.stringify(s)}),p=[],u={count:0,input:0,output:0},h=!0,t=Date.now(),l=0;;){let e;try{await requestRateLimitLock(i),updateRateLimitLock(i,!0),e=await waitUntil(fetchWithCheck("https://open.bigmodel.cn/api/paas/v4/chat/completions",r)),updateRateLimitLock(i,!1)}catch(e){throw updateRateLimitLock(i,!1),e}e=await e.json(),logger.info("GLM",e);let t=e.usage,a=e.choices;u.count++,t&&(u.input+=t.prompt_tokens,u.output+=t.completion_tokens);var c,m=(a=a&&a[0]).finish_reason||"";if(!(a=a&&a.message?.content))throw a="",c=e.error?.message||"Error Occur!",logger.error("GLM",c),new Error(c);if(a=a.trim(),p.push(a),"length"!==m.toLowerCase())break;if(h?(o.push(["ai",a]),o.push(["human",PromptLib.continueOutput]),h=!1):o[o.length-2][1]=p.join(" "),n=assembleMessages(o,!1),s.messages=n,r.body=JSON.stringify(s),++l>=ModelContinueRequestLoopLimit)break}return t=Date.now()-t,logger.info("GLM","Timespent: "+t/1e3+"s; Input: "+u.input+"; Output: "+u.output),recordAIUsage(i,"GLM",u),p.join(" ")},AI.GLM.draw=async(e,t=DefaultGLMDrawModel,a={})=>{t={model:t,prompt:e,n:a.n||1,quality:a.quality||"standard",size:a.size||"1024x1024",style:a.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+JWSgenerate(myInfo.apiKey.glm,31536e3)},body:JSON.stringify(t)},a=Date.now();try{o=await waitUntil(fetchWithCheck("https://open.bigmodel.cn/api/paas/v4/images/generations",e))}catch(e){throw e}a=Date.now()-a,logger.info("GLM","Chat: "+a/1e3+"s");var o,t=o=await o.json(),e=o.data;if(e)return e=e.map(e=>e.url);throw a=t.error?.message||"Error Occur!",logger.error("GLM",a),new Error(a)},AI.MiniMax.chat=async(i,n=DefaultMiniMaxChatModel,e={})=>{for(var s,r=assembleMessages(i,!1),[e,p]=assembleDataPack(n,e,myInfo.apiKey.minimax),u=(p.messages=r,{method:"POST",headers:e,body:JSON.stringify(p)}),h=[],l={count:0,input:0,output:0},c=!0,e=Date.now(),m=0;;){let e;try{await requestRateLimitLock(n),updateRateLimitLock(n,!0),e=await waitUntil(fetchWithCheck("https://api.minimax.chat/v1/text/chatcompletion_v2",u)),updateRateLimitLock(n,!1)}catch(e){throw updateRateLimitLock(n,!1),e}e=await e.json(),logger.info("MiniMax",e);let t=e.usage,a=e.choices,o=(l.count++,t&&(l.output+=t.total_tokens),"");if((a=a&&a[0])&&(a=a.message?.content,o=a.finish_reason||""),!a)throw a="",s=e.base_resp?.status_msg||"Error Occur!",logger.error("MiniMax",s),new Error(s);if(a=a.trim(),h.push(a),"length"!==o.toLowerCase())break;if(c?(i.push(["ai",a]),i.push(["human",PromptLib.continueOutput]),c=!1):i[i.length-2][1]=h.join(" "),r=assembleMessages(i,!1),p.messages=r,u.body=JSON.stringify(p),++m>=ModelContinueRequestLoopLimit)break}return e=Date.now()-e,logger.info("MiniMax","Timespent: "+e/1e3+"s; Input: "+l.input+"; Output: "+l.output),recordAIUsage(n,"MiniMax",l),h.join(" ")};