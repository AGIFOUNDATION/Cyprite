globalThis.AI=globalThis.AI||{},globalThis.AI.OpenAI={},globalThis.AI.MoonShot={},globalThis.AI.DeepSeek={},globalThis.AI.GLM={};let DefaultOpenAIChatModel=AI2Model.openai[0],DefaultOpenAIDrawModel="dall-e-3",DefaultMoonShotChatModel=AI2Model.moonshot[0],DefaultDeepSeekChatModel=AI2Model.deepseek[0],assembleMessages=(e,r=!0,n=!0)=>{var s=[];return e.forEach(e=>{var t,o=e[1],a=null,e=("system"===e[0]?n?t="system":(t="user",o=e[1]+"\n\nKeep in mind the above requirements and instructions.",a={role:"assistant",content:r?[{type:"text",text:"I remembered it."}]:"I remembered it."}):"human"===e[0]?t="user":"ai"===e[0]&&(t="assistant"),r?[{type:"text",text:o}]:o);s.push({role:t,content:e}),a&&s.push(a)}),s},assembleDataPack=(e,t,o,a)=>{var r=Model2AI[e],n=Object.assign({},ModelDefaultConfig[r].header,(ModelDefaultConfig[e]||{}).header||{}),r=Object.assign({},ModelDefaultConfig[r].chat,(ModelDefaultConfig[e]||{}).chat||{},o||{});return n.Authorization="Bearer "+a,r.model=e,r.messages=t,[n,r]},scoreContent=e=>{var t=0;return e=(e=(e=e.replace(/[a-zA-Z]+/g,()=>(t+=2.5," "))).replace(/[\d\.]+/g,()=>(t+=1," "))).replace(/[\u4e00-\u9fa5]/g,()=>(t+=1," ")),Math.floor(t)};AI.OpenAI.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai}},o=Date.now();try{e=await waitUntil(fetch("https://api.openai.com/v1/models",t))}catch(e){throw e}return o=Date.now()-o,logger.info("OpenAI","List: "+o/1e3+"s"),e=(e=await e.json()).data||e},AI.OpenAI.chat=async(e,t=DefaultOpenAIChatModel,o={})=>{var a,r="o1-preview"===t||"o1-mini"===t,e=assembleMessages(e,!0,!r),[t,e]=assembleDataPack(t,e,o,myInfo.apiKey.openai),o=(r&&(e.max_completion_tokens=e.max_tokens,delete e.max_tokens),{method:"POST",headers:t,body:JSON.stringify(e)}),r=Date.now();try{a=await waitUntil(fetch("https://api.openai.com/v1/chat/completions",o))}catch(e){throw e}r=Date.now()-r,logger.info("OpenAI","Chat: "+r/1e3+"s");t=await a.text();logger.info("OpenAI","Got Reply",t);try{t.match(/^\s*b'\{[\w\W]+\}'\s*$/)&&(t=t.replace(/^\s*b'\{/,"{").replace(/\}'\s*$/,"}")),a=JSON.parse(t)}catch(e){logger.error("OpenAI",e),a={}}e=a,o=a.usage,o&&(logger.info("OpenAI",`Usage: Input ${o.prompt_tokens}, Output: `+o.completion_tokens),AIUsage.request++,AIUsage.input+=o.prompt_tokens,AIUsage.output+=o.completion_tokens),r=a.choices;if(r=(r=r&&r[0])&&r.message?.content)return r=r.trim();throw r="",t=e.error?.message||"Error Occur!",logger.error("OpenAI",t),new Error(t)},AI.OpenAI.draw=async(e,t=DefaultOpenAIDrawModel,o={})=>{t={model:t,prompt:e,n:o.n||1,quality:o.quality||"standard",size:o.size||"1024x1024",style:o.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.openai},body:JSON.stringify(t)},o=Date.now();try{a=await waitUntil(fetch("https://api.openai.com/v1/images/generations",e))}catch(e){throw e}o=Date.now()-o,logger.info("OpenAI","Chat: "+o/1e3+"s");var a,t=a=await a.json(),e=a.data;if(e)return e=e.map(e=>e.url);throw o=t.error?.message||"Error Occur!",logger.error("OpenAI",o),new Error(o)},AI.MoonShot.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+myInfo.apiKey.moonshot}},o=Date.now();try{e=await waitUntil(fetch("https://api.moonshot.cn/v1/models",t))}catch(e){throw e}return o=Date.now()-o,logger.info("MoonShot","List: "+o/1e3+"s"),e=(e=await e.json()).data||e},AI.MoonShot.chat=async(e,t=DefaultMoonShotChatModel,o={})=>{var e=assembleMessages(e,!1),[t,e]=assembleDataPack(t,e,o,myInfo.apiKey.moonshot),o={method:"POST",headers:t,body:JSON.stringify(e)},t=Date.now();try{a=await waitUntil(fetch("https://api.moonshot.cn/v1/chat/completions",o))}catch(e){throw e}t=Date.now()-t,logger.info("MoonShot","Chat: "+t/1e3+"s");var a,e=a=await a.json(),o=a.usage,t=(o&&(logger.info("MoonShot",`Usage: Input ${o.prompt_tokens}, Output: `+o.completion_tokens),AIUsage.request++,AIUsage.input+=o.prompt_tokens,AIUsage.output+=o.completion_tokens),a.choices);if(t=(t=t&&t[0])&&t.message?.content)return t=t.trim();throw t="",o=e.error?.message||"Error Occur!",logger.error("MoonShot",o),new Error(o)},AI.DeepSeek.list=async()=>{var e,t={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+myInfo.apiKey.deepseek}},o=Date.now();try{e=await waitUntil(fetch("https://api.deepseek.com/models",t))}catch(e){throw e}return o=Date.now()-o,logger.info("DeepSeek","List: "+o/1e3+"s"),e=(e=await e.json()).data||e},AI.DeepSeek.chat=async(e,t=DefaultDeepSeekChatModel,o={})=>{var e=assembleMessages(e,!1),[t,e]=assembleDataPack(t,e,o,myInfo.apiKey.deepseek),o={method:"POST",headers:t,body:JSON.stringify(e)},t=Date.now();try{a=await waitUntil(fetch("https://api.deepseek.com/beta/chat/completions",o))}catch(e){throw e}t=Date.now()-t,logger.info("DeepSeek","Chat: "+t/1e3+"s");var a,e=a=await a.json(),o=a.usage,t=(o&&(logger.info("DeepSeek",`Usage: Input ${o.prompt_tokens}, Output: `+o.completion_tokens),AIUsage.request++,AIUsage.input+=o.prompt_tokens,AIUsage.output+=o.completion_tokens),a.choices);if(t=(t=t&&t[0])&&t.message?.content)return t=t.trim();throw t="",o=e.error?.message||"Error Occur!",logger.error("DeepSeek",o),new Error(o)},AI.GLM.chat=async(e,t=DefaultGLMChatModel,o={})=>{var e=assembleMessages(e,!1),a=JWSgenerate(myInfo.apiKey.glm,31536e3),[t,e]=assembleDataPack(t,e,o,a),o={method:"POST",headers:t,body:JSON.stringify(e)},a=Date.now();try{r=await waitUntil(fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions",o))}catch(e){throw e}a=Date.now()-a,logger.info("GLM","Chat: "+a/1e3+"s");var r,t=r=await r.json(),e=r.usage,o=(e&&(logger.info("GLM",`Usage: Input ${e.prompt_tokens}, Output: `+e.completion_tokens),AIUsage.request++,AIUsage.input+=e.prompt_tokens,AIUsage.output+=e.completion_tokens),r.choices);if(o=(o=o&&o[0])&&o.message?.content)return o=o.trim();throw o="",a=t.error?.message||"Error Occur!",logger.error("GLM",a),new Error(a)},AI.GLM.draw=async(e,t=DefaultGLMDrawModel,o={})=>{t={model:t,prompt:e,n:o.n||1,quality:o.quality||"standard",size:o.size||"1024x1024",style:o.style||"vivid"},e={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+JWSgenerate(myInfo.apiKey.glm,31536e3)},body:JSON.stringify(t)},o=Date.now();try{a=await waitUntil(fetch("https://open.bigmodel.cn/api/paas/v4/images/generations",e))}catch(e){throw e}o=Date.now()-o,logger.info("GLM","Chat: "+o/1e3+"s");var a,t=a=await a.json(),e=a.data;if(e)return e=e.map(e=>e.url);throw o=t.error?.message||"Error Occur!",logger.error("GLM",o),new Error(o)};