globalThis.AI=globalThis.AI||{},globalThis.AI.Gemini={};let DefaultChatModel=AI2Model.gemini[0],DefaultEmbeddingModel="text-embedding-004",combineObject=(...e)=>{var t=[],o=(e.forEach(e=>{Object.keys(e).forEach(e=>{t.includes(e)||t.push(e)})}),{});return t.forEach(t=>{var a=[],n=!1;e.forEach(e=>{e=e[t];void 0!==e&&(a.push(e),n=isObject(e))}),0!==a.length&&(1===a.length?o[t]=a[0]:n?1===(a=a.filter(e=>isObject(e))).length?o[t]=a[0]:o[t]=combineObject(...a):o[t]=a[a.length-1])}),o},getRequestHeader=e=>Object.assign(ModelDefaultConfig.Gemini.header,(ModelDefaultConfig[e]||{}).header||{}),getRequestPackage=(e,t,a)=>combineObject(ModelDefaultConfig.Gemini[t],(ModelDefaultConfig[e]||{})[t]||{},a||{}),assembleConversation=e=>{var t="",a=[];return e.forEach(e=>{"system"===e[0]?t={parts:{text:e[1]}}:"human"===e[0]?a.push({role:"user",parts:[{text:e[1]}]}):"ai"===e[0]&&a.push({role:"model",parts:[{text:e[1]}]})}),a={contents:a},t&&(a.system_instruction=t),a},scoreContent=e=>{var t=0;return e=(e=(e=e.replace(/[a-zA-Z]+/g,()=>(t+=2.5," "))).replace(/[\d\.]+/g,()=>(t+=1," "))).replace(/[\u4e00-\u9fa5]/g,()=>(t+=1," ")),Math.floor(t)};AI.Gemini.list=async()=>{var e,t="https://generativelanguage.googleapis.com/v1beta/models?key="+myInfo.apiKey.gemini,a={method:"GET",headers:getRequestHeader()},n=Date.now();try{e=await waitUntil(fetch(t,a))}catch(e){throw e}return n=Date.now()-n,logger.info("Gemini","List: "+n/1e3+"s"),e=await e.json()},AI.Gemini.chat=async(e,t=DefaultChatModel,a={})=>{a=getRequestPackage(t,"chat",a),Object.assign(a,assembleConversation(e)),e=getRequestHeader(t),t="https://generativelanguage.googleapis.com/v1beta/models/"+t+":generateContent?key="+myInfo.apiKey.gemini,a={method:"POST",headers:e,body:JSON.stringify(a)},e=Date.now();try{n=await waitUntil(fetch(t,a))}catch(e){throw e}e=Date.now()-e,logger.info("Gemini","Chat: "+e/1e3+"s"),n=await n.json(),logger.info("Gemini",n);var n,t=n,a=n.usageMetadata,e=(a&&(logger.info("Gemini",`Usage: Input ${a.promptTokenCount}, Output: `+a.candidatesTokenCount),AIUsage.request++,AIUsage.input+=a.promptTokenCount,AIUsage.output+=a.candidatesTokenCount),n.candidates);if(!(e=e&&e[0]))throw e="",a=t.error?.message||"Error Occur!",logger.error("Gemini",a),new Error(a);if(e=(e=e.content?.parts)&&e[0])return e=(e=e.text||"").trim();throw e="",n=t.error?.message||"Error Occur!",logger.error("Gemini",n),new Error(n)},AI.Gemini.embed=async(e,t=DefaultEmbeddingModel,a={})=>{var n,o=getRequestHeader(t),r=(t="models/"+t,[]),i=[],e=(e.forEach(e=>{i.push(scoreContent(e.content)),r.push({model:t,taskType:a.taskType||"RETRIEVAL_DOCUMENT",title:e.title,content:{parts:[{text:e.content}]}})}),r={requests:r},r={method:"POST",headers:o,body:JSON.stringify(r)},"https://generativelanguage.googleapis.com/v1beta/"+t+":batchEmbedContents?key="+myInfo.apiKey.gemini),o=Date.now();try{n=await waitUntil(fetch(e,r))}catch(e){throw e}return o=Date.now()-o,logger.info("Gemini","Embed: "+o/1e3+"s"),(n=await n.json()).embeddings?.map?n=n.embeddings.map((e,t)=>({weight:i[t],vector:e.values})):(logger.error("Gemini","Abnormal Response:",n),null)};