globalThis.AI=globalThis.AI||{},globalThis.AI.Gemini={};let DefaultChatModel=AI2Model.gemini[0],DefaultEmbeddingModel="text-embedding-004",combineObject=(...e)=>{var t=[],n=(e.forEach(e=>{Object.keys(e).forEach(e=>{t.includes(e)||t.push(e)})}),{});return t.forEach(t=>{var a=[],o=!1;e.forEach(e=>{e=e[t];void 0!==e&&(a.push(e),o=isObject(e))}),0!==a.length&&(1===a.length?n[t]=a[0]:o?1===(a=a.filter(e=>isObject(e))).length?n[t]=a[0]:n[t]=combineObject(...a):n[t]=a[a.length-1])}),n},getRequestHeader=e=>Object.assign(ModelDefaultConfig.Gemini.header,(ModelDefaultConfig[e]||{}).header||{}),getRequestPackage=(e,t,a)=>combineObject(ModelDefaultConfig.Gemini[t],(ModelDefaultConfig[e]||{})[t]||{},a||{}),assembleConversation=e=>{var t="",a=[];return e.forEach(e=>{"system"===e[0]?t={parts:{text:e[1]}}:"human"===e[0]?a.push({role:"user",parts:[{text:e[1]}]}):"ai"===e[0]&&a.push({role:"model",parts:[{text:e[1]}]})}),a={contents:a},t&&(a.system_instruction=t),a},scoreContent=e=>{var t=0;return e=(e=(e=e.replace(/[a-zA-Z]+/g,()=>(t+=2.5," "))).replace(/[\d\.]+/g,()=>(t+=1," "))).replace(/[\u4e00-\u9fa5]/g,()=>(t+=1," ")),Math.floor(t)};AI.Gemini.list=async()=>{var e,t="https://generativelanguage.googleapis.com/v1beta/models?key="+myInfo.apiKey.gemini,a={method:"GET",headers:getRequestHeader()},o=Date.now();try{e=await waitUntil(fetch(t,a))}catch(e){throw e}return o=Date.now()-o,logger.info("Gemini","List: "+o/1e3+"s"),e=await e.json()},AI.Gemini.chat=async(n,i=DefaultChatModel,e={})=>{for(var r=getRequestPackage(i,"chat",e),s=(Object.assign(r,assembleConversation(n)),getRequestHeader(i)),g="https://generativelanguage.googleapis.com/v1beta/models/"+i+":generateContent?key="+myInfo.apiKey.gemini,l=r,r={method:"POST",headers:s,body:JSON.stringify(l)},u=[],c={count:0,input:0,output:0},m=!0,e=Date.now();;){let e;try{await requestRateLimitLock(i),updateRateLimitLock(i,!0),e=await waitUntil(fetch(g,r)),updateRateLimitLock(i,!1)}catch(e){throw updateRateLimitLock(i,!1),e}e=await e.json(),logger.info("Gemini",e);var h=e.usageMetadata;c.count++,h&&(c.input+=h.promptTokenCount,c.output+=h.candidatesTokenCount);let t=e.candidates,a="",o="";if(!(t=t&&t[0]))throw h=e.error?.message||"Error Occur!",logger.error("Gemini",h),new Error(h);if(o=t.content?.parts,a=t.finishReason||"",!(o=o&&o[0]))throw o="",h=e.error?.message||"Error Occur!",logger.error("Gemini",h),new Error(h);if(o=(o=o.text||"").trim(),u.push(o),"max_tokens"!==a.toLowerCase())break;m?(n.push(["ai",o]),n.push(["human",PromptLib.continueOutput]),m=!1):n[n.length-2][1]=u.join(" "),l.contents=assembleConversation(n).contents,r={method:"POST",headers:s,body:JSON.stringify(l)}}return e=Date.now()-e,logger.info("Gemini","Timespent: "+e/1e3+"s; Input: "+c.input+"; Output: "+c.output),recordAIUsage(i,"Gemini",c),u.join(" ")},AI.Gemini.embed=async(e,t=DefaultEmbeddingModel,a={})=>{var o,n=getRequestHeader(t),i=(t="models/"+t,[]),r=[],e=(e.forEach(e=>{r.push(scoreContent(e.content)),i.push({model:t,taskType:a.taskType||"RETRIEVAL_DOCUMENT",title:e.title,content:{parts:[{text:e.content}]}})}),i={requests:i},i={method:"POST",headers:n,body:JSON.stringify(i)},"https://generativelanguage.googleapis.com/v1beta/"+t+":batchEmbedContents?key="+myInfo.apiKey.gemini),n=Date.now();try{o=await waitUntil(fetch(e,i))}catch(e){throw e}return n=Date.now()-n,logger.info("Gemini","Embed: "+n/1e3+"s"),(o=await o.json()).embeddings?.map?o=o.embeddings.map((e,t)=>({weight:r[t],vector:e.values})):(logger.error("Gemini","Abnormal Response:",o),null)};