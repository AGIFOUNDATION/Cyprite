globalThis.AI=globalThis.AI||{},globalThis.AI.Ernie={};let ExpirationShift=6e4,assemblePayload=e=>{var o={messages:[]};return e.forEach(e=>{var t,a=e[1];"system"===e[0]?o.system=a:("human"===e[0]?t="user":"ai"===e[0]&&(t="assistant"),o.messages.push({role:t,content:a}))}),o};AI.Ernie.chat=async(i,r,e={})=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],a=myInfo.apiKey.ernie.api||"",o=myInfo.apiKey.ernie.secret||"",n=Model2AI[r],s="ernie_access_token",c=await chrome.storage.local.get(s),u=!0;if(u=(c=c&&c[s])&&(m=c.expires_in||0,g=c.timestamp||0,c=c.access_token,g+m>Date.now()+ExpirationShift)?!1:u){var l,h=`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${a}&client_secret=`+o,p={method:"GET",headers:{"Content-Type":"application/json;charset=utf-8"}},g=Date.now();try{l=await fetch(h,p)}catch(e){throw logger.err("ErnieAuth",e),new Error(t.configPage.hintErnieAuthFailed)}l=await l.json(),logger.info("ErnieAuth",l),c=l.access_token;var m=l.expires_in,u={};u[s]={access_token:c,expires_in:m,timestamp:g},chrome.storage.local.set(u).then(()=>{logger.info("ErnieAuth","AccessToken Info Saved")}).catch(e=>{logger.error("ErnieAuth",e)})}for(var h="https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro?access_token="+c,a=Object.assign({},ModelDefaultConfig[n].header,(ModelDefaultConfig[r]||{}).header||{}),f=assemblePayload(i),f=Object.assign({},ModelDefaultConfig[n].chat,(ModelDefaultConfig[r]||{}).chat||{},e||{},f),p={method:"POST",headers:a,body:JSON.stringify(f)},d=[],w={count:0,input:0,output:0},y=!0,o=Date.now(),E=0;;){let e;try{await requestRateLimitLock(r),updateRateLimitLock(r,!0),e=await waitUntil(fetchWithCheck(h,p)),updateRateLimitLock(r,!1)}catch(e){throw updateRateLimitLock(r,!1),e}e=await e.json(),logger.info("Ernie",e);var _=e.error_msg;if(_)throw new Error(_);let t=e.usage,a=e.result,o=e.is_truncated;if(w.count++,t&&(w.input+=t.prompt_tokens,w.output+=t.completion_tokens),!a)throw a="",_="Error Occur!",logger.error("Ernie",_),new Error(_);if(a=a.trim(),d.push(a),!o)break;if(y?(i.push(["ai",a]),i.push(["human",PromptLib.continueOutput]),y=!1):i[i.length-2][1]=d.join(" "),f.messages=assemblePayload(i).messages,p.body=JSON.stringify(f),++E>=ModelContinueRequestLoopLimit)break}return o=Date.now()-o,logger.info("Ernie","Timespent: "+o/1e3+"s; Input: "+w.input+"; Output: "+w.output),recordAIUsage(r,"Ernie",w),d.join(" ")};