let PageName="HomeScreen",WikiPediaLimit=5,WikiPediaMaxForDeepThinking=5,ArxivLimit=10,ArxivMax=5,SearchDefaultCount=20,SearchMaxCount=10,SearchLocalLimit=10,MaximumConcurrentWebpageReading=3,MaximumWebpageRead=15,DefaultPanel="intelligentSearch",OrderTypes={totalDuration:"TotalDuration",lastVisit:"LastVisit"},UseSearch=!0,CurrentArticleList=[],PageContentCache={},GoogleSearchCache={},LLMSearchCache={};var AIModelList=null,currentTabId=0,curerntStatusMention=null,aiSearchInputter=null,tmrThinkingHint=null,searchResult="",advSearchConversation=null,ntfDeepThinking=null,running=!1,orderType="totalDuration",lastTranslatContent="",cachedArticleList=null,webpageReaded=0;let generateModelList=async()=>{var e=await chrome.storage.local.get(["apiKey","AImodel"]),r=e.AImodel||"",a=e.apiKey||{};ModelList.splice(0),ModelOrder.forEach(e=>{var t=a[e];if("ernie"===e){if(!t||!t.api||!t.secret)return}else if(!t)return;AI2Model[e]&&ModelList.push(...AI2Model[e])}),AIModelList.innerHTML="",ModelList.forEach(e=>{var t,a=ModelNameList[e];a&&((t=newEle("div","panel_model_item")).innerText=a,t.setAttribute("name",e),e===r&&t.classList.add("current"),AIModelList.appendChild(t))})},onChooseModel=async({target:e})=>{e.classList.contains("panel_model_item")&&(e=e.getAttribute("name"),chrome.storage.local.set({AImodel:e}),updateModelList(e),e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],Notification.show(e.cypriteName,e.mentions.changeModelSuccess,"middleTop","success",2e3))},onInputFinish=(e,t,a)=>{e=e.getBoundingClientRect().height;t.style.height=e+"px",t=a.parentNode.getBoundingClientRect(),a.style.height=t.height-e-10+"px",resizer=null},onContentPaste=e=>{e.preventDefault();var t=e.clipboardData.getData("text/html"),e=e.clipboardData.getData("text/plain")||e.clipboardData.getData("text"),t=t?getPageContent(t,!0):e;t&&document.execCommand("insertText",!1,t)},onSelectArticleItem=({target:e})=>{e.classList.contains("panel_article_list_item")&&(e.getAttribute("selected")?e.removeAttribute("selected"):e.setAttribute("selected","true"))},onSelectReference=({target:e})=>{var t,a,r,n;"LI"===e.tagName&&e.classList.contains("reference_item")&&(t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r=(a=document.body.querySelector(".reference_page")).querySelector(".title"),n=a.querySelector(".content"),r.innerText=e._data.title.replace(/[\n\r]+/g," "),parseMarkdownWithOutwardHyperlinks(n,t.aiSearch.hintReferenceTitle+"[URL]("+e._data.url+")\n\n----\n\n"+e._data.reply),a.style.display="block")},parseParams=(ActionCenter.closeReference=()=>{document.body.querySelector(".reference_page").style.display="none"},()=>{var e=(e=location.search.replace(/^\?*/,"")).split("&"),r={};return e.forEach(e=>{var t,a=(e=e.split("=")).shift(),e=e.join("=");e?(t=+e,isNaN(t)||(e=t)):e=!0,r[a]=e}),r}),updateAIModelList=()=>{var e,t=!1;for(e in ModelList.splice(0),myInfo.apiKey){var a=myInfo.apiKey[e];if("ernie"===e){if(!a||!a.api||!a.secret)continue}else if(!a)continue;t=!0,AI2Model[e]&&ModelList.push(...AI2Model[e])}myInfo.edgeAvailable=t},updateModelList=async a=>{var e;a&&isString(a)||(e=await chrome.storage.local.get(["AImodel"]),a=e.AImodel||""),[...AIModelList.querySelectorAll(".panel_model_item")].forEach(e=>{var t=e.getAttribute("name");a===t?e.classList.add("current"):e.classList.remove("current")})},addChatItem=(e,t,a,r,n=!1)=>{var i=document.body.querySelector('.panel_operation_area[group="'+e+'"] .content_container'),n=n&&["crossPageConversation"].includes(e),e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],s=newEle("div","chat_item"),o=!1,l=(r=r||newID(),s.setAttribute("chatID",r),newEle("div","chat_title")),c=[];if("human"===a?(l.innerText=e.conversation.yourTalkPrompt,s.classList.add("human"),n&&c.push('<img button="true" action="changeRequest" src="../images/feather.svg">'),c.push('<img button="true" action="copyContent" src="../images/copy.svg">'),n&&c.push('<img button="true" action="deleteConversation" src="../images/trash-can.svg">')):"cyprite"===a?(l.innerText=e.cypriteName+":",s.classList.add("ai"),n&&c.push('<img button="true" action="reAnswerRequest" src="../images/rotate.svg">'),c.push('<img button="true" action="copyContent" src="../images/copy.svg">'),n&&c.push('<img button="true" action="deleteConversation" src="../images/trash-can.svg">')):(o=!0,l.innerText=a,s.classList.add("other")),s.appendChild(l),t){n=newEle("div","chat_content");parseMarkdownWithOutwardHyperlinks(n,t,e.conversation.AIFailed),n._data=t,s.appendChild(n)}else if(!o)return;a=newEle("div","operator_bar");return a.innerHTML=c.join(""),s.appendChild(a),i.appendChild(s),wait(60).then(()=>{i.scrollTop=i.scrollHeight-i.offsetHeight}),r},chooseTargetLanguage=e=>selectTranslationLanguages(e,myInfo.lang),parseWikiContent=(e,t=!1)=>{e=(e=(e=(e=(e=e.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var a=newEle("section"),r=(a.style.display="none",a.innerHTML=e,[]),n=([...a.querySelectorAll("h1, h2")].forEach(e=>{var t=e.parentNode,a=!1;r.some(e=>{if(e[0]===t)return e[1]++,a=!0}),a||r.push([t,1])}),r.sort((e,t)=>t[1]-e[1]),r[0][0]);return a.innerHTML="",a=null,r.splice(0),r=null,e=getPageContent(n,t),e},parseArxivAbstract=t=>{t=(t=(t=(t=(t=t.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var e,a=newEle("section"),r=(a.style.display="none",a.innerHTML=t,a.querySelector("h1.title"));if((r=r||a.querySelector(".title"))&&(e=(e=(e=r.textContent||"").replace(/^\s*Title:\s*/i,"")).trim()),r=(r=a.querySelector("blockquote.abstract"))||a.querySelector("blockquote, .abstract")){let e=r.textContent||"";t=(e=(e=e.replace(/^\s*Abs(tracts?)?:\s*/i,"")).trim())||getPageContent(t)}else t=getPageContent(t);return a.innerHTML="",r=a=null,{title:e,content:t}},parseWebPage=(e,t=!1)=>{if(!e)return"";e=(e=(e=(e=(e=e.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var a=newEle("section");return a.style.display="none",a.innerHTML=e,e=getPageContent(a,t),a.innerHTML="",a=null,e},downloadConversation=async()=>{let t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=currentTabId+":crosspageConv",a=await chrome.storage.session.get(e);var r,n,i;(a=(a||{})[e])&&(i=t.newTab.crossPageConversation,n=myInfo.model,(r=["#\t"+i]).push("> AI: "+n),r.push("\n-----\n"),a.forEach(e=>{if("human"===e[0])r.push("##\t"+myInfo.name);else{if("ai"!==e[0])return;r.push("##\t"+t.cypriteName)}r.push(e[1]),r.push("-----")}),r=r.join("\n\n"),i=new Blob([r],{type:"text/plain"}),n=URL.createObjectURL(i),(i=newEle("a")).setAttribute("href",n),i.setAttribute("download","conversation.md"),i.click(),Notification.show(t.cypriteName,t.crossPageConv.hintConversationDownloaded,"middleTop","success",2e3))},resizeCurrentInputter=()=>{var e=document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]'),t=e.querySelector(".input_container"),a=e.querySelector(".input_sender"),e=e.querySelector(".content_container");t&&a&&e&&onInputFinish(t,a,e)},switchToXPageConv=(globalThis.afterChangeTab=async()=>{"crossPageConversation"===currentMode?await switchToXPageConv():"articleManager"===currentMode&&(updateOrderType(),await loadFileList()),resizeCurrentInputter()},async()=>{var t=(r=document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]')).querySelector(".content_container"),a=!0,t=(t.querySelectorAll(".chat_item").length<=1?(t=((t=await chrome.storage.session.get(currentTabId+":crosspageConv"))||{})[currentTabId+":crosspageConv"])&&t.length&&t.forEach(e=>{"system"!==e[0]&&(a=!1,addChatItem("crossPageConversation",e[1],"ai"===e[0]?"cyprite":e[0],e[2],!0))}):a=!1,cachedArticleList);if(t=t||((t=await chrome.storage.local.get("cached_article_list"))||{}).cached_article_list)cachedArticleList=t,askSWandWait("GetArticleInfo",[!0,OrderTypes[orderType]]).then(e=>{cachedArticleList=e,chrome.storage.local.set({cached_article_list:e})}).catch(e=>{e=e.message||e.msg||e.data||e.toString(),Notification.show(messages.cypriteName,e,"middleTop","error",5e3)});else try{t=await askSWandWait("GetArticleInfo",[!0,OrderTypes[orderType]]),cachedArticleList=t,chrome.storage.local.set({cached_article_list:t})}catch(e){t=[],e=e.message||e.msg||e.data||e.toString(),Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}var r=document.body.querySelector(".panel_article_list");t&&t.length?(r.innerHTML="",t.forEach(e=>{var t=newEle("div","panel_article_list_item"),a=(t.url=e.url,newEle("img")),a=(a.src="/images/check.svg",t.appendChild(a),newEle("span"));a.innerText=e.title,t.appendChild(a),r.appendChild(t)})):(t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r.innerHTML=t.crossPageConv.noArticle),a&&ActionCenter.showArticleChooser()}),prepareXPageConv=async e=>{var n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if((s=((s=await chrome.storage.session.get(currentTabId+":crosspageConv"))||{})[currentTabId+":crosspageConv"])&&s.length){let t=[],a=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item[selected]")];if(0<a.length&&(a.forEach(e=>{t.push(e.url)}),t.sort((e,t)=>e===t?0:t<e?1:-1)),CurrentArticleList.join("|")!==t.join("|")&&0<t.length){CurrentArticleList.splice(0);try{a=await askSWandWait("GetArticleInfo",[a.map(e=>e.url),OrderTypes[orderType]])}catch(e){a=[],Notification.show(n.cypriteName,e,"middleTop","error",5e3)}var i={lang:LangName[myInfo.lang],related:"(No Reference Material)"};if(0<a.length){let t=[];a.forEach(e=>{CurrentArticleList.push(e.url),t.push('<currentArticle title="'+e.title+'" url="'+e.url+'">\n'+e.content.trim()+"\n</currentArticle>")}),i.content=t.join("\n"),CurrentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}else i.content="(No Current Article)";i=PromptLib.assemble(PromptLib.askPageSystem,i);s[0][1]=i}}else{CurrentArticleList.splice(0);let r=[],t=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item[selected]")];if(0<t.length){t=t.map(e=>e.url);try{t=await askSWandWait("GetArticleInfo",[t,OrderTypes[orderType]])}catch(e){t=[],Notification.show(n.cypriteName,e,"middleTop","error",5e3)}r=t.map(e=>(CurrentArticleList.push(e.url),{title:e.title,url:e.url,content:e.content})),CurrentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}if(0===r.length){let t;try{t=await askAIandWait("selectArticlesAboutConversation",e)}catch(e){t=[],Notification.show(n.cypriteName,e,"middleTop","error",5e3)}if(t=t||[],0<(r=t.map(e=>({title:e.title,url:e.url,content:e.content}))).length){let e=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item")];let a=["**"+(I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]).crossPageConv.hintFoundArticles+"**\n"];r.forEach(t=>{CurrentArticleList.push(t.url),a.push("-\t["+t.title+"]("+t.url+")"),e.some(e=>{if(e.url===t.url)return e.setAttribute("selected","true"),!0})}),addChatItem("crossPageConversation",a.join("\n"),"cyprite"),CurrentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}}i={lang:LangName[myInfo.lang],related:"(No Reference Material)"};if(0<r.length){let t=[];r.forEach(e=>{t.push('<currentArticle title="'+e.title+'" url="'+e.url+'">\n'+e.content.trim()+"\n</currentArticle>")}),i.content=t.join("\n")}else i.content="(No Current Article)";var s=[["system",PromptLib.assemble(PromptLib.askPageSystem,i)]]}return s.push(["human",e]),s},getDialogPair=e=>{var e=e.parentNode.parentNode,t=e.getAttribute("chatID"),a=[],r=[];if(t){if(e.classList.contains("human")){a.push(e),r.push(t);var n=e.nextElementSibling;if(!n)return;var i=n.getAttribute("chatID");if(!i)return;a.push(n),r.push(i)}else{n=e.previousElementSibling;if(!n)return;i=n.getAttribute("chatID");if(!i)return;a.push(n),r.push(i),a.push(e),r.push(t)}return[a,r,e,t]}};ActionCenter.downloadConversation=()=>{"crossPageConversation"===currentMode&&downloadConversation()},EventHandler.updateCurrentStatus=e=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];curerntStatusMention&&curerntStatusMention._hide(),curerntStatusMention=e?Notification.show(t.cypriteName,e,"middleTop","mention",864e5):null};var isAISearching=!(EventHandler.finishFirstTranslation=e=>{addChatItem("instantTranslation",e,"cyprite",null,!0)});let WebpageReadLock=new PoolWaitLock(MaximumConcurrentWebpageReading),searchWebPage=async(e,t,a,r)=>{logger.info("Search: "+r,e.join("; "));var t=Notification.show(t,a,"middleTop","mention",864e5),n={},a=(await Promise.all(e.map(async e=>{var t=GoogleSearchCache[e];if(t)t=[...t];else try{t=await askSWandWait("SearchGoogle",e),isArray(t)?0<t.length&&(GoogleSearchCache[e]=[...t]):t=[]}catch(e){t=[],Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}t.forEach(e=>{var t=n[e.url];t?t.summary=t.summary+"\n\n"+e.summary:n[e.url]=e})})),Object.keys(n)),i=(a.sort((e,t)=>{e=(n[e].summary||"").length;return(n[t].summary||"").length-e}),a.length>SearchMaxCount&&a.splice(SearchMaxCount),{});return a.forEach(e=>i[e]=n[e]),t._hide(),logger.info("Search: "+r,"Result: "+Object.keys(i).length),i},searchByLLM=async(t,e)=>{var a=Notification.show(t.cypriteName,t.aiSearch.hintCallingOtherLLMToSearch,"middleTop","mention",864e5),r=Date.now(),n=LLMSearchCache[e];if(n)n=[...n];else try{n=await askAIandWait("callLLMForSearch",e),isArray(n)?LLMSearchCache[e]=[...n]:n=[]}catch(e){n=[],Notification.show(t.cypriteName,e.message||e.msg||e.data||e.toString(),"middleTop","error",5e3)}return a._hide(),r=Date.now()-r,logger.info("LLMSearch","timeused: "+r+"ms, count: "+n.length),n},filterAndShowSearchRsult=async(e,t,a,r,n,i=!1,s=!1,o)=>{var l=Notification.show(o.cypriteName,o.aiSearch.msgFilteringWebPagesTask,"middleTop","mention",864e5),c=Object.values(t).filter(e=>!parseURL(e.url).match(/\.(pdf|doc|docx|ps|tar|gz|zip|rar|png|jpg|jpeg|gif|bmp|mp3|m4a|mp4|mv)$/i)),c=await filterSearchResult(c,n,100,o);return 0===(c=a&&a.length?[...a,...c]:c).length?(l._hide(),[]):(c.sort((e,t)=>(t.summary||"").length-(e.summary||"").length),showGoogleSearchResult(e,o,r,c,t,i),l._hide(),c=s?await readAndReplyWebpages(c,n,o):c)},listAndReadArxivResult=async(e,t,a,r,n=!1,i=!1,s)=>{var o=Notification.show(s.cypriteName,s.aiSearch.msgReadingArxivSummary,"middleTop","mention",864e5),t=Object.values(t);return 0===t.length?(o._hide(),[]):(t.sort((e,t)=>(t.summary||"").length-(e.summary||"").length),showOtherSearchResult(e,s,s.aiSearch.hintArxivResult,a,t,n),o._hide(),i&&(t.length>ArxivMax&&t.splice(ArxivMax),t=await readAndReplyWebpages(t,r,s)),t)},filterAndReadWikipediaResult=async(e,t,a,r,n=!1,i=!1,s)=>{var o=Notification.show(s.cypriteName,s.aiSearch.msgReadingWikipediaEntries,"middleTop","mention",864e5),t=await filterSearchResult(t,r,10,s);return 0===t.length?(o._hide(),[]):(t.sort((e,t)=>(t.summary||"").length-(e.summary||"").length),showOtherSearchResult(e,s,s.aiSearch.hintWikipediaResult,a,t,n),o._hide(),i&&(t.length>WikiPediaMaxForDeepThinking&&t.splice(WikiPediaMaxForDeepThinking),t=await readAndReplyWebpages(t,r,s)),t)},showGoogleSearchResult=(e,t,a,r,n,i=!1)=>{var s,o=newEle("div","search_result_title"),l=newEle("ul","search_result_list"),c=(i?(o.classList.add("foldhint"),o.innerText=t.aiSearch.hintSearchResult+" ("+r.length+")",l.classList.add("foldable")):o.innerText=t.aiSearch.hintSearchResult,e.appendChild(o),[]);r&&r.length?r.forEach(e=>{var t=newEle("li","search_result_item"),a=newEle("a");a.href=e.url,a.target="_blank",a.innerText=e.title.replace(/[\r\n]+/g," "),t.appendChild(a),l.appendChild(t),c.push(e.url)}):l.innerHTML='<li class="search_result_item">'+t.summarizeArticle.noRelatedArticle+"</li>",e.appendChild(l),o=newEle("div","search_result_title"),l=newEle("ul","search_result_list"),i?(o.classList.add("foldhint"),o.innerText=t.aiSearch.hintViceSearchResult+" ("+n.length+")",l.classList.add("foldable")):o.innerText=t.aiSearch.hintViceSearchResult,e.appendChild(o);for(s of a){var d=newEle("li","search_result_item"),h=newEle("a");h.href=`https://www.google.com/search?q=${s}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,h.target="_blank",h.innerText=t.aiSearch.hintKeywords+s,d.appendChild(h),l.appendChild(d)}var u,p=0;for(u in n)if(!c.includes(u)){var g=n[u],m=newEle("li","search_result_item"),y=newEle("a");if(y.href=g.url,y.target="_blank",y.innerText=g.title.replace(/[\r\n]+/g," "),m.appendChild(y),l.appendChild(m),15<=++p)break}0===p&&((r=newEle("li","search_result_item")).innerText=t.summarizeArticle.noRelatedArticle,l.appendChild(r)),e.appendChild(l),e.scrollIntoViewIfNeeded()},showOtherSearchResult=(e,t,a,r,n,i=!1)=>{var s,o,l=newEle("div","search_result_title"),c=newEle("ul","search_result_list");i&&(l.classList.add("foldhint"),c.classList.add("foldable")),e.appendChild(l);for(s of r){var d=newEle("li","search_result_item"),h=newEle("a");h.href=`https://www.google.com/search?q=${s}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,h.target="_blank",h.innerText=t.aiSearch.hintKeywords+s,d.appendChild(h),c.appendChild(d)}for(o of n){var u=newEle("li","search_result_item"),p=newEle("a");p.href=o.url,p.target="_blank",p.innerText=o.title.replace(/[\r\n]+/g," "),u.appendChild(p),c.appendChild(u)}l.innerText=i?a+" ("+n.length+")":a,e.appendChild(c),e.scrollIntoViewIfNeeded()},filterSearchResult=async(e,t,a,r)=>{var n,i;if(isArray(e))n=[...e];else{if(!isObject(e))return[];n=Object.values(e)}if(0===n.length)return[];try{i=(i=await askAIandWait("findRelativeWebPages",{requests:[t],articles:n,isWebPage:!0,limit:a}))||[]}catch(e){i=[],Notification.show(r.cypriteName,e,"middleTop","error",5e3)}return i},readAndReplyWebpages=async(e,a,r)=>{var t=Notification.show(r.cypriteName,r.aiSearch.msgReadingWebPage,"middleTop","mention",864e5);return await Promise.all(e.map(async(e,t)=>{if(await wait(50*t),await WebpageReadLock.start(),!(webpageReaded>=MaximumWebpageRead)){if(t=PageContentCache[e.url])e.content=t;else{try{t=await askSWandWait("ReadWebPage",e.url)}catch(e){t="",Notification.show(r.cypriteName,e,"middleTop","error",5e3)}t&&(e.url.match(/arxiv\.org/i)?((t=parseArxivAbstract(t)).title&&!e.title&&(e.title=t.title),e.content=t.content||e.summary||""):e.url.match(/wikipedia\.org/i)?e.content=parseWikiContent(t,!1)||"":e.content=parseWebPage(t,!1)||""),e.content?PageContentCache[e.url]=e.content:e.content=e.summary}e.reply=await replyOnWebpage(e.title,e.content,a)||"",e.reply&&webpageReaded++}WebpageReadLock.finish()})),e=e.filter(e=>!!e.reply),t._hide(),e},replyOnWebpage=async(e,t,a)=>{var r,n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],i=Notification.show(n.cypriteName,n.aiSearch.msgReadingArticle+e,"middleTop","mention",864e5);try{r=await askAIandWait("raedAndReply",{content:t,request:a}),logger.log("ReadPage&Reply",e.replace(/\s+/gi," ")),console.log(r)}catch(e){logger.error("ReadPage&Reply",e),r="",Notification.show(n.cypriteName,e,"middleTop","error",5e3)}return i._hide(),r||""},getSearchRequestList=async()=>{var e=await chrome.storage.local.get("searchHistory");return e&&e.searchHistory||[]},analyzeSearchKeywords=async(t,e)=>{var a,r,n=Notification.show(t.cypriteName,t.aiSearch.msgAnaylzeSearchTask,"middleTop","mention",864e5),i=Date.now();try{a=await askAIandWait("getSearchKeyWord",e),n._hide()}catch(e){a={},n._hide(),Notification.show(t.cypriteName,e.message||e.msg||e.data||e.toString(),"middleTop","error",5e3)}return a.search=a.search||[],a.search.unshift(e),logger.info("SearchKeywords",a.analyze),logger.info("SearchKeywords","timeused: "+(Date.now()-i)+"ms"),"keywordOnly"===myInfo.searchMode&&(n=[],a.search&&a.search.length&&n.push(...a.search),a.arxiv&&a.arxiv.length&&(a.arxiv=a.arxiv.map(e=>e+" site:arxiv.org"),n.push(...a.arxiv)),a.wikipedia&&a.wikipedia.length&&(a.wikipedia=a.wikipedia.map(e=>e+" site:wikipedia.org"),n.push(...a.wikipedia)),aiSearchInputter.answerPanelHint.innerText=t.aiSearch.hintSearchKeywordList,r=newEle("ul"),n.forEach(e=>{var t=newEle("li"),a=newEle("a");a.href=`https://www.google.com/search?q=${e}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,a.target="_blank",a.innerText=e,t.appendChild(a),r.appendChild(t)}),aiSearchInputter.answerPanel.appendChild(r),await wait(10),aiSearchInputter.answerPanel.scrollIntoViewIfNeeded(),await wait(10),aiSearchInputter.answerPanelHint.scrollIntoViewIfNeeded(),aiSearchInputter.setAttribute("contentEditable","true")),a},searchWebpageFromInternet=async(e,t)=>{var a,t=await analyzeSearchKeywords(e,t),r=[],[n,i,s]=(UseSearch&&t.search&&t.search.length?r.push(searchWebPage(t.search,e.cypriteName,e.aiSearch.msgSearchingWebPagesTask,"Google")):(t.search=[],r.push({})),UseSearch&&t.arxiv&&t.arxiv.length?(t.arxiv=t.arxiv.map(e=>e+" site:arxiv.org"),r.push(searchWebPage(t.arxiv,e.cypriteName,e.aiSearch.msgSearchingArxivTask,"ARXIV"))):(t.arxiv=[],r.push({})),UseSearch&&t.wikipedia&&t.wikipedia.length?(t.wikipedia=t.wikipedia.map(e=>e+" site:wikipedia.org"),r.push(searchWebPage(t.wikipedia,e.cypriteName,e.aiSearch.msgSearchingWikipediaTask,"WIKI"))):(t.wikipedia=[],r.push({})),await Promise.all(r));for(a in void 0)a.match(/arxiv\.org/i)?(i[a]||(i[a]=n[a]),delete n[a]):a.match(/wikipedia\.org/i)&&(s[a]||(s[a]=n[a]),delete n[a]);return[t,{search:n,arxiv:i,wikipedia:s}]},searchDocumentLocally=async(e,t)=>{var a,r=Notification.show(e.cypriteName,e.aiSearch.msgSearchingLocalArticle,"middleTop","mention",864e5);try{a=(a=await askAIandWait("selectArticlesAboutConversation",t))||[]}catch(e){a=[]}if(r._hide(),0<a.length){var n,t=newEle("div","search_result_title","foldhint"),i=(t.innerText=e.aiSearch.hintLocalResult+" ("+a.length+")",aiSearchInputter.resultLocal.appendChild(t),newEle("ul","search_result_list","foldable"));for(n of a){var s=newEle("li","search_result_item"),o=newEle("a");o.href=n.url,o.target="_blank",o.innerText=n.title.replace(/[\r\n]+/g," "),s.appendChild(o),i.appendChild(s)}aiSearchInputter.resultLocal.appendChild(i),aiSearchInputter.resultLocal.scrollIntoViewIfNeeded()}return a},searchInformationByKeywrods=async(e,t,a=!1,r=!1)=>{var n=Notification.show(e.cypriteName,e.aiSearch.msgSearchingWebPagesTask,"middleTop","mention",864e5),i=Date.now(),[s,o,l]=await Promise.all([searchWebpageFromInternet(e,t),r?searchDocumentLocally(e,t):[],searchByLLM(e,t)]),c=s[1],s=s[0];for(let t in c.search)(o.some(e=>e.url===t)||l.some(e=>e.url===t))&&delete c.search[t];for(let t in c.arxiv)(o.some(e=>e.url===t)||l.some(e=>e.url===t))&&delete c.arxiv[t];for(let t in c.wikipedia)(o.some(e=>e.url===t)||l.some(e=>e.url===t))&&delete c.wikipedia[t];c.search=Object.values(c.search),c.arxiv=Object.values(c.arxiv),c.wikipedia=Object.values(c.wikipedia),logger.info("SearchInformation","Search Results:"),console.log(o),console.log(l),console.log(c.search),console.log(c.arxiv),console.log(c.wikipedia),n._hide(),tasks=[],(webpageReaded=0)<Object.keys(c.arxiv).length?tasks.push(listAndReadArxivResult(aiSearchInputter.resultArxiv,c.arxiv,s.arxiv,t,a,r,e)):tasks.push([]),0<Object.keys(c.wikipedia).length?tasks.push(filterAndReadWikipediaResult(aiSearchInputter.resultWikipedia,c.wikipedia,s.wikipedia,t,a,r,e)):tasks.push([]),0<Object.keys(c.search).length+l.length?tasks.push(filterAndShowSearchRsult(aiSearchInputter.resultSearch,c.search,l,s.search,t,a,r,e)):tasks.push([]);var[n,s,t]=await Promise.all(tasks);return logger.info("SearchInformation","timeused: "+(Date.now()-i)+"ms"),{search:t,arxiv:n,wikipedia:s}},replyQuestBySearchResult=async(t,e)=>{var a,r,{search:n,arxiv:i,wikipedia:s}=await searchInformationByKeywrods(t,e,!0),n=(n=[...n,...i,...s]).filter(e=>!!e.summary),i=Notification.show(t.cypriteName,t.aiSearch.msgAnswering,"middleTop","mention",864e5);try{r=(a=await askAIandWait("replyBasedOnSearch",{request:e,webpages:n})).more||[],a=(a=a&&(a.reply._origin||a.reply))||t.aiSearch.msgEmptyAnswer}catch(e){logger.error("replyBasedOnSearch",e),r=[],a=t.aiSearch.msgEmptyAnswer,Notification.show(t.cypriteName,e.message||e.msg||e.data||e.toString(),"middleTop","error",5e3)}searchResult=a,aiSearchInputter.answerPanelHint.innerText=t.aiSearch.hintAnswering,aiSearchInputter.answerPanelHint.innerHTML=aiSearchInputter.answerPanelHint.innerHTML+'<img button="true" action="copySearchResult" src="../images/copy.svg">',parseMarkdownWithOutwardHyperlinks(aiSearchInputter.answerPanel,a,t.aiSearch.msgEmptyAnswer),[...document.querySelectorAll(".content_container .result_panel .foldable")].forEach(e=>e.classList.add("folded")),showMoreQuestions(r),(advSearchConversation=[]).push(["human",e]),advSearchConversation.push(["ai",a]),document.body.querySelector(".furthure_dialog").style.display="block",resizeCurrentInputter(),i._hide(),wait(100).then(()=>{aiSearchInputter.answerPanel.scrollIntoViewIfNeeded()})},basicReplyForQuest=async(t,e)=>{var a,r=Notification.show(t.cypriteName,t.aiSearch.msgPreliminaryThinking,"middleTop","mention",864e5);try{a=await askAIandWait("preliminaryThinking",{request:e})}catch(e){logger.error("replyBasedOnSearch",e),a=t.aiSearch.msgEmptyAnswer,Notification.show(t.cypriteName,e.message||e.msg||e.data||e.toString(),"middleTop","error",5e3)}return a&&(searchResult="# "+t.aiSearch.hintMyPreliminaryThinking+"\n\n"+a,aiSearchInputter.answerPanelHint.innerText=t.aiSearch.hintAnswering,aiSearchInputter.answerPanelHint.innerHTML=aiSearchInputter.answerPanelHint.innerHTML+'<img button="true" action="copySearchResult" src="../images/copy.svg">',parseMarkdownWithOutwardHyperlinks(aiSearchInputter.answerPanel,searchResult,t.aiSearch.msgEmptyAnswer)),r._hide(),a},replyQuestByFullyAnalyze=async(t,e)=>{var[r,a]=await Promise.all([searchInformationByKeywrods(t,e,!0,!0),basicReplyForQuest(t,e)]),r=[...r.search,...r.arxiv,...r.wikipedia];if(0<(r=r.filter(e=>!!e.reply)).length){let a=newEle("hr");aiSearchInputter.referencePanel.appendChild(a),(a=newEle("h3")).innerText=t.aiSearch.hintReference,aiSearchInputter.referencePanel.appendChild(a),a=newEle("ul"),r.forEach(e=>{var t=newEle("li","reference_item");t.innerText=e.title.replace(/[\n\r]+/g," "),t._data=e,a.appendChild(t)}),aiSearchInputter.referencePanel.appendChild(a)}var n,i,s,o=Notification.show(t.cypriteName,t.aiSearch.msgAnswering,"middleTop","mention",864e5);try{[n,i,s]=await askAIandWait("deepThinking",{request:e,basicAnswer:a,webpages:r})}catch(e){logger.error("replyBasedOnSearch",e),s=[],i=null,n=t.aiSearch.msgEmptyAnswer,Notification.show(t.cypriteName,e.message||e.msg||e.data||e.toString(),"middleTop","error",5e3)}searchResult=n,aiSearchInputter.answerPanelHint.innerText=t.aiSearch.hintAnswering,aiSearchInputter.answerPanelHint.innerHTML=aiSearchInputter.answerPanelHint.innerHTML+'<img button="true" action="copySearchResult" src="../images/copy.svg">',parseMarkdownWithOutwardHyperlinks(aiSearchInputter.answerPanel,n,t.aiSearch.msgEmptyAnswer),[...document.querySelectorAll(".content_container .result_panel .foldable")].forEach(e=>e.classList.add("folded")),showMoreQuestions(s),i&&(advSearchConversation=i),document.body.querySelector(".furthure_dialog").style.display="block",resizeCurrentInputter(),o._hide(),wait(100).then(()=>{ntfDeepThinking&&(ntfDeepThinking._hide(),ntfDeepThinking=null,aiSearchInputter.answerPanel.scrollIntoViewIfNeeded())})},showMoreQuestions=e=>{var t,a;e&&e.length&&(t=newEle("hr"),aiSearchInputter.morequestionPanel.appendChild(t),a=newEle("ul","search_result_list","more_question"),e.forEach(e=>{var t=newEle("li","search_result_item","more_question");t.innerText=e,t._question=e,a.appendChild(t)}),aiSearchInputter.morequestionPanel.appendChild(a))},updateOrderType=(ActionCenter.changeMode=async e=>{var e=e.getAttribute("mode"),t=aiSearchInputter.parentNode.querySelector(".mode_chooser > li[checked]");t&&t.removeAttribute("checked"),await chrome.storage.local.set({searchMode:e}),(t=aiSearchInputter.parentNode.querySelector('.mode_chooser > li[mode="'+e+'"]')).setAttribute("checked","true"),myInfo.searchMode=e},ActionCenter.startAISearch=async()=>{var e,a,t;isAISearching||(isAISearching=!0,[...aiSearchInputter.querySelectorAll("*")].forEach(e=>e.removeAttribute("style")),e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],a=getPageContent(aiSearchInputter,!0),isAISearching=(a?(aiSearchInputter.resultLocal.innerHTML="",aiSearchInputter.resultWikipedia.innerHTML="",aiSearchInputter.resultArxiv.innerHTML="",aiSearchInputter.resultSearch.innerHTML="",aiSearchInputter.answerPanel.innerHTML="",aiSearchInputter.answerPanelHint.innerHTML="",aiSearchInputter.referencePanel.innerHTML="",aiSearchInputter.morequestionPanel.innerHTML="",aiSearchInputter.removeAttribute("contentEditable"),ntfDeepThinking&&(ntfDeepThinking._hide(),ntfDeepThinking=null),advSearchConversation=null,[...document.body.querySelectorAll('[group="intelligentSearch"] .chat_item')].forEach(e=>{e.parentNode.removeChild(e)}),document.body.querySelector(".furthure_dialog").style.display="none",document.body.querySelector(".search_history").style.display="none",getSearchRequestList().then(e=>{a=a.trim();var t=e.indexOf(a);0!==t&&(0<t&&e.splice(t,1),e.unshift(a),10<e.length&&e.splice(10),chrome.storage.local.set({searchHistory:e}))}),t=Date.now(),"keywordOnly"===myInfo.searchMode?await analyzeSearchKeywords(e,a):"searchOnly"===myInfo.searchMode?await searchInformationByKeywrods(e,a):"fullAnswer"===myInfo.searchMode?await replyQuestBySearchResult(e,a):"fullAnalyze"===myInfo.searchMode&&await replyQuestByFullyAnalyze(e,a),t=Date.now()-t,logger.log("AISearch["+myInfo.searchMode+"]","Time Used: "+t+"ms"),aiSearchInputter.setAttribute("contentEditable","true")):Notification.show(e.cypriteName,e.aiSearch.msgEmptyRequest,"middleTop","warn",5e3),!1))},ActionCenter.chooseQuestion=(e,t,a)=>{var r,a=a.target;a.classList.contains("more_question")&&a._question&&(advSearchConversation?((r=document.querySelector('[group="intelligentSearch"] .furthure_dialog .input_container')).innerText=a._question,r):(aiSearchInputter.innerText=a._question,aiSearchInputter.scrollIntoViewIfNeeded(),aiSearchInputter)).focus()},EventHandler.updateDeepThinkingStatus=e=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];ntfDeepThinking&&ntfDeepThinking._hide(),ntfDeepThinking=Notification.show(t.cypriteName,e,"middleTop","mention",864e5)},ActionCenter.switchFold=(e,t,{target:a})=>{var r;a&&(a.classList.contains("foldhint")?(r=a.nextElementSibling)&&r.classList.contains("foldable")&&(r.classList.contains("folded")?r.classList.remove("folded"):r.classList.add("folded")):a.classList.contains("foldable")&&(a.classList.contains("folded")?a.classList.remove("folded"):a.classList.add("folded")))},()=>{var e=document.querySelectorAll(".panel_operation_area .caption .small.order");[...e].forEach(e=>{e.classList.remove("selected")}),(e=document.querySelector('.panel_operation_area .caption .small.order[orderType="'+orderType+'"]')).classList.add("selected")}),loadFileList=async()=>{let n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];var i=document.body.querySelector(".articleManagerFileList"),e=(i.innerHTML="",Notification.show(n.cypriteName,n.fileManager.loadingList,"middleTop","message",864e5));try{list=await askSWandWait("GetArticleInfo",[!1,OrderTypes[orderType]])}catch(e){list=[],Notification.show(n.cypriteName,e,"middleTop","error",5e3)}list.forEach(e=>{var t=newEle("li","file_item"),a=newEle("a"),a=(a.href=e.url,a.target="_blank",a.innerText=e.title.replace(/\s+/g," "),t.appendChild(a),e.hash&&((r=newEle("img")).src="../images/memory.svg",r.title=n.fileManager.imgHasHash,t.appendChild(r)),e.content&&((r=newEle("img")).src="../images/layer-group.svg",r.title=n.fileManager.imgHasVector,t.appendChild(r)),e.cached&&((r=newEle("img")).src="../images/database.svg",r.title=n.fileManager.imgHasContent,t.appendChild(r)),newEle("div","operator_bar")),r=newEle("img","button");r.src="../images/feather.svg",r.title=n.fileManager.removeCache,r.setAttribute("target",parseURL(e.url)),r.setAttribute("action","modify"),a.appendChild(r),(r=newEle("img","button")).src="../images/trash-can.svg",r.title=n.fileManager.removeCache,r.setAttribute("target",parseURL(e.url)),r.setAttribute("action","remove"),a.appendChild(r),t.appendChild(a),i.appendChild(t)}),i.parentNode.querySelector(".caption .count").innerText="("+list.length+")",e._hide()},onClickFileItemOperator=async({target:e})=>{if(e.classList.contains("button")){var l=e.getAttribute("target");if(l){var t=e.getAttribute("action");if(t){var c=e.parentNode.parentNode;if("remove"===t){try{await askSWandWait("RemovePageInfo",l)}catch(e){Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}c.parentNode.removeChild(c)}else if("modify"===t){c.classList.add("editing");let n=async e=>{if("Escape"===e.key)i.innerText=o,i.href=l,i.removeAttribute("contentEditable"),i.removeEventListener("keydown",n),c.classList.remove("editing"),e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0;else if("Enter"===e.key){var t=i.textContent.trim(),a=(i.innerText=t,I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]),r=Notification.show(a.cypriteName,a.fileManager.msgModifyingFileTitle,"middleTop","message",864e5);try{await askSWandWait("ChangePageTitle",{url:l,title:t})}catch(e){Notification.show(a.cypriteName,e,"middleTop","error",5e3)}i.innerText=t,r._hide(),i.href=s,i.removeAttribute("contentEditable"),i.removeEventListener("keydown",n),c.classList.remove("editing"),e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0}},i=c.querySelector("a"),s=i.href,o=i.textContent;i.removeAttribute("href"),i.contentEditable=!0,i.addEventListener("keydown",n),i.focus()}}}}},init=(ActionCenter.changeOrderType=async e=>{e&&(e=e.getAttribute("orderType"))&&(orderType=e,await chrome.storage.local.set({FilesOrderType:e}),updateOrderType(),loadFileList())},ActionCenter.refreshFileList=loadFileList,ActionCenter.removeUnsummarized=async()=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=Notification.show(t.cypriteName,t.fileManager.loadingList,"middleTop","message",864e5);try{await askSWandWait("RemovePageInfos",!1)}catch(e){Notification.show(t.cypriteName,e,"middleTop","error",5e3)}e._hide(),await loadFileList()},ActionCenter.removeUncached=async()=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=Notification.show(t.cypriteName,t.fileManager.loadingList,"middleTop","message",864e5);try{await askSWandWait("RemovePageInfos",!0)}catch(e){Notification.show(t.cypriteName,e,"middleTop","error",5e3)}e._hide(),await loadFileList()},EventHandler.requestHeartBeating=async()=>{logger.log("AI","HeartBeating...");var e=document.body.querySelector(".panel_container .panel_logo .thinking_hint");e.classList.add("show"),tmrThinkingHint&&clearTimeout(tmrThinkingHint),tmrThinkingHint=setTimeout(()=>{tmrThinkingHint=null,e.classList.remove("show")},2e3)},ActionCenter.gotoConfig=()=>{location.href="./config.html"},ActionCenter.clearConversation=async()=>{var t,a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(a.cypriteName,a.mentions.clearConversationWhileRunning,"middleTop","warn",2e3);else if(document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]').querySelector(".content_container").innerHTML="","crossPageConversation"===currentMode){let e=await chrome.storage.session.get(currentTabId+":crosspageConv");(e=(e||{})[currentTabId+":crosspageConv"])&&(e=e.filter(e=>"system"===e[0]),(t={})[currentTabId+":crosspageConv"]=e,await chrome.storage.session.set(t)),addChatItem("crossPageConversation",a.newTab.crossPageConversationHint,"cyprite")}else"instantTranslation"===currentMode&&addChatItem("instantTranslation",a.translation.instantTranslateHint,"cyprite")},ActionCenter.showArticleChooser=()=>{var e=document.body.querySelector(".panel_container");e&&(e.setAttribute("showMask","showArticleList"),e.setAttribute("showArticleList","true"))},ActionCenter.hideFloatWindow=()=>{var e,t=document.body.querySelector(".panel_container");t&&(e=t.getAttribute("showMask"))&&(t.removeAttribute("showMask"),t.removeAttribute(e))},ActionCenter.sendMessage=async t=>{running=!0;var a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=t.getAttribute("target"),r=t.parentNode.querySelector(".input_container"),n=t.parentNode.querySelector(".input_sender"),i=t.parentNode.querySelector(".content_container")||t.parentNode.parentNode.querySelector(".content_container"),t=getPageContent(r,!0);if(!t){if("instantTranslation"!==e)return;if(!lastTranslatContent)return;t=lastTranslatContent}var s,o,l=addChatItem(e,t,"human",null,!0);if(r.innerText=a.conversation.waitForAI,r.setAttribute("contenteditable","false"),wait(60).then(()=>{onInputFinish(r,n,i)}),"crossPageConversation"===e){(s=await prepareXPageConv(t))[s.length-1].push(l);try{o=await askAIandWait("crossPageConversation",s)}catch(e){o=null,Notification.show(a.cypriteName,e,"middleTop","error",5e3)}o?s.push(["ai",o]):s.pop()}else if("instantTranslation"===e){lastTranslatContent=t;var c=document.body.querySelector('[name="translation_language"]').value,c=chooseTargetLanguage(c);let e="translateSentence";var d=(d=calculateWordCount(t)).unlatin+2*d.latin;(10<t.replace(/\w+(\.\w+)+/g,"w").split(/[\.\!\?。！？\n\r]/).map(e=>e.trim()).filter(e=>!!e).length||200<d)&&(e="translateContent");try{o=await askAIandWait(e,{lang:c,content:t})}catch(e){o=null,Notification.show(a.cypriteName,e,"middleTop","error",5e3)}}else if("intelligentSearch"===e){(s=advSearchConversation||[]).push(["human",t]),console.log(t,advSearchConversation);try{o=await askAIandWait("crossPageConversation",s)}catch(e){o=null,Notification.show(a.cypriteName,e,"middleTop","error",5e3)}console.log("AISEARCH GOT REPLY:",o),o?s.push(["ai",o]):s.pop(),console.log(t,advSearchConversation)}else console.log(e),await wait(3e3),o="哇哈哈哈哈哈哈";l=addChatItem(e,o,"cyprite",null,!0),s&&(s[s.length-1].push(l),"crossPageConversation"===e)&&((d={})[currentTabId+":crosspageConv"]=s,chrome.storage.session.set(d)),r.innerText="",r.setAttribute("contenteditable","true"),r.focus(),running=!1},ActionCenter.copyContent=async(e,t)=>{var a=(a=e.parentNode.parentNode.querySelector(".chat_content")._data)||getPageContent(e,!0),e=(await navigator.clipboard.writeText(a),I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]);Notification.show(e.cypriteName,e.mentions.contentCopied,"middleTop","success",2e3),t.inputter.focus()},ActionCenter.deleteConversation=async(t,a)=>{var r=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(r.cypriteName,r.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var[t,n]=getDialogPair(t);if("crossPageConversation"===a.frame.parentNode.getAttribute("group")){a=currentTabId+":crosspageConv";let e=await chrome.storage.session.get(a);(e=(e||{})[a])&&(e=e.filter(e=>!n.includes(e[2])),t.forEach(e=>e.parentNode.removeChild(e)),(t={})[a]=e,await chrome.storage.session.set(t),Notification.show(r.cypriteName,r.crossPageConv.hintConversationDeleted,"middleTop","success",2e3))}}},ActionCenter.reAnswerRequest=async(i,s)=>{var o=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(o.cypriteName,o.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var[i,l]=getDialogPair(i);if("crossPageConversation"===s.frame.parentNode.getAttribute("group")){s=currentTabId+":crosspageConv";let n=await chrome.storage.session.get(s);if(n=(n||{})[s]){let a=[],r;if(n.some((e,t)=>(a.push(e),r=n[t+1],l.includes(e[2]))),r){running=!0;let t,e;e=Notification.show(o.cypriteName,o.conversation.waitForAI,"middleTop","message",864e5);try{t=await askAIandWait("crossPageConversation",a)}catch(e){t=null,Notification.show(o.cypriteName,e,"middleTop","error",5e3)}e._hide(),t?(r[1]=t,i=i[1].querySelector(".chat_content"),parseMarkdownWithOutwardHyperlinks(i,t,o.conversation.AIFailed),i._data=t,(i={})[s]=n,await chrome.storage.session.set(i),Notification.show(o.cypriteName,o.crossPageConv.hintRefreshSuccess,"middleTop","success",2e3)):Notification.show(o.cypriteName,o.crossPageConv.hintRefreshFailed,"middleTop","error",2e3),running=!1}}}}},ActionCenter.changeRequest=async(e,t)=>{let c=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(c.cypriteName,c.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var e=e.parentNode.parentNode,d=e.getAttribute("chatID");if("crossPageConversation"===t.frame.parentNode.getAttribute("group")){let a=currentTabId+":crosspageConv",r=await chrome.storage.session.get(a);if(!(r=(r||{})[a]))return;let n,i=(r.some(e=>(n=e)[2]===d),e=>{var t=!1;"Escape"===e.key?(s.innerHTML=o,t=!0):"Enter"===e.key&&e.ctrlKey&&((e=getPageContent(s))?(parseMarkdownWithOutwardHyperlinks(s,e),s._data=e,n[1]=e,(e={})[a]=r,chrome.storage.session.set(e).then(()=>{Notification.show(c.cypriteName,c.crossPageConv.hintChangeDialogSuccess,"middleTop","success",2e3)})):s.innerHTML=o,t=!0),t&&(s.contentEditable=!1,s.removeEventListener("keyup",i),l._hide())}),s=e.querySelector(".chat_content"),o=s.innerHTML,l=(s.addEventListener("keyup",i),s.innerText=s._data,s.contentEditable=!0,Notification.show(c.cypriteName,c.crossPageConv.hintModifyContent,"middleTop","mention",864e5));s.focus()}}},ActionCenter.onMayCopySearchResult=async(e,t,a)=>{"copySearchResult"===a.target.getAttribute("action")&&(await navigator.clipboard.writeText(searchResult),a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],Notification.show(a.cypriteName,a.mentions.contentCopied,"middleTop","success",2e3))},window.addEventListener("beforeunload",()=>{chrome.storage.session.remove(currentTabId+":crosspageConv")}),window.addEventListener("resize",resizeCurrentInputter),async()=>{var e=await Promise.all([chrome.storage.local.get("FilesOrderType"),getSearchRequestList(),getConfig()]);if(isArray(e[1])){let a=document.body.querySelector(".search_history");e[1].forEach(e=>{var t=newEle("li","search_result_item","more_question");t.innerText=e.replace(/[\r\n]+/g," "),t._question=e,a.appendChild(t)})}(e=(e[0]||{}).FilesOrderType)&&OrderTypes[e]&&(orderType=e),await getConfig(),updateAIModelList();var e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],t=(AIModelList=document.body.querySelector(".panel_model_chooser"),(aiSearchInputter=document.body.querySelector(".panel_operation_area .search_inputter > div.inner")).parentNode.parentNode.querySelector(".result_panel")),t=(aiSearchInputter.resultLocal=t.querySelector(".local_result_panel"),aiSearchInputter.resultWikipedia=t.querySelector(".wikipedia_result_panel"),aiSearchInputter.resultArxiv=t.querySelector(".arxiv_result_panel"),aiSearchInputter.resultSearch=t.querySelector(".search_result_panel"),aiSearchInputter.answerPanel=t.querySelector(".answer_panel"),aiSearchInputter.answerPanelHint=t.querySelector(".answer_panel_hint"),aiSearchInputter.referencePanel=t.querySelector(".reference_panel"),aiSearchInputter.morequestionPanel=t.querySelector(".morequestion_panel"),await generateModelList(""),document.body.querySelector('input[name="translation_language"]').value=LangName[myInfo.lang],renderI18N("newTab"),document.querySelector("html").setAttribute("lang",myInfo.lang),setGroupSwitcher(),AIModelList.addEventListener("click",onChooseModel),document.body.querySelector(".result_panel .reference_panel").addEventListener("click",onSelectReference),registerAction(),[...document.body.querySelectorAll('[type="conversationArea"]')].forEach(e=>{var t,a=e.querySelector(".content_container"),r=e.querySelector(".input_container"),n=e.querySelector(".input_sender");r.addEventListener("keyup",e=>{e.ctrlKey&&"Enter"===e.key&&ActionCenter.sendMessage(n),t=t||setTimeout(()=>{onInputFinish(r,n,a),t=null},300)}),r.addEventListener("paste",onContentPaste),a.addEventListener("click",({target:e})=>{var t=e.getAttribute("action");t&&(t=ActionCenter[t])&&t(e,{frame:a,inputter:r,sender:n})})}),document.body.querySelector(".panel_article_list").addEventListener("click",onSelectArticleItem),aiSearchInputter.addEventListener("paste",onContentPaste),aiSearchInputter.addEventListener("keyup",e=>{e.ctrlKey&&"Enter"===e.key&&ActionCenter.startAISearch()}),document.body.querySelector(".articleManagerFileList").addEventListener("click",onClickFileItemOperator),addChatItem("crossPageConversation",e.newTab.crossPageConversationHint,"cyprite"),addChatItem("instantTranslation",e.translation.instantTranslateHint,"cyprite"),aiSearchInputter.parentNode.querySelector('.mode_chooser > li[mode="'+myInfo.searchMode+'"]').setAttribute("checked","true"),await chrome.tabs.getCurrent());currentTabId=t.id;e=(await chrome.storage.session.get(currentTabId+":mode"))[currentTabId+":mode"]||DefaultPanel;changeTab(e)});window.onload=init;