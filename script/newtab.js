let PageName="HomeScreen",WikiPediaLimit=5,WikiPediaMax=0,WikiPediaMaxForDeepThinking=5,ArxivLimit=10,ArxivMax=5,SearchDefaultCount=10,SearchMaxCount=10,SearchLocalLimit=10,DefaultPanel="intelligentSearch",OrderTypes={totalDuration:"TotalDuration",lastVisit:"LastVisit"},UseSearch=!0;var AIModelList=null,currentTabId=0,curerntStatusMention=null,currentArticleList=[],aiSearchInputter=null,tmrThinkingHint=null,searchResult="",advSearchConversation=null,ntfDeepThinking=null,running=!1,orderType="totalDuration";let generateModelList=async()=>{var e=await chrome.storage.local.get(["apiKey","AImodel"]),a=e.AImodel||"",t=e.apiKey||{};ModelList.splice(0),ModelOrder.forEach(e=>{t[e]&&AI2Model[e]&&ModelList.push(...AI2Model[e])}),AIModelList.innerHTML="",ModelList.forEach(e=>{var t=newEle("div","panel_model_item");t.innerText=ModelNameList[e]||e,t.setAttribute("name",e),e===a&&t.classList.add("current"),AIModelList.appendChild(t)})},onChooseModel=async({target:e})=>{e.classList.contains("panel_model_item")&&(e=e.getAttribute("name"),chrome.storage.local.set({AImodel:e}),updateModelList(e),e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],Notification.show(e.cypriteName,e.mentions.changeModelSuccess,"middleTop","success",2e3))},onInputFinish=(e,t,a)=>{e=e.getBoundingClientRect().height;t.style.height=e+"px",t=a.parentNode.getBoundingClientRect(),a.style.height=t.height-e-10+"px",resizer=null},onContentPaste=e=>{e.preventDefault();var t=e.clipboardData.getData("text/html"),e=e.clipboardData.getData("text/plain")||e.clipboardData.getData("text"),t=t?getPageContent(t,!0):e;t&&document.execCommand("insertText",!1,t)},onSelectArticleItem=({target:e})=>{e.classList.contains("panel_article_list_item")&&(e.getAttribute("selected")?e.removeAttribute("selected"):e.setAttribute("selected","true"))},onSelectReference=({target:e})=>{var t,a,r,n;"LI"===e.tagName&&e.classList.contains("reference_item")&&(t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r=(a=document.body.querySelector(".reference_page")).querySelector(".title"),n=a.querySelector(".content"),r.innerText=e._data.title,n.innerHTML=marked.parse(t.aiSearch.hintReferenceTitle+"[URL]("+e._data.url+")\n\n----\n\n"+e._data.reply,{breaks:!0}),a.style.display="block",wait(100).then(()=>{[...n.querySelectorAll("a")].forEach(e=>{e.target="_blank"})}))},parseParams=(ActionCenter.closeReference=()=>{document.body.querySelector(".reference_page").style.display="none"},()=>{var e=(e=location.search.replace(/^\?*/,"")).split("&"),r={};return e.forEach(e=>{var t,a=(e=e.split("=")).shift(),e=e.join("=");e?(t=+e,isNaN(t)||(e=t)):e=!0,r[a]=e}),r}),updateAIModelList=()=>{var e,t=!1;for(e in ModelList.splice(0),myInfo.apiKey)myInfo.apiKey[e]&&(t=!0,AI2Model[e])&&ModelList.push(...AI2Model[e]);myInfo.edgeAvailable=t},updateModelList=async a=>{var e;a&&isString(a)||(e=await chrome.storage.local.get(["AImodel"]),a=e.AImodel||""),[...AIModelList.querySelectorAll(".panel_model_item")].forEach(e=>{var t=e.getAttribute("name");a===t?e.classList.add("current"):e.classList.remove("current")})},addChatItem=(e,t,a,r,n=!1)=>{var i=document.body.querySelector('.panel_operation_area[group="'+e+'"] .content_container'),n=n&&["crossPageConversation"].includes(e),e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],s=newEle("div","chat_item"),o=!1,l=(r=r||newID(),s.setAttribute("chatID",r),newEle("div","chat_title")),c=[];if("human"===a?(l.innerText=e.conversation.yourTalkPrompt,s.classList.add("human"),n&&c.push('<img button="true" action="changeRequest" src="../images/feather.svg">'),c.push('<img button="true" action="copyContent" src="../images/copy.svg">'),n&&c.push('<img button="true" action="deleteConversation" src="../images/trash-can.svg">')):"cyprite"===a?(l.innerText=e.cypriteName+":",s.classList.add("ai"),n&&c.push('<img button="true" action="reAnswerRequest" src="../images/rotate.svg">'),c.push('<img button="true" action="copyContent" src="../images/copy.svg">'),n&&c.push('<img button="true" action="deleteConversation" src="../images/trash-can.svg">')):(o=!0,l.innerText=a,s.classList.add("other")),s.appendChild(l),t){n=newEle("div","chat_content");n.innerHTML=marked.parse(t,{breaks:!0})||e.conversation.AIFailed,n._data=t,[...n.querySelectorAll("a")].forEach(e=>{e.href.match(/^(ht|f)tps?/)?e.target="_blank":e.target=""}),s.appendChild(n)}else if(!o)return;a=newEle("div","operator_bar");return a.innerHTML=c.join(""),s.appendChild(a),i.appendChild(s),wait(60).then(()=>{i.scrollTop=i.scrollHeight-i.offsetHeight}),r},chooseTargetLanguage=e=>{if(e&&e.toLowerCase()!==myInfo.lang&&LangName[myInfo.lang].toLowerCase()!==e.toLowerCase())return LangName[e]||e;for(var t in LangName)if(t!==myInfo.lang){e=LangName[t];break}return e},parseWikiContent=(e,t=!1)=>{e=(e=(e=(e=(e=e.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var a=newEle("section"),r=(a.style.display="none",a.innerHTML=e,[]),n=([...a.querySelectorAll("h1, h2")].forEach(e=>{var t=e.parentNode,a=!1;r.some(e=>{if(e[0]===t)return e[1]++,a=!0}),a||r.push([t,1])}),r.sort((e,t)=>t[1]-e[1]),r[0][0]);return a.innerHTML="",a=null,r.splice(0),r=null,e=getPageContent(n,t),e},parseArxivAbstract=t=>{t=(t=(t=(t=(t=t.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var e,a=newEle("section"),r=(a.style.display="none",a.innerHTML=t,a.querySelector("h1.title"));if((r=r||a.querySelector(".title"))&&(e=(e=(e=r.textContent||"").replace(/^\s*Title:\s*/i,"")).trim()),r=(r=a.querySelector("blockquote.abstract"))||a.querySelector("blockquote, .abstract")){let e=r.textContent||"";t=(e=(e=e.replace(/^\s*Abs(tracts?)?:\s*/i,"")).trim())||getPageContent(t)}else t=getPageContent(t);return a.innerHTML="",r=a=null,{title:e,content:t}},parseWebPage=(e,t=!1)=>{if(!e)return"";e=(e=(e=(e=(e=e.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var a=newEle("section");return a.style.display="none",a.innerHTML=e,e=getPageContent(a,t),a.innerHTML="",a=null,e},downloadConversation=async()=>{var t,e,a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r=currentTabId+":crosspageConv",n=((n=await chrome.storage.session.get(r))||{})[r];n&&(r=a.newTab.crossPageConversation,e=myInfo.model,(t=["#\t"+r]).push("> AI: "+e),t.push("\n-----\n"),n.forEach(e=>{if("human"===e[0])t.push("##\t"+myInfo.name);else{if("ai"!==e[0])return;t.push("##\t"+a.cypriteName)}t.push(e[1]),t.push("-----")}),t=t.join("\n\n"),r=new Blob([t],{type:"text/plain"}),e=URL.createObjectURL(r),(n=newEle("a")).setAttribute("href",e),n.setAttribute("download","conversation.md"),n.click(),Notification.show(a.cypriteName,a.crossPageConv.hintConversationDownloaded,"middleTop","success",2e3))},resizeCurrentInputter=()=>{var e=document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]'),t=e.querySelector(".input_container"),a=e.querySelector(".input_sender"),e=e.querySelector(".content_container");t&&a&&e&&onInputFinish(t,a,e)},switchToXPageConv=(globalThis.afterChangeTab=async()=>{"crossPageConversation"===currentMode?await switchToXPageConv():"articleManager"===currentMode&&(updateOrderType(),await loadFileList()),resizeCurrentInputter()},async()=>{var e,t=(r=document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]')).querySelector(".content_container"),a=!0;t.querySelectorAll(".chat_item").length<=1?(t=((t=await chrome.storage.session.get(currentTabId+":crosspageConv"))||{})[currentTabId+":crosspageConv"])&&t.length&&t.forEach(e=>{"system"!==e[0]&&(a=!1,addChatItem("crossPageConversation",e[1],"ai"===e[0]?"cyprite":e[0],e[2],!0))}):a=!1;try{e=await askSWandWait("GetArticleInfo",[!0,OrderTypes[orderType]])}catch{e=[]}var r=document.body.querySelector(".panel_article_list");e&&e.length?(r.innerHTML="",e.forEach(e=>{var t=newEle("div","panel_article_list_item"),a=(t.url=e.url,newEle("img")),a=(a.src="/images/check.svg",t.appendChild(a),newEle("span"));a.innerText=e.title,t.appendChild(a),r.appendChild(t)})):(t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r.innerHTML=t.crossPageConv.noArticle),a&&ActionCenter.showArticleChooser()}),prepareXPageConv=async t=>{if((n=((n=await chrome.storage.session.get(currentTabId+":crosspageConv"))||{})[currentTabId+":crosspageConv"])&&n.length){let t=[],e=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item[selected]")];if(0<e.length&&(e.forEach(e=>{t.push(e.url)}),t.sort((e,t)=>e===t?0:t<e?1:-1)),currentArticleList.join("|")!==t.join("|")&&0<t.length){currentArticleList=[];try{e=await askSWandWait("GetArticleInfo",[e.map(e=>e.url),OrderTypes[orderType]])}catch{e=[]}var a={lang:LangName[myInfo.lang],related:"(No Reference Material)"};if(0<e.length){let t=[];e.forEach(e=>{currentArticleList.push(e.url),t.push('<currentArticle title="'+e.title+'" url="'+e.url+'">\n'+e.content.trim()+"\n</currentArticle>")}),a.content=t.join("\n"),currentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}else a.content="(No Current Article)";a=PromptLib.assemble(PromptLib.askPageSystem,a);n[0][1]=a}}else{currentArticleList=[];let r=[],e=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item[selected]")];if(0<e.length){e=e.map(e=>e.url);try{e=await askSWandWait("GetArticleInfo",[e,OrderTypes[orderType]])}catch{e=[]}r=e.map(e=>(currentArticleList.push(e.url),{title:e.title,url:e.url,content:e.content})),currentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}if(0===r.length){let e;try{e=await askAIandWait("selectArticlesAboutConversation",t)}catch{e=[]}if(e=e||[],0<(r=e.map(e=>({title:e.title,url:e.url,content:e.content}))).length){let e=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item")];let a=["**"+(I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]).crossPageConv.hintFoundArticles+"**\n"];r.forEach(t=>{currentArticleList.push(t.url),a.push("-\t["+t.title+"]("+t.url+")"),e.some(e=>{if(e.url===t.url)return e.setAttribute("selected","true"),!0})}),addChatItem("crossPageConversation",a.join("\n"),"cyprite"),currentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}}a={lang:LangName[myInfo.lang],related:"(No Reference Material)"};if(0<r.length){let t=[];r.forEach(e=>{t.push('<currentArticle title="'+e.title+'" url="'+e.url+'">\n'+e.content.trim()+"\n</currentArticle>")}),a.content=t.join("\n")}else a.content="(No Current Article)";var n=[["system",PromptLib.assemble(PromptLib.askPageSystem,a)]]}return n.push(["human",t]),n},getDialogPair=e=>{var e=e.parentNode.parentNode,t=e.getAttribute("chatID"),a=[],r=[];if(t){if(e.classList.contains("human")){a.push(e),r.push(t);var n=e.nextElementSibling;if(!n)return;var i=n.getAttribute("chatID");if(!i)return;a.push(n),r.push(i)}else{n=e.previousElementSibling;if(!n)return;i=n.getAttribute("chatID");if(!i)return;a.push(n),r.push(i),a.push(e),r.push(t)}return[a,r,e,t]}},searchWebPage=(ActionCenter.downloadConversation=()=>{"crossPageConversation"===currentMode&&downloadConversation()},EventHandler.updateCurrentStatus=e=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];curerntStatusMention&&curerntStatusMention._hide(),e&&(curerntStatusMention=Notification.show(t.cypriteName,e,"middleTop","mention",864e5))},async(e,t,a,r)=>{logger.info("Search: "+r,e.join("; "));var t=Notification.show(t,a,"middleTop","mention",864e5),n={},a=(await Promise.all(e.map(async e=>{var t;try{t=await askSWandWait("SearchGoogle",e)}catch{t=[]}t.forEach(e=>{var t=n[e.url];t?t.summary=t.summary+"\n\n"+e.summary:n[e.url]=e})})),Object.keys(n)),i=(a.sort((e,t)=>{e=(n[e].summary||"").length;return(n[t].summary||"").length-e}),a.length>SearchMaxCount&&a.splice(SearchMaxCount),{});return a.forEach(e=>i[e]=n[e]),t._hide(),logger.info("Search: "+r,"Result: "+Object.keys(i).length),i}),filterAndShowSearchRsult=async(e,t,a,r,n,i=!1,s)=>{var o,l=Notification.show(s.cypriteName,s.aiSearch.msgFilteringWebPagesTask,"middleTop","mention",864e5),c=Object.values(t).filter(e=>!parseURL(e.url).match(/\.(pdf|doc|docx|ps|tar|gz|zip|rar|png|jpg|jpeg|gif|bmp|mp3|m4a|mp4|mv)$/i));try{o=(o=await askAIandWait("findRelativeWebPages",{requests:[r],articles:c,isWebPage:!0,limit:100}))||[]}catch{o=[]}return addSearchResult(e,s,a,o,t),o.length||(o=Object.values(t)).length>SearchDefaultCount&&o.splice(SearchDefaultCount),l._hide(),n&&o.length&&(c=Notification.show(s.cypriteName,s.aiSearch.msgReadingWebPage,"middleTop","mention",864e5),await Promise.all(o.map(async e=>{var t=await askSWandWait("ReadWebPage",e.url);e.url.match(/arxiv\.org/i)?((t=parseArxivAbstract(t)).title&&(e.title=t.title),e.content=t.content||e.summary,isArxiv=!0):e.url.match(/wikipedia\.org/i)?e.content=parseWikiContent(t,!1):e.content=parseWebPage(t,!1),i&&(e.reply=await readPageAndReply(e.title,e.content,r)||"")})),o=o.filter(e=>!!e.reply),c._hide()),o},listAndReadArxivResult=async(e,t,a,r,n,i=!1,s)=>{if(!Object.keys(t).length)return[];var o,l=newEle("div","search_result_title"),c=(l.innerText=s.aiSearch.hintArxivResult,e.appendChild(l),newEle("ul","search_result_list"));for(o of a){var d=newEle("li","search_result_item"),u=newEle("a");u.href=`https://www.google.com/search?q=${o}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,u.target="_blank",u.innerText=s.aiSearch.hintKeywords+o,d.appendChild(u),c.appendChild(d)}var h,p=[],g=0;for(h in t)if(h.match(/^https:\/\/arxiv\.org\/(abs|html|pdf)\//i)){var m=t[h],y=newEle("li","search_result_item"),f=newEle("a");if(f.href=m.url,f.target="_blank",f.innerText=m.title.replace(/\r*\n\r*/g," "),y.appendChild(f),c.appendChild(y),m.url=m.url.replace(/^https:\/\/arxiv\.org\/(html|pdf)\//i,"https://arxiv.org/abs/"),p.push(m),++g>=ArxivLimit)break}return e.appendChild(c),e.scrollIntoViewIfNeeded(),n&&p.length&&(p.length>ArxivMax&&p.splice(ArxivMax),l=Notification.show(s.cypriteName,s.aiSearch.msgReadingArxivSummary,"middleTop","mention",864e5),await Promise.all(p.map(async e=>{var t=await askSWandWait("ReadWebPage",e.url);(t=parseArxivAbstract(t)).title&&(e.title=t.title),e.content=t.content||e.summary,i&&(e.reply=e.content)})),l._hide()),p},filterAndReadWikipediaResult=async(e,a,t,r,n,i=!1,s)=>{if(!Object.keys(a).length)return[];var o=Notification.show(s.cypriteName,s.aiSearch.msgFilteringWebPagesTask,"middleTop","mention",864e5);try{g=await askAIandWait("findRelativeWebPages",{requests:[r],articles:Object.keys(a).map(e=>a[e]),isWebPage:!0,limit:10})}catch{g=[]}if(o._hide(),!g||!g.length)return[];var l,c={},o=(g.forEach(t=>{var e=a[t.url];e?c[t.url]=e:Object.keys(a).some(e=>{e=a[e];if(t.url===e.url)return c[t.url]=e,!0})}),a=c,newEle("div","search_result_title")),d=(o.innerText=s.aiSearch.hintWikipediaResult,e.appendChild(o),newEle("ul","search_result_list"));for(l of t){var u=newEle("li","search_result_item"),h=newEle("a");h.href=`https://www.google.com/search?q=${l}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,h.target="_blank",h.innerText=s.aiSearch.hintKeywords+l,u.appendChild(h),d.appendChild(u)}var p,g,m=[],y=0;for(p in a){var f=a[p],w=newEle("li","search_result_item"),v=newEle("a");if(v.href=f.url,v.target="_blank",v.innerText=f.title.replace(/\r*\n\r*/g," "),w.appendChild(v),d.appendChild(w),m.push(f),++y>=WikiPediaLimit)break}return e.appendChild(d),e.scrollIntoViewIfNeeded(),n&&m.length&&(g=i?WikiPediaMaxForDeepThinking:WikiPediaMax,m.length>g&&m.splice(g),o=Notification.show(s.cypriteName,s.aiSearch.msgReadingWikipediaEntries,"middleTop","mention",864e5),await Promise.all(m.map(async e=>{var t=await askSWandWait("ReadWebPage",e.url);e.content=parseWikiContent(t,!1),i&&(e.reply=await readPageAndReply(e.title,e.content,r)||"")})),m=m.filter(e=>!!e.reply),o._hide()),m},addSearchResult=(e,t,a,r,n)=>{var i,s=newEle("div","search_result_title"),o=(s.innerText=t.aiSearch.hintSearchResult,e.appendChild(s),newEle("ul","search_result_list")),l=[];r&&r.length?r.forEach(e=>{var t=newEle("li","search_result_item"),a=newEle("a");a.href=e.url,a.target="_blank",a.innerText=e.title.replace(/\r*\n\r*/g," "),t.appendChild(a),o.appendChild(t),l.push(e.url)}):o.innerHTML='<li class="search_result_item">'+t.summarizeArticle.noRelatedArticle+"</li>",e.appendChild(o),(s=newEle("div","search_result_title")).innerText=t.aiSearch.hintViceSearchResult,e.appendChild(s),o=newEle("ul","search_result_list");for(i of a){var c=newEle("li","search_result_item"),d=newEle("a");d.href=`https://www.google.com/search?q=${i}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,d.target="_blank",d.innerText=t.aiSearch.hintKeywords+i,c.appendChild(d),o.appendChild(c)}var u,h=0;for(u in n)if(!l.includes(u)){var p=n[u],g=newEle("li","search_result_item"),m=newEle("a");if(m.href=p.url,m.target="_blank",m.innerText=p.title.replace(/\r*\n\r*/g," "),g.appendChild(m),o.appendChild(g),15<=++h)break}0===h&&(o.innerHTML='<li class="search_result_item">'+t.summarizeArticle.noRelatedArticle+"</li>"),e.appendChild(o),e.scrollIntoViewIfNeeded()};var summaryAndReplies=[];let readPageAndReply=(t,a,r)=>new Promise(e=>{summaryAndReplies.push([t,a,r,e]),1===summaryAndReplies.length&&doReadPageAndReply()}),doReadPageAndReply=async()=>{var t,e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],[a,r,n,i]=summaryAndReplies[0],e=Notification.show(e.cypriteName,e.aiSearch.msgReadingArticle+a,"middleTop","mention",864e5);try{t=await askAIandWait("raedAndReply",{content:r,request:n}),logger.log("ReadPage&Reply",a.replace(/\s+/gi," ")),console.log(t)}catch(e){logger.error("ReadPage&Reply",e),t=""}e._hide(),i(t||""),summaryAndReplies.shift(),0<summaryAndReplies.length&&doReadPageAndReply()},getSearchRequestList=async()=>{var e=await chrome.storage.local.get("searchHistory");return e&&e.searchHistory||[]},updateOrderType=(ActionCenter.changeMode=async e=>{e=e.getAttribute("mode");aiSearchInputter.parentNode.querySelector(".mode_chooser > li[checked]").removeAttribute("checked"),await chrome.storage.local.set({searchMode:e}),aiSearchInputter.parentNode.querySelector('.mode_chooser > li[mode="'+e+'"]').setAttribute("checked","true"),myInfo.searchMode=e},ActionCenter.startAISearch=async()=>{[...aiSearchInputter.querySelectorAll("*")].forEach(e=>e.removeAttribute("style"));var e,t="fullAnalyze"===myInfo.searchMode,a=t||"fullAnswer"===myInfo.searchMode,r=getPageContent(aiSearchInputter,!0),n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(r){ntfDeepThinking&&(ntfDeepThinking._hide(),ntfDeepThinking=null),advSearchConversation=null,[...document.body.querySelectorAll('[group="intelligentSearch"] .chat_item')].forEach(e=>{e.parentNode.removeChild(e)}),document.body.querySelector(".furthure_dialog").style.display="none",document.body.querySelector(".search_history").style.display="none",getSearchRequestList().then(e=>{r=r.trim();var t=e.indexOf(r);0!==t&&(0<t&&e.splice(t,1),e.unshift(r),10<e.length&&e.splice(10),chrome.storage.local.set({searchHistory:e}))});var i,s=Date.now(),o=aiSearchInputter.parentNode.parentNode.querySelector(".result_panel"),l=o.querySelector(".local_result_panel"),c=o.querySelector(".wikipedia_result_panel"),d=o.querySelector(".arxiv_result_panel"),u=o.querySelector(".search_result_panel"),h=o.querySelector(".answer_panel"),p=o.querySelector(".answer_panel_hint"),g=o.querySelector(".reference_panel"),o=o.querySelector(".morequestion_panel");if(l.innerHTML="",c.innerHTML="",d.innerHTML="",u.innerHTML="",h.innerHTML="",p.innerHTML="",g.innerHTML="",o.innerHTML="",aiSearchInputter.removeAttribute("contentEditable"),t){e=Notification.show(n.cypriteName,n.aiSearch.msgSearchingLocalArticle,"middleTop","mention",864e5);var m=await askAIandWait("selectArticlesAboutConversation",{request:r,limit:SearchLocalLimit}),y=[];if(m&&m.length&&await Promise.all(m.map(async e=>{var t={};e.title&&(t.title=e.title),t.content=e.content||t.summary,t.url=e.url,t.reply=await readPageAndReply(t.title,t.content,r)||"",t.reply&&y.push(t)})),0<y.length){var f,m=newEle("div","search_result_title"),w=(m.innerText=n.aiSearch.hintLocalResult,l.appendChild(m),newEle("ul","search_result_list"));for(f of y){var v=newEle("li","search_result_item"),b=newEle("a");b.href=f.url,b.target="_blank",b.innerText=f.title.replace(/\r*\n\r*/g," "),v.appendChild(b),w.appendChild(v)}l.appendChild(w),l.scrollIntoViewIfNeeded()}e._hide()}e=Notification.show(n.cypriteName,n.aiSearch.msgAnaylzeSearchTask,"middleTop","mention",864e5);try{i=await askAIandWait("getSearchKeyWord",r)}catch{i={}}if(i.search=i.search||[],i.search.unshift(r),e._hide(),logger.info("SearchKeywords",i),"keywordOnly"===myInfo.searchMode){m=[];i.search&&i.search.length&&m.push(...i.search),i.arxiv&&i.arxiv.length&&(i.arxiv=i.arxiv.map(e=>e+" site:arxiv.org"),m.push(...i.arxiv)),i.wikipedia&&i.wikipedia.length&&(i.wikipedia=i.wikipedia.map(e=>e+" site:wikipedia.org"),m.push(...i.wikipedia)),p.innerText=n.aiSearch.hintSearchKeywordList;let r=newEle("ul");m.forEach(e=>{var t=newEle("li"),a=newEle("a");a.href=`https://www.google.com/search?q=${e}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,a.target="_blank",a.innerText=e,t.appendChild(a),r.appendChild(t)}),h.appendChild(r),await wait(10),h.scrollIntoViewIfNeeded(),await wait(10),p.scrollIntoViewIfNeeded(),aiSearchInputter.setAttribute("contentEditable","true"),void logger.info("AI Usage",Date.now()-s)}else{var I,A,l=[],[C,m,S]=(UseSearch&&i.search&&i.search.length?l.push(searchWebPage(i.search,n.cypriteName,n.aiSearch.msgSearchingWebPagesTask,"Google")):(i.search=[],l.push({})),UseSearch&&i.arxiv&&i.arxiv.length?(i.arxiv=i.arxiv.map(e=>e+" site:arxiv.org"),l.push(searchWebPage(i.arxiv,n.cypriteName,n.aiSearch.msgSearchingArxivTask,"ARXIV"))):(i.arxiv=[],l.push({})),UseSearch&&i.wikipedia&&i.wikipedia.length?(i.wikipedia=i.wikipedia.map(e=>e+" site:wikipedia.org"),l.push(searchWebPage(i.wikipedia,n.cypriteName,n.aiSearch.msgSearchingWikipediaTask,"WIKI"))):(i.wikipedia=[],l.push({})),await Promise.all(l));for(I in m)delete C[I];for(A in S)delete C[A];if(!y.length)for(let t in C)y.some(e=>0<=e.url.indexOf(t)||0<=t.indexOf(e.url))&&delete C[t];if(!Object.keys(m).length)for(var _ in C)_.match(/arxiv\.org/)&&delete C[_];if(!Object.keys(S).length)for(var T in C)T.match(/wikipedia\.org/)&&delete C[T];if(console.log(y),console.log(C),console.log(m),console.log(S),l=[],0<Object.keys(C).length?l.push(filterAndShowSearchRsult(u,C,i.search,r,a,t,n)):l.push([]),0<Object.keys(m).length?l.push(listAndReadArxivResult(d,m,i.arxiv,r,a,t,n)):l.push([]),0<Object.keys(S).length?l.push(filterAndReadWikipediaResult(c,S,i.wikipedia,r,a,t,n)):l.push([]),[C,m,S]=await Promise.all(l),a){var L,N,u=(u=[...y,...C,...m,...S]).filter(e=>!!e.reply&&!e.reply.match(/Based on the provided content, it is not possible to provide an answer/i));if(logger.log("Final Search Results"),console.log(u),t){let a=newEle("hr");g.appendChild(a),(a=newEle("h3")).innerText=n.aiSearch.hintReference,g.appendChild(a),a=newEle("ul"),u.forEach(e=>{var t=newEle("li","reference_item");t.innerText=e.title,t._data=e,a.appendChild(t)}),g.appendChild(a),L=await askAIandWait("deepThinking",{request:r,webpages:u}),advSearchConversation=L[1],N=L[2]||"",console.log(advSearchConversation),L=L[0],wait(1e3).then(()=>{ntfDeepThinking&&(ntfDeepThinking._hide(),ntfDeepThinking=null)})}else e=Notification.show(n.cypriteName,n.aiSearch.msgAnswering,"middleTop","mention",864e5),L=await askAIandWait("replyAISearch",{request:r,webpages:u}),e._hide();console.log(L),logger.info("AI Usage",Date.now()-s);var k=[];if(N?(N=N.split(/\r*\n\r*/).map(e=>e.trim()).filter(e=>!!e.match(/^[\-\+\*]\s+/))).forEach(e=>{e=e.replace(/^([\-\+\*]\s+)+/,""),k.push(e)}):L=n.aiSearch.msgEmptyAnswer,p.innerText=n.aiSearch.hintAnswering,searchResult=L,h.innerHTML=marked.parse(L,{breaks:!0})||n.aiSearch.msgEmptyAnswer,p.innerHTML=p.innerHTML+'<img button="true" action="copySearchResult" src="../images/copy.svg">',0<k.length){d=newEle("hr");o.appendChild(d);let a=newEle("ul","search_result_list","more_question");k.forEach(e=>{var t=newEle("li","search_result_item","more_question");t.innerText=e,t._question=e,a.appendChild(t)}),o.appendChild(a)}t&&(document.body.querySelector(".furthure_dialog").style.display="block",resizeCurrentInputter()),await wait(10),[...h.querySelectorAll("a")].forEach(e=>e.target="_blank"),aiSearchInputter.setAttribute("contentEditable","true"),await wait(10),h.scrollIntoViewIfNeeded(),await wait(10),p.scrollIntoViewIfNeeded(),resizeCurrentInputter()}else aiSearchInputter.setAttribute("contentEditable","true"),logger.info("AI Usage",Date.now()-s)}}else Notification.show(n.cypriteName,n.aiSearch.msgEmptyRequest,"middleTop","warn",5e3)},ActionCenter.chooseQuestion=(e,t,a)=>{var r,a=a.target;a.classList.contains("more_question")&&a._question&&(advSearchConversation?((r=document.querySelector('[group="intelligentSearch"] .furthure_dialog .input_container')).innerText=a._question,r):(aiSearchInputter.innerText=a._question,aiSearchInputter.scrollIntoViewIfNeeded(),aiSearchInputter)).focus()},EventHandler.updateDeepThinkingStatus=e=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];ntfDeepThinking&&ntfDeepThinking._hide(),ntfDeepThinking=Notification.show(t.cypriteName,e,"middleTop","mention",864e5)},()=>{var e=document.querySelectorAll(".panel_operation_area .caption .small.order");[...e].forEach(e=>{e.classList.remove("selected")}),(e=document.querySelector('.panel_operation_area .caption .small.order[orderType="'+orderType+'"]')).classList.add("selected")}),loadFileList=async()=>{var n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],i=document.body.querySelector(".articleManagerFileList"),e=(i.innerHTML="",Notification.show(n.cypriteName,n.fileManager.loadingList,"middleTop","message",864e5));(list=await askSWandWait("GetArticleInfo",[!1,OrderTypes[orderType]])).forEach(e=>{var t=newEle("li","file_item"),a=newEle("a"),a=(a.href=e.url,a.target="_blank",a.innerText=e.title.replace(/\s+/g," "),t.appendChild(a),e.hash&&e.embedding&&((r=newEle("img")).src="../images/memory.svg",r.title=n.fileManager.imgHasHash,t.appendChild(r)),e.content&&((r=newEle("img")).src="../images/layer-group.svg",r.title=n.fileManager.imgHasVector,t.appendChild(r)),e.cached&&((r=newEle("img")).src="../images/database.svg",r.title=n.fileManager.imgHasContent,t.appendChild(r)),newEle("div","operator_bar")),r=newEle("img","button");r.src="../images/feather.svg",r.title=n.fileManager.removeCache,r.setAttribute("target",parseURL(e.url)),r.setAttribute("action","modify"),a.appendChild(r),(r=newEle("img","button")).src="../images/trash-can.svg",r.title=n.fileManager.removeCache,r.setAttribute("target",parseURL(e.url)),r.setAttribute("action","remove"),a.appendChild(r),t.appendChild(a),i.appendChild(t)}),i.parentNode.querySelector(".caption .count").innerText="("+list.length+")",e._hide()},onClickFileItemOperator=async({target:e})=>{if(e.classList.contains("button")){var o=e.getAttribute("target");if(o){var t=e.getAttribute("action");if(t){var l=e.parentNode.parentNode;if("remove"===t)await askSWandWait("RemovePageInfo",o),l.parentNode.removeChild(l);else if("modify"===t){l.classList.add("editing");let r=async e=>{var t,a;"Escape"===e.key?(n.innerText=s,n.href=o,n.removeAttribute("contentEditable"),n.removeEventListener("keydown",r),l.classList.remove("editing"),e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0):"Enter"===e.key&&(t=n.textContent.trim(),n.innerText=t,a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],a=Notification.show(a.cypriteName,a.fileManager.msgModifyingFileTitle,"middleTop","message",864e5),await askSWandWait("ChangePageTitle",{url:o,title:t}),n.innerText=t,a._hide(),n.href=i,n.removeAttribute("contentEditable"),n.removeEventListener("keydown",r),l.classList.remove("editing"),e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0)},n=l.querySelector("a"),i=n.href,s=n.textContent;n.removeAttribute("href"),n.contentEditable=!0,n.addEventListener("keydown",r),n.focus()}}}}},init=(ActionCenter.changeOrderType=async e=>{e&&(e=e.getAttribute("orderType"))&&(orderType=e,await chrome.storage.local.set({FilesOrderType:e}),updateOrderType(),loadFileList())},ActionCenter.refreshFileList=loadFileList,ActionCenter.removeUnsummarized=async()=>{var e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=Notification.show(e.cypriteName,e.fileManager.loadingList,"middleTop","message",864e5);await askSWandWait("RemovePageInfos",!1),e._hide(),await loadFileList()},ActionCenter.removeUncached=async()=>{var e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=Notification.show(e.cypriteName,e.fileManager.loadingList,"middleTop","message",864e5);await askSWandWait("RemovePageInfos",!0),e._hide(),await loadFileList()},EventHandler.requestHeartBeating=async()=>{logger.log("AI","HeartBeating...");var e=document.body.querySelector(".panel_container .panel_logo .thinking_hint");e.classList.add("show"),tmrThinkingHint&&clearTimeout(tmrThinkingHint),tmrThinkingHint=setTimeout(()=>{tmrThinkingHint=null,e.classList.remove("show")},2e3)},ActionCenter.gotoConfig=()=>{location.href="./config.html"},ActionCenter.clearConversation=async()=>{var t,a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(a.cypriteName,a.mentions.clearConversationWhileRunning,"middleTop","warn",2e3);else if(document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]').querySelector(".content_container").innerHTML="","crossPageConversation"===currentMode){let e=await chrome.storage.session.get(currentTabId+":crosspageConv");(e=(e||{})[currentTabId+":crosspageConv"])&&(e=e.filter(e=>"system"===e[0]),(t={})[currentTabId+":crosspageConv"]=e,await chrome.storage.session.set(t)),addChatItem("crossPageConversation",a.newTab.crossPageConversationHint,"cyprite")}else"instantTranslation"===currentMode&&addChatItem("instantTranslation",a.translation.instantTranslateHint,"cyprite")},ActionCenter.showArticleChooser=()=>{var e=document.body.querySelector(".panel_container");e&&(e.setAttribute("showMask","showArticleList"),e.setAttribute("showArticleList","true"))},ActionCenter.hideFloatWindow=()=>{var e,t=document.body.querySelector(".panel_container");t&&(e=t.getAttribute("showMask"))&&(t.removeAttribute("showMask"),t.removeAttribute(e))},ActionCenter.sendMessage=async e=>{running=!0;var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],a=e.getAttribute("target"),r=e.parentNode.querySelector(".input_container"),n=e.parentNode.querySelector(".input_sender"),i=e.parentNode.querySelector(".content_container")||e.parentNode.parentNode.querySelector(".content_container"),e=getPageContent(r,!0);if(e){var s,o,l=addChatItem(a,e,"human",null,!0);if(r.innerText=t.conversation.waitForAI,r.setAttribute("contenteditable","false"),wait(60).then(()=>{onInputFinish(r,n,i)}),"crossPageConversation"===a){(s=await prepareXPageConv(e))[s.length-1].push(l);try{o=await askAIandWait("crossPageConversation",s)}catch{o=null}o?s.push(["ai",o]):s.pop()}else if("instantTranslation"===a){var t=document.body.querySelector('[name="translation_language"]').value,t=chooseTargetLanguage(t);try{o=await askAIandWait("translateSentence",{lang:t,content:e})}catch{o=null}}else if("intelligentSearch"===a){(s=advSearchConversation||[]).push(["human",e]),console.log(e,advSearchConversation);try{o=await askAIandWait("crossPageConversation",s)}catch{o=null}console.log("AISEARCH GOT REPLY:",o),o?s.push(["ai",o]):s.pop(),console.log(e,advSearchConversation)}else console.log(a),await wait(3e3),o="哇哈哈哈哈哈哈";l=addChatItem(a,o,"cyprite",null,!0),s&&(s[s.length-1].push(l),"crossPageConversation"===a)&&((t={})[currentTabId+":crosspageConv"]=s,chrome.storage.session.set(t)),r.innerText="",r.setAttribute("contenteditable","true"),r.focus(),running=!1}},ActionCenter.copyContent=async(e,t)=>{var a=(a=e.parentNode.parentNode.querySelector(".chat_content")._data)||getPageContent(e,!0),e=(await navigator.clipboard.writeText(a),I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]);Notification.show(e.cypriteName,e.mentions.contentCopied,"middleTop","success",2e3),t.inputter.focus()},ActionCenter.deleteConversation=async(t,a)=>{var r=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(r.cypriteName,r.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var[t,n]=getDialogPair(t);if("crossPageConversation"===a.frame.parentNode.getAttribute("group")){a=currentTabId+":crosspageConv";let e=await chrome.storage.session.get(a);(e=(e||{})[a])&&(e=e.filter(e=>!n.includes(e[2])),t.forEach(e=>e.parentNode.removeChild(e)),(t={})[a]=e,await chrome.storage.session.set(t),Notification.show(r.cypriteName,r.crossPageConv.hintConversationDeleted,"middleTop","success",2e3))}}},ActionCenter.reAnswerRequest=async(i,s)=>{var o=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(o.cypriteName,o.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var[i,l]=getDialogPair(i);if("crossPageConversation"===s.frame.parentNode.getAttribute("group")){s=currentTabId+":crosspageConv";let n=await chrome.storage.session.get(s);if(n=(n||{})[s]){let a=[],r;if(n.some((e,t)=>(a.push(e),r=n[t+1],l.includes(e[2]))),r){running=!0;let e,t;t=Notification.show(o.cypriteName,o.conversation.waitForAI,"middleTop","message",864e5);try{e=await askAIandWait("crossPageConversation",a)}catch{e=null}t._hide(),e?(r[1]=e,(i=i[1].querySelector(".chat_content")).innerHTML=marked.parse(e,{breaks:!0})||o.conversation.AIFailed,i._data=e,(i={})[s]=n,await chrome.storage.session.set(i),Notification.show(o.cypriteName,o.crossPageConv.hintRefreshSuccess,"middleTop","success",2e3)):Notification.show(o.cypriteName,o.crossPageConv.hintRefreshFailed,"middleTop","error",2e3),running=!1}}}}},ActionCenter.changeRequest=async(e,t)=>{var c=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(c.cypriteName,c.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var e=e.parentNode.parentNode,d=e.getAttribute("chatID");if("crossPageConversation"===t.frame.parentNode.getAttribute("group")){let a=currentTabId+":crosspageConv",r=await chrome.storage.session.get(a);if(!(r=(r||{})[a]))return;let n,i=(r.some(e=>(n=e)[2]===d),e=>{var t=!1;"Escape"===e.key?(s.innerHTML=o,t=!0):"Enter"===e.key&&e.ctrlKey&&((e=getPageContent(s))?(s.innerHTML=marked.parse(e,{breaks:!0}),s._data=e,n[1]=e,(e={})[a]=r,chrome.storage.session.set(e).then(()=>{Notification.show(c.cypriteName,c.crossPageConv.hintChangeDialogSuccess,"middleTop","success",2e3)})):s.innerHTML=o,t=!0),t&&(s.contentEditable=!1,s.removeEventListener("keyup",i),l._hide())}),s=e.querySelector(".chat_content"),o=s.innerHTML,l=(s.addEventListener("keyup",i),s.innerText=s._data,s.contentEditable=!0,Notification.show(c.cypriteName,c.crossPageConv.hintModifyContent,"middleTop","mention",864e5));s.focus()}}},ActionCenter.onMayCopySearchResult=async(e,t,a)=>{"copySearchResult"===a.target.getAttribute("action")&&(await navigator.clipboard.writeText(searchResult),a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],Notification.show(a.cypriteName,a.mentions.contentCopied,"middleTop","success",2e3))},window.addEventListener("beforeunload",()=>{chrome.storage.session.remove(currentTabId+":crosspageConv")}),window.addEventListener("resize",resizeCurrentInputter),async()=>{var e=await Promise.all([chrome.storage.local.get("FilesOrderType"),getSearchRequestList(),getConfig()]);if(isArray(e[1])){let a=document.body.querySelector(".search_history");e[1].forEach(e=>{var t=newEle("li","search_result_item","more_question");t.innerText=e,t._question=e,a.appendChild(t)})}(e=(e[0]||{}).FilesOrderType)&&OrderTypes[e]&&(orderType=e),await getConfig(),updateAIModelList();e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],AIModelList=document.body.querySelector(".panel_model_chooser"),aiSearchInputter=document.body.querySelector(".panel_operation_area .search_inputter > div.inner"),await generateModelList(""),document.body.querySelector('input[name="translation_language"]').value=LangName[myInfo.lang],renderI18N("newTab"),document.querySelector("html").setAttribute("lang",myInfo.lang),setGroupSwitcher(),AIModelList.addEventListener("click",onChooseModel),document.body.querySelector(".result_panel .reference_panel").addEventListener("click",onSelectReference),registerAction(),[...document.body.querySelectorAll('[type="conversationArea"]')].forEach(e=>{var t,a=e.querySelector(".content_container"),r=e.querySelector(".input_container"),n=e.querySelector(".input_sender");r.addEventListener("keyup",e=>{e.ctrlKey&&"Enter"===e.key&&ActionCenter.sendMessage(n),t=t||setTimeout(()=>{onInputFinish(r,n,a),t=null},300)}),r.addEventListener("paste",onContentPaste),a.addEventListener("click",({target:e})=>{var t=e.getAttribute("action");t&&(t=ActionCenter[t])&&t(e,{frame:a,inputter:r,sender:n})})}),document.body.querySelector(".panel_article_list").addEventListener("click",onSelectArticleItem),aiSearchInputter.addEventListener("paste",onContentPaste),aiSearchInputter.addEventListener("keyup",e=>{e.ctrlKey&&"Enter"===e.key&&ActionCenter.startAISearch()}),document.body.querySelector(".articleManagerFileList").addEventListener("click",onClickFileItemOperator),addChatItem("crossPageConversation",e.newTab.crossPageConversationHint,"cyprite"),addChatItem("instantTranslation",e.translation.instantTranslateHint,"cyprite"),aiSearchInputter.parentNode.querySelector('.mode_chooser > li[mode="'+myInfo.searchMode+'"]').setAttribute("checked","true"),e=await chrome.tabs.getCurrent();currentTabId=e.id;e=(await chrome.storage.session.get(currentTabId+":mode"))[currentTabId+":mode"]||DefaultPanel;changeTab(e)});window.onload=init;