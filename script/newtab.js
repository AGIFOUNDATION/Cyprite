let PageName="HomeScreen",WikiPediaLimit=5,WikiPediaMax=0,WikiPediaMaxForDeepThinking=5,ArxivLimit=10,ArxivMax=5,SearchDefaultCount=10,SearchMaxCount=10,SearchLocalLimit=10,DefaultPanel="intelligentSearch",OrderTypes={totalDuration:"TotalDuration",lastVisit:"LastVisit"},UseSearch=!0;var AIModelList=null,currentTabId=0,curerntStatusMention=null,currentArticleList=[],aiSearchInputter=null,tmrThinkingHint=null,searchResult="",advSearchConversation=null,ntfDeepThinking=null,running=!1,orderType="totalDuration";let generateModelList=async()=>{var e=await chrome.storage.local.get(["apiKey","AImodel"]),a=e.AImodel||"",t=e.apiKey||{};ModelList.splice(0),ModelOrder.forEach(e=>{t[e]&&AI2Model[e]&&ModelList.push(...AI2Model[e])}),AIModelList.innerHTML="",ModelList.forEach(e=>{var t=newEle("div","panel_model_item");t.innerText=ModelNameList[e]||e,t.setAttribute("name",e),e===a&&t.classList.add("current"),AIModelList.appendChild(t)})},onChooseModel=async({target:e})=>{e.classList.contains("panel_model_item")&&(e=e.getAttribute("name"),chrome.storage.local.set({AImodel:e}),updateModelList(e),e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],Notification.show(e.cypriteName,e.mentions.changeModelSuccess,"middleTop","success",2e3))},onInputFinish=(e,t,a)=>{e=e.getBoundingClientRect().height;t.style.height=e+"px",t=a.parentNode.getBoundingClientRect(),a.style.height=t.height-e-10+"px",resizer=null},onContentPaste=e=>{e.preventDefault();var t=e.clipboardData.getData("text/html"),e=e.clipboardData.getData("text/plain")||e.clipboardData.getData("text"),t=t?getPageContent(t,!0):e;t&&document.execCommand("insertText",!1,t)},onSelectArticleItem=({target:e})=>{e.classList.contains("panel_article_list_item")&&(e.getAttribute("selected")?e.removeAttribute("selected"):e.setAttribute("selected","true"))},onSelectReference=({target:e})=>{var t,a,r,n;"LI"===e.tagName&&e.classList.contains("reference_item")&&(t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r=(a=document.body.querySelector(".reference_page")).querySelector(".title"),n=a.querySelector(".content"),r.innerText=e._data.title,n.innerHTML=marked.parse(t.aiSearch.hintReferenceTitle+"[URL]("+e._data.url+")\n\n----\n\n"+e._data.reply,{breaks:!0}),a.style.display="block",wait(100).then(()=>{[...n.querySelectorAll("a")].forEach(e=>{e.target="_blank"})}))},parseParams=(ActionCenter.closeReference=()=>{document.body.querySelector(".reference_page").style.display="none"},()=>{var e=(e=location.search.replace(/^\?*/,"")).split("&"),r={};return e.forEach(e=>{var t,a=(e=e.split("=")).shift(),e=e.join("=");e?(t=+e,isNaN(t)||(e=t)):e=!0,r[a]=e}),r}),updateAIModelList=()=>{var e,t=!1;for(e in ModelList.splice(0),myInfo.apiKey)myInfo.apiKey[e]&&(t=!0,AI2Model[e])&&ModelList.push(...AI2Model[e]);myInfo.edgeAvailable=t},updateModelList=async a=>{var e;a&&isString(a)||(e=await chrome.storage.local.get(["AImodel"]),a=e.AImodel||""),[...AIModelList.querySelectorAll(".panel_model_item")].forEach(e=>{var t=e.getAttribute("name");a===t?e.classList.add("current"):e.classList.remove("current")})},addChatItem=(e,t,a,r,n=!1)=>{var i=document.body.querySelector('.panel_operation_area[group="'+e+'"] .content_container'),n=n&&["crossPageConversation"].includes(e),e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],o=newEle("div","chat_item"),s=!1,l=(r=r||newID(),o.setAttribute("chatID",r),newEle("div","chat_title")),c=[];if("human"===a?(l.innerText=e.conversation.yourTalkPrompt,o.classList.add("human"),n&&c.push('<img button="true" action="changeRequest" src="../images/feather.svg">'),c.push('<img button="true" action="copyContent" src="../images/copy.svg">'),n&&c.push('<img button="true" action="deleteConversation" src="../images/trash-can.svg">')):"cyprite"===a?(l.innerText=e.cypriteName+":",o.classList.add("ai"),n&&c.push('<img button="true" action="reAnswerRequest" src="../images/rotate.svg">'),c.push('<img button="true" action="copyContent" src="../images/copy.svg">'),n&&c.push('<img button="true" action="deleteConversation" src="../images/trash-can.svg">')):(s=!0,l.innerText=a,o.classList.add("other")),o.appendChild(l),t){n=newEle("div","chat_content");n.innerHTML=marked.parse(t,{breaks:!0})||e.conversation.AIFailed,n._data=t,[...n.querySelectorAll("a")].forEach(e=>{e.href.match(/^(ht|f)tps?/)?e.target="_blank":e.target=""}),o.appendChild(n)}else if(!s)return;a=newEle("div","operator_bar");return a.innerHTML=c.join(""),o.appendChild(a),i.appendChild(o),wait(60).then(()=>{i.scrollTop=i.scrollHeight-i.offsetHeight}),r},chooseTargetLanguage=e=>{if(e&&e.toLowerCase()!==myInfo.lang&&LangName[myInfo.lang].toLowerCase()!==e.toLowerCase())return LangName[e]||e;for(var t in LangName)if(t!==myInfo.lang){e=LangName[t];break}return e},parseWikiContent=(e,t=!1)=>{e=(e=(e=(e=(e=e.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var a=newEle("section"),r=(a.style.display="none",a.innerHTML=e,[]),n=([...a.querySelectorAll("h1, h2")].forEach(e=>{var t=e.parentNode,a=!1;r.some(e=>{if(e[0]===t)return e[1]++,a=!0}),a||r.push([t,1])}),r.sort((e,t)=>t[1]-e[1]),r[0][0]);return a.innerHTML="",a=null,r.splice(0),r=null,e=getPageContent(n,t),e},parseArxivAbstract=t=>{t=(t=(t=(t=(t=t.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var e,a=newEle("section"),r=(a.style.display="none",a.innerHTML=t,a.querySelector("h1.title"));if((r=r||a.querySelector(".title"))&&(e=(e=(e=r.textContent||"").replace(/^\s*Title:\s*/i,"")).trim()),r=(r=a.querySelector("blockquote.abstract"))||a.querySelector("blockquote, .abstract")){let e=r.textContent||"";t=(e=(e=e.replace(/^\s*Abs(tracts?)?:\s*/i,"")).trim())||getPageContent(t)}else t=getPageContent(t);return a.innerHTML="",r=a=null,{title:e,content:t}},parseWebPage=(e,t=!1)=>{if(!e)return"";e=(e=(e=(e=(e=e.replace(/<body[\w\W]*?>\s*([\w\W]*)\s*<\/body>/i,(e,t)=>t)).replace(/<script[\w\W]*?>\s*([\w\W]*?)\s*<\/script>/gi,"")).replace(/<style[\w\W]*?>\s*([\w\W]*?)\s*<\/style>/gi,"")).replace(/<link[\w\W]*?>/gi,"")).replace(/<img(\s+[\w\W]*?)?\/?>/gi,(e,t)=>{t=(t||"").match(/alt=('|")([\w\W]*?)\1/);return" "+((t=t?t[2].trim():"")||"(image)")+" "});var a=newEle("section");return a.style.display="none",a.innerHTML=e,e=getPageContent(a,t),a.innerHTML="",a=null,e},downloadConversation=async()=>{var t,e,a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r=currentTabId+":crosspageConv",n=((n=await chrome.storage.session.get(r))||{})[r];n&&(r=a.newTab.crossPageConversation,e=myInfo.model,(t=["#\t"+r]).push("> AI: "+e),t.push("\n-----\n"),n.forEach(e=>{if("human"===e[0])t.push("##\t"+myInfo.name);else{if("ai"!==e[0])return;t.push("##\t"+a.cypriteName)}t.push(e[1]),t.push("-----")}),t=t.join("\n\n"),r=new Blob([t],{type:"text/plain"}),e=URL.createObjectURL(r),(n=newEle("a")).setAttribute("href",e),n.setAttribute("download","conversation.md"),n.click(),Notification.show(a.cypriteName,a.crossPageConv.hintConversationDownloaded,"middleTop","success",2e3))},resizeCurrentInputter=()=>{var e=document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]'),t=e.querySelector(".input_container"),a=e.querySelector(".input_sender"),e=e.querySelector(".content_container");t&&a&&e&&onInputFinish(t,a,e)},switchToXPageConv=(globalThis.afterChangeTab=async()=>{"crossPageConversation"===currentMode?await switchToXPageConv():"articleManager"===currentMode&&(updateOrderType(),await loadFileList()),resizeCurrentInputter()},async()=>{var t,e=(r=document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]')).querySelector(".content_container"),a=!0;e.querySelectorAll(".chat_item").length<=1?(e=((e=await chrome.storage.session.get(currentTabId+":crosspageConv"))||{})[currentTabId+":crosspageConv"])&&e.length&&e.forEach(e=>{"system"!==e[0]&&(a=!1,addChatItem("crossPageConversation",e[1],"ai"===e[0]?"cyprite":e[0],e[2],!0))}):a=!1;try{t=await askSWandWait("GetArticleInfo",[!0,OrderTypes[orderType]])}catch(e){t=[],Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}var r=document.body.querySelector(".panel_article_list");t&&t.length?(r.innerHTML="",t.forEach(e=>{var t=newEle("div","panel_article_list_item"),a=(t.url=e.url,newEle("img")),a=(a.src="/images/check.svg",t.appendChild(a),newEle("span"));a.innerText=e.title,t.appendChild(a),r.appendChild(t)})):(e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],r.innerHTML=e.crossPageConv.noArticle),a&&ActionCenter.showArticleChooser()}),prepareXPageConv=async e=>{if((i=((i=await chrome.storage.session.get(currentTabId+":crosspageConv"))||{})[currentTabId+":crosspageConv"])&&i.length){let t=[],a=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item[selected]")];if(0<a.length&&(a.forEach(e=>{t.push(e.url)}),t.sort((e,t)=>e===t?0:t<e?1:-1)),currentArticleList.join("|")!==t.join("|")&&0<t.length){currentArticleList=[];try{a=await askSWandWait("GetArticleInfo",[a.map(e=>e.url),OrderTypes[orderType]])}catch(e){a=[],Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}var n={lang:LangName[myInfo.lang],related:"(No Reference Material)"};if(0<a.length){let t=[];a.forEach(e=>{currentArticleList.push(e.url),t.push('<currentArticle title="'+e.title+'" url="'+e.url+'">\n'+e.content.trim()+"\n</currentArticle>")}),n.content=t.join("\n"),currentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}else n.content="(No Current Article)";n=PromptLib.assemble(PromptLib.askPageSystem,n);i[0][1]=n}}else{currentArticleList=[];let r=[],t=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item[selected]")];if(0<t.length){t=t.map(e=>e.url);try{t=await askSWandWait("GetArticleInfo",[t,OrderTypes[orderType]])}catch(e){t=[],Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}r=t.map(e=>(currentArticleList.push(e.url),{title:e.title,url:e.url,content:e.content})),currentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}if(0===r.length){let t;try{t=await askAIandWait("selectArticlesAboutConversation",e)}catch(e){t=[],Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}if(t=t||[],0<(r=t.map(e=>({title:e.title,url:e.url,content:e.content}))).length){let e=[...document.body.querySelectorAll(".panel_article_list .panel_article_list_item")];let a=["**"+(I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]).crossPageConv.hintFoundArticles+"**\n"];r.forEach(t=>{currentArticleList.push(t.url),a.push("-\t["+t.title+"]("+t.url+")"),e.some(e=>{if(e.url===t.url)return e.setAttribute("selected","true"),!0})}),addChatItem("crossPageConversation",a.join("\n"),"cyprite"),currentArticleList.sort((e,t)=>e===t?0:t<e?1:-1)}}n={lang:LangName[myInfo.lang],related:"(No Reference Material)"};if(0<r.length){let t=[];r.forEach(e=>{t.push('<currentArticle title="'+e.title+'" url="'+e.url+'">\n'+e.content.trim()+"\n</currentArticle>")}),n.content=t.join("\n")}else n.content="(No Current Article)";var i=[["system",PromptLib.assemble(PromptLib.askPageSystem,n)]]}return i.push(["human",e]),i},getDialogPair=e=>{var e=e.parentNode.parentNode,t=e.getAttribute("chatID"),a=[],r=[];if(t){if(e.classList.contains("human")){a.push(e),r.push(t);var n=e.nextElementSibling;if(!n)return;var i=n.getAttribute("chatID");if(!i)return;a.push(n),r.push(i)}else{n=e.previousElementSibling;if(!n)return;i=n.getAttribute("chatID");if(!i)return;a.push(n),r.push(i),a.push(e),r.push(t)}return[a,r,e,t]}},searchWebPage=(ActionCenter.downloadConversation=()=>{"crossPageConversation"===currentMode&&downloadConversation()},EventHandler.updateCurrentStatus=e=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];curerntStatusMention&&curerntStatusMention._hide(),e&&(curerntStatusMention=Notification.show(t.cypriteName,e,"middleTop","mention",864e5))},async(e,t,a,r)=>{logger.info("Search: "+r,e.join("; "));var t=Notification.show(t,a,"middleTop","mention",864e5),n={},a=(await Promise.all(e.map(async e=>{var t;try{t=await askSWandWait("SearchGoogle",e)}catch(e){t=[],Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}t.forEach(e=>{var t=n[e.url];t?t.summary=t.summary+"\n\n"+e.summary:n[e.url]=e})})),Object.keys(n)),i=(a.sort((e,t)=>{e=(n[e].summary||"").length;return(n[t].summary||"").length-e}),a.length>SearchMaxCount&&a.splice(SearchMaxCount),{});return a.forEach(e=>i[e]=n[e]),t._hide(),logger.info("Search: "+r,"Result: "+Object.keys(i).length),i}),filterAndShowSearchRsult=async(e,t,a,r,n,i=!1,o)=>{var s,l=Notification.show(o.cypriteName,o.aiSearch.msgFilteringWebPagesTask,"middleTop","mention",864e5),c=Object.values(t).filter(e=>!parseURL(e.url).match(/\.(pdf|doc|docx|ps|tar|gz|zip|rar|png|jpg|jpeg|gif|bmp|mp3|m4a|mp4|mv)$/i));try{s=(s=await askAIandWait("findRelativeWebPages",{requests:[r],articles:c,isWebPage:!0,limit:100}))||[]}catch(e){s=[],Notification.show(o.cypriteName,e,"middleTop","error",5e3)}return addSearchResult(e,o,a,s,t),s.length||(s=Object.values(t)).length>SearchDefaultCount&&s.splice(SearchDefaultCount),l._hide(),n&&s.length&&(c=Notification.show(o.cypriteName,o.aiSearch.msgReadingWebPage,"middleTop","mention",864e5),await Promise.all(s.map(async e=>{var t;try{t=await askSWandWait("ReadWebPage",e.url)}catch(e){Notification.show(o.cypriteName,e,"middleTop","error",5e3)}e.url.match(/arxiv\.org/i)?((t=parseArxivAbstract(t)).title&&(e.title=t.title),e.content=t.content||e.summary,isArxiv=!0):e.url.match(/wikipedia\.org/i)?e.content=parseWikiContent(t,!1):e.content=parseWebPage(t,!1),i&&(e.reply=await readPageAndReply(e.title,e.content,r)||"")})),s=s.filter(e=>!!e.reply),c._hide()),s},listAndReadArxivResult=async(e,t,a,r,n,i=!1,o)=>{if(!Object.keys(t).length)return[];var s,l=newEle("div","search_result_title"),c=(l.innerText=o.aiSearch.hintArxivResult,e.appendChild(l),newEle("ul","search_result_list"));for(s of a){var d=newEle("li","search_result_item"),p=newEle("a");p.href=`https://www.google.com/search?q=${s}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,p.target="_blank",p.innerText=o.aiSearch.hintKeywords+s,d.appendChild(p),c.appendChild(d)}var h,u=[],g=0;for(h in t)if(h.match(/^https:\/\/arxiv\.org\/(abs|html|pdf)\//i)){var m=t[h],y=newEle("li","search_result_item"),f=newEle("a");if(f.href=m.url,f.target="_blank",f.innerText=m.title.replace(/\r*\n\r*/g," "),y.appendChild(f),c.appendChild(y),m.url=m.url.replace(/^https:\/\/arxiv\.org\/(html|pdf)\//i,"https://arxiv.org/abs/"),u.push(m),++g>=ArxivLimit)break}return e.appendChild(c),e.scrollIntoViewIfNeeded(),n&&u.length&&(u.length>ArxivMax&&u.splice(ArxivMax),l=Notification.show(o.cypriteName,o.aiSearch.msgReadingArxivSummary,"middleTop","mention",864e5),await Promise.all(u.map(async e=>{var t;try{t=await askSWandWait("ReadWebPage",e.url)}catch(e){Notification.show(o.cypriteName,e,"middleTop","error",5e3)}(t=t&&parseArxivAbstract(t))&&(t.title&&(e.title=t.title),e.content=t.content||e.summary,i)&&(e.reply=e.content)})),l._hide()),u},filterAndReadWikipediaResult=async(e,a,t,r,n,i=!1,o)=>{if(!Object.keys(a).length)return[];var s=Notification.show(o.cypriteName,o.aiSearch.msgFilteringWebPagesTask,"middleTop","mention",864e5);try{g=await askAIandWait("findRelativeWebPages",{requests:[r],articles:Object.keys(a).map(e=>a[e]),isWebPage:!0,limit:10})}catch(e){g=[],Notification.show(o.cypriteName,e,"middleTop","error",5e3)}if(s._hide(),!g||!g.length)return[];var l,c={},s=(g.forEach(t=>{var e=a[t.url];e?c[t.url]=e:Object.keys(a).some(e=>{e=a[e];if(t.url===e.url)return c[t.url]=e,!0})}),a=c,newEle("div","search_result_title")),d=(s.innerText=o.aiSearch.hintWikipediaResult,e.appendChild(s),newEle("ul","search_result_list"));for(l of t){var p=newEle("li","search_result_item"),h=newEle("a");h.href=`https://www.google.com/search?q=${l}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,h.target="_blank",h.innerText=o.aiSearch.hintKeywords+l,p.appendChild(h),d.appendChild(p)}var u,g,m=[],y=0;for(u in a){var f=a[u],w=newEle("li","search_result_item"),v=newEle("a");if(v.href=f.url,v.target="_blank",v.innerText=f.title.replace(/\r*\n\r*/g," "),w.appendChild(v),d.appendChild(w),m.push(f),++y>=WikiPediaLimit)break}return e.appendChild(d),e.scrollIntoViewIfNeeded(),n&&m.length&&(g=i?WikiPediaMaxForDeepThinking:WikiPediaMax,m.length>g&&m.splice(g),s=Notification.show(o.cypriteName,o.aiSearch.msgReadingWikipediaEntries,"middleTop","mention",864e5),await Promise.all(m.map(async e=>{var t;try{t=await askSWandWait("ReadWebPage",e.url)}catch(e){Notification.show(o.cypriteName,e,"middleTop","error",5e3)}t&&(e.content=parseWikiContent(t,!1),i)&&(e.reply=await readPageAndReply(e.title,e.content,r)||"")})),m=m.filter(e=>!!e.reply),s._hide()),m},addSearchResult=(e,t,a,r,n)=>{var i,o=newEle("div","search_result_title"),s=(o.innerText=t.aiSearch.hintSearchResult,e.appendChild(o),newEle("ul","search_result_list")),l=[];r&&r.length?r.forEach(e=>{var t=newEle("li","search_result_item"),a=newEle("a");a.href=e.url,a.target="_blank",a.innerText=e.title.replace(/\r*\n\r*/g," "),t.appendChild(a),s.appendChild(t),l.push(e.url)}):s.innerHTML='<li class="search_result_item">'+t.summarizeArticle.noRelatedArticle+"</li>",e.appendChild(s),(o=newEle("div","search_result_title")).innerText=t.aiSearch.hintViceSearchResult,e.appendChild(o),s=newEle("ul","search_result_list");for(i of a){var c=newEle("li","search_result_item"),d=newEle("a");d.href=`https://www.google.com/search?q=${i}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,d.target="_blank",d.innerText=t.aiSearch.hintKeywords+i,c.appendChild(d),s.appendChild(c)}var p,h=0;for(p in n)if(!l.includes(p)){var u=n[p],g=newEle("li","search_result_item"),m=newEle("a");if(m.href=u.url,m.target="_blank",m.innerText=u.title.replace(/\r*\n\r*/g," "),g.appendChild(m),s.appendChild(g),15<=++h)break}0===h&&(s.innerHTML='<li class="search_result_item">'+t.summarizeArticle.noRelatedArticle+"</li>"),e.appendChild(s),e.scrollIntoViewIfNeeded()};var summaryAndReplies=[];let readPageAndReply=(t,a,r)=>new Promise(e=>{summaryAndReplies.push([t,a,r,e]),1===summaryAndReplies.length&&doReadPageAndReply()}),doReadPageAndReply=async()=>{var t,a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],[e,r,n,i]=summaryAndReplies[0],o=Notification.show(a.cypriteName,a.aiSearch.msgReadingArticle+e,"middleTop","mention",864e5);try{t=await askAIandWait("raedAndReply",{content:r,request:n}),logger.log("ReadPage&Reply",e.replace(/\s+/gi," ")),console.log(t)}catch(e){logger.error("ReadPage&Reply",e),t="",Notification.show(a.cypriteName,e,"middleTop","error",5e3)}o._hide(),i(t||""),summaryAndReplies.shift(),0<summaryAndReplies.length&&doReadPageAndReply()},getSearchRequestList=async()=>{var e=await chrome.storage.local.get("searchHistory");return e&&e.searchHistory||[]},updateOrderType=(ActionCenter.changeMode=async e=>{e=e.getAttribute("mode");aiSearchInputter.parentNode.querySelector(".mode_chooser > li[checked]").removeAttribute("checked"),await chrome.storage.local.set({searchMode:e}),aiSearchInputter.parentNode.querySelector('.mode_chooser > li[mode="'+e+'"]').setAttribute("checked","true"),myInfo.searchMode=e},ActionCenter.startAISearch=async()=>{[...aiSearchInputter.querySelectorAll("*")].forEach(e=>e.removeAttribute("style"));var a,t,e="fullAnalyze"===myInfo.searchMode,r=e||"fullAnswer"===myInfo.searchMode,n=getPageContent(aiSearchInputter,!0),i=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(n){ntfDeepThinking&&(ntfDeepThinking._hide(),ntfDeepThinking=null),advSearchConversation=null,[...document.body.querySelectorAll('[group="intelligentSearch"] .chat_item')].forEach(e=>{e.parentNode.removeChild(e)}),document.body.querySelector(".furthure_dialog").style.display="none",document.body.querySelector(".search_history").style.display="none",getSearchRequestList().then(e=>{n=n.trim();var t=e.indexOf(n);0!==t&&(0<t&&e.splice(t,1),e.unshift(n),10<e.length&&e.splice(10),chrome.storage.local.set({searchHistory:e}))});var o,s=Date.now(),l=aiSearchInputter.parentNode.parentNode.querySelector(".result_panel"),c=l.querySelector(".local_result_panel"),d=l.querySelector(".wikipedia_result_panel"),p=l.querySelector(".arxiv_result_panel"),h=l.querySelector(".search_result_panel"),u=l.querySelector(".answer_panel"),g=l.querySelector(".answer_panel_hint"),m=l.querySelector(".reference_panel"),l=l.querySelector(".morequestion_panel");if(c.innerHTML="",d.innerHTML="",p.innerHTML="",h.innerHTML="",u.innerHTML="",g.innerHTML="",m.innerHTML="",l.innerHTML="",aiSearchInputter.removeAttribute("contentEditable"),e){t=Notification.show(i.cypriteName,i.aiSearch.msgSearchingLocalArticle,"middleTop","mention",864e5);let e;try{e=await askAIandWait("selectArticlesAboutConversation",{request:n,limit:SearchLocalLimit})}catch(e){Notification.show(i.cypriteName,e,"middleTop","error",5e3)}if(a=[],e&&e.length&&await Promise.all(e.map(async e=>{var t={};e.title&&(t.title=e.title),t.content=e.content||t.summary,t.url=e.url,t.reply=await readPageAndReply(t.title,t.content,n)||"",t.reply&&a.push(t)})),0<a.length){var y,f=newEle("div","search_result_title"),w=(f.innerText=i.aiSearch.hintLocalResult,c.appendChild(f),newEle("ul","search_result_list"));for(y of a){var v=newEle("li","search_result_item"),T=newEle("a");T.href=y.url,T.target="_blank",T.innerText=y.title.replace(/\r*\n\r*/g," "),v.appendChild(T),w.appendChild(v)}c.appendChild(w),c.scrollIntoViewIfNeeded()}t._hide()}t=Notification.show(i.cypriteName,i.aiSearch.msgAnaylzeSearchTask,"middleTop","mention",864e5);try{o=await askAIandWait("getSearchKeyWord",n)}catch(e){o={},Notification.show(i.cypriteName,e,"middleTop","error",5e3)}if(o.search=o.search||[],o.search.unshift(n),t._hide(),logger.info("SearchKeywords",o),"keywordOnly"===myInfo.searchMode){f=[];o.search&&o.search.length&&f.push(...o.search),o.arxiv&&o.arxiv.length&&(o.arxiv=o.arxiv.map(e=>e+" site:arxiv.org"),f.push(...o.arxiv)),o.wikipedia&&o.wikipedia.length&&(o.wikipedia=o.wikipedia.map(e=>e+" site:wikipedia.org"),f.push(...o.wikipedia)),g.innerText=i.aiSearch.hintSearchKeywordList;let r=newEle("ul");f.forEach(e=>{var t=newEle("li"),a=newEle("a");a.href=`https://www.google.com/search?q=${e}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`,a.target="_blank",a.innerText=e,t.appendChild(a),r.appendChild(t)}),u.appendChild(r),await wait(10),u.scrollIntoViewIfNeeded(),await wait(10),g.scrollIntoViewIfNeeded(),aiSearchInputter.setAttribute("contentEditable","true"),void logger.info("AI Usage",Date.now()-s)}else{var b,I,c=[],[A,f,C]=(UseSearch&&o.search&&o.search.length?c.push(searchWebPage(o.search,i.cypriteName,i.aiSearch.msgSearchingWebPagesTask,"Google")):(o.search=[],c.push({})),UseSearch&&o.arxiv&&o.arxiv.length?(o.arxiv=o.arxiv.map(e=>e+" site:arxiv.org"),c.push(searchWebPage(o.arxiv,i.cypriteName,i.aiSearch.msgSearchingArxivTask,"ARXIV"))):(o.arxiv=[],c.push({})),UseSearch&&o.wikipedia&&o.wikipedia.length?(o.wikipedia=o.wikipedia.map(e=>e+" site:wikipedia.org"),c.push(searchWebPage(o.wikipedia,i.cypriteName,i.aiSearch.msgSearchingWikipediaTask,"WIKI"))):(o.wikipedia=[],c.push({})),await Promise.all(c));for(b in f)delete A[b];for(I in C)delete A[I];if(!a.length)for(let t in A)a.some(e=>0<=e.url.indexOf(t)||0<=t.indexOf(e.url))&&delete A[t];if(!Object.keys(f).length)for(var N in A)N.match(/arxiv\.org/)&&delete A[N];if(!Object.keys(C).length)for(var S in A)S.match(/wikipedia\.org/)&&delete A[S];if(console.log(a),console.log(A),console.log(f),console.log(C),c=[],0<Object.keys(A).length?c.push(filterAndShowSearchRsult(h,A,o.search,n,r,e,i)):c.push([]),0<Object.keys(f).length?c.push(listAndReadArxivResult(p,f,o.arxiv,n,r,e,i)):c.push([]),0<Object.keys(C).length?c.push(filterAndReadWikipediaResult(d,C,o.wikipedia,n,r,e,i)):c.push([]),[A,f,C]=await Promise.all(c),r){var _,L,h=(h=[...a,...A,...f,...C]).filter(e=>!!e.reply&&!e.reply.match(/Based on the provided content, it is not possible to provide an answer/i));if(logger.log("Final Search Results"),console.log(h),e){if(0<h.length){let a=newEle("hr");m.appendChild(a),(a=newEle("h3")).innerText=i.aiSearch.hintReference,m.appendChild(a),a=newEle("ul"),h.forEach(e=>{var t=newEle("li","reference_item");t.innerText=e.title,t._data=e,a.appendChild(t)}),m.appendChild(a)}try{_=await askAIandWait("deepThinking",{request:n,webpages:h})}catch(e){Notification.show(i.cypriteName,e,"middleTop","error",5e3)}_&&(advSearchConversation=_[1],L=_[2]||"",console.log(advSearchConversation),_=_[0],wait(1e3).then(()=>{ntfDeepThinking&&(ntfDeepThinking._hide(),ntfDeepThinking=null)}))}else{t=Notification.show(i.cypriteName,i.aiSearch.msgAnswering,"middleTop","mention",864e5);try{_=await askAIandWait("replyAISearch",{request:n,webpages:h})}catch(e){_="",Notification.show(i.cypriteName,e,"middleTop","error",5e3)}t._hide()}console.log(_),logger.info("AI Usage",Date.now()-s);var k=[];if(L?(L=L.split(/\r*\n\r*/).map(e=>e.trim()).filter(e=>!!e.match(/^[\-\+\*]\s+/))).forEach(e=>{e=e.replace(/^([\-\+\*]\s+)+/,""),k.push(e)}):_=i.aiSearch.msgEmptyAnswer,g.innerText=i.aiSearch.hintAnswering,searchResult=_,u.innerHTML=marked.parse(_,{breaks:!0})||i.aiSearch.msgEmptyAnswer,g.innerHTML=g.innerHTML+'<img button="true" action="copySearchResult" src="../images/copy.svg">',0<k.length){p=newEle("hr");l.appendChild(p);let a=newEle("ul","search_result_list","more_question");k.forEach(e=>{var t=newEle("li","search_result_item","more_question");t.innerText=e,t._question=e,a.appendChild(t)}),l.appendChild(a)}e&&(document.body.querySelector(".furthure_dialog").style.display="block",resizeCurrentInputter()),await wait(10),[...u.querySelectorAll("a")].forEach(e=>e.target="_blank"),aiSearchInputter.setAttribute("contentEditable","true"),await wait(10),u.scrollIntoViewIfNeeded(),await wait(10),g.scrollIntoViewIfNeeded(),resizeCurrentInputter()}else aiSearchInputter.setAttribute("contentEditable","true"),logger.info("AI Usage",Date.now()-s)}}else Notification.show(i.cypriteName,i.aiSearch.msgEmptyRequest,"middleTop","warn",5e3)},ActionCenter.chooseQuestion=(e,t,a)=>{var r,a=a.target;a.classList.contains("more_question")&&a._question&&(advSearchConversation?((r=document.querySelector('[group="intelligentSearch"] .furthure_dialog .input_container')).innerText=a._question,r):(aiSearchInputter.innerText=a._question,aiSearchInputter.scrollIntoViewIfNeeded(),aiSearchInputter)).focus()},EventHandler.updateDeepThinkingStatus=e=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];ntfDeepThinking&&ntfDeepThinking._hide(),ntfDeepThinking=Notification.show(t.cypriteName,e,"middleTop","mention",864e5)},()=>{var e=document.querySelectorAll(".panel_operation_area .caption .small.order");[...e].forEach(e=>{e.classList.remove("selected")}),(e=document.querySelector('.panel_operation_area .caption .small.order[orderType="'+orderType+'"]')).classList.add("selected")}),loadFileList=async()=>{var n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],i=document.body.querySelector(".articleManagerFileList"),e=(i.innerHTML="",Notification.show(n.cypriteName,n.fileManager.loadingList,"middleTop","message",864e5));try{list=await askSWandWait("GetArticleInfo",[!1,OrderTypes[orderType]])}catch(e){list=[],Notification.show(n.cypriteName,e,"middleTop","error",5e3)}list.forEach(e=>{var t=newEle("li","file_item"),a=newEle("a"),a=(a.href=e.url,a.target="_blank",a.innerText=e.title.replace(/\s+/g," "),t.appendChild(a),e.hash&&e.embedding&&((r=newEle("img")).src="../images/memory.svg",r.title=n.fileManager.imgHasHash,t.appendChild(r)),e.content&&((r=newEle("img")).src="../images/layer-group.svg",r.title=n.fileManager.imgHasVector,t.appendChild(r)),e.cached&&((r=newEle("img")).src="../images/database.svg",r.title=n.fileManager.imgHasContent,t.appendChild(r)),newEle("div","operator_bar")),r=newEle("img","button");r.src="../images/feather.svg",r.title=n.fileManager.removeCache,r.setAttribute("target",parseURL(e.url)),r.setAttribute("action","modify"),a.appendChild(r),(r=newEle("img","button")).src="../images/trash-can.svg",r.title=n.fileManager.removeCache,r.setAttribute("target",parseURL(e.url)),r.setAttribute("action","remove"),a.appendChild(r),t.appendChild(a),i.appendChild(t)}),i.parentNode.querySelector(".caption .count").innerText="("+list.length+")",e._hide()},onClickFileItemOperator=async({target:e})=>{if(e.classList.contains("button")){var l=e.getAttribute("target");if(l){var t=e.getAttribute("action");if(t){var c=e.parentNode.parentNode;if("remove"===t){try{await askSWandWait("RemovePageInfo",l)}catch(e){Notification.show(messages.cypriteName,e,"middleTop","error",5e3)}c.parentNode.removeChild(c)}else if("modify"===t){c.classList.add("editing");let n=async e=>{if("Escape"===e.key)i.innerText=s,i.href=l,i.removeAttribute("contentEditable"),i.removeEventListener("keydown",n),c.classList.remove("editing"),e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0;else if("Enter"===e.key){var t=i.textContent.trim(),a=(i.innerText=t,I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]),r=Notification.show(a.cypriteName,a.fileManager.msgModifyingFileTitle,"middleTop","message",864e5);try{await askSWandWait("ChangePageTitle",{url:l,title:t})}catch(e){Notification.show(a.cypriteName,e,"middleTop","error",5e3)}i.innerText=t,r._hide(),i.href=o,i.removeAttribute("contentEditable"),i.removeEventListener("keydown",n),c.classList.remove("editing"),e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0}},i=c.querySelector("a"),o=i.href,s=i.textContent;i.removeAttribute("href"),i.contentEditable=!0,i.addEventListener("keydown",n),i.focus()}}}}},init=(ActionCenter.changeOrderType=async e=>{e&&(e=e.getAttribute("orderType"))&&(orderType=e,await chrome.storage.local.set({FilesOrderType:e}),updateOrderType(),loadFileList())},ActionCenter.refreshFileList=loadFileList,ActionCenter.removeUnsummarized=async()=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=Notification.show(t.cypriteName,t.fileManager.loadingList,"middleTop","message",864e5);try{await askSWandWait("RemovePageInfos",!1)}catch(e){Notification.show(t.cypriteName,e,"middleTop","error",5e3)}e._hide(),await loadFileList()},ActionCenter.removeUncached=async()=>{var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e=Notification.show(t.cypriteName,t.fileManager.loadingList,"middleTop","message",864e5);try{await askSWandWait("RemovePageInfos",!0)}catch(e){Notification.show(t.cypriteName,e,"middleTop","error",5e3)}e._hide(),await loadFileList()},EventHandler.requestHeartBeating=async()=>{logger.log("AI","HeartBeating...");var e=document.body.querySelector(".panel_container .panel_logo .thinking_hint");e.classList.add("show"),tmrThinkingHint&&clearTimeout(tmrThinkingHint),tmrThinkingHint=setTimeout(()=>{tmrThinkingHint=null,e.classList.remove("show")},2e3)},ActionCenter.gotoConfig=()=>{location.href="./config.html"},ActionCenter.clearConversation=async()=>{var t,a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(a.cypriteName,a.mentions.clearConversationWhileRunning,"middleTop","warn",2e3);else if(document.body.querySelector('.panel_operation_area[group="'+currentMode+'"]').querySelector(".content_container").innerHTML="","crossPageConversation"===currentMode){let e=await chrome.storage.session.get(currentTabId+":crosspageConv");(e=(e||{})[currentTabId+":crosspageConv"])&&(e=e.filter(e=>"system"===e[0]),(t={})[currentTabId+":crosspageConv"]=e,await chrome.storage.session.set(t)),addChatItem("crossPageConversation",a.newTab.crossPageConversationHint,"cyprite")}else"instantTranslation"===currentMode&&addChatItem("instantTranslation",a.translation.instantTranslateHint,"cyprite")},ActionCenter.showArticleChooser=()=>{var e=document.body.querySelector(".panel_container");e&&(e.setAttribute("showMask","showArticleList"),e.setAttribute("showArticleList","true"))},ActionCenter.hideFloatWindow=()=>{var e,t=document.body.querySelector(".panel_container");t&&(e=t.getAttribute("showMask"))&&(t.removeAttribute("showMask"),t.removeAttribute(e))},ActionCenter.sendMessage=async e=>{running=!0;var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],a=e.getAttribute("target"),r=e.parentNode.querySelector(".input_container"),n=e.parentNode.querySelector(".input_sender"),i=e.parentNode.querySelector(".content_container")||e.parentNode.parentNode.querySelector(".content_container"),e=getPageContent(r,!0);if(e){var o,s,l=addChatItem(a,e,"human",null,!0);if(r.innerText=t.conversation.waitForAI,r.setAttribute("contenteditable","false"),wait(60).then(()=>{onInputFinish(r,n,i)}),"crossPageConversation"===a){(o=await prepareXPageConv(e))[o.length-1].push(l);try{s=await askAIandWait("crossPageConversation",o)}catch(e){s=null,Notification.show(t.cypriteName,e,"middleTop","error",5e3)}s?o.push(["ai",s]):o.pop()}else if("instantTranslation"===a){var c=document.body.querySelector('[name="translation_language"]').value,c=chooseTargetLanguage(c);try{s=await askAIandWait("translateSentence",{lang:c,content:e})}catch(e){s=null,Notification.show(t.cypriteName,e,"middleTop","error",5e3)}}else if("intelligentSearch"===a){(o=advSearchConversation||[]).push(["human",e]),console.log(e,advSearchConversation);try{s=await askAIandWait("crossPageConversation",o)}catch(e){s=null,Notification.show(t.cypriteName,e,"middleTop","error",5e3)}console.log("AISEARCH GOT REPLY:",s),s?o.push(["ai",s]):o.pop(),console.log(e,advSearchConversation)}else console.log(a),await wait(3e3),s="哇哈哈哈哈哈哈";l=addChatItem(a,s,"cyprite",null,!0),o&&(o[o.length-1].push(l),"crossPageConversation"===a)&&((c={})[currentTabId+":crosspageConv"]=o,chrome.storage.session.set(c)),r.innerText="",r.setAttribute("contenteditable","true"),r.focus(),running=!1}},ActionCenter.copyContent=async(e,t)=>{var a=(a=e.parentNode.parentNode.querySelector(".chat_content")._data)||getPageContent(e,!0),e=(await navigator.clipboard.writeText(a),I18NMessages[myInfo.lang]||I18NMessages[DefaultLang]);Notification.show(e.cypriteName,e.mentions.contentCopied,"middleTop","success",2e3),t.inputter.focus()},ActionCenter.deleteConversation=async(t,a)=>{var r=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(r.cypriteName,r.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var[t,n]=getDialogPair(t);if("crossPageConversation"===a.frame.parentNode.getAttribute("group")){a=currentTabId+":crosspageConv";let e=await chrome.storage.session.get(a);(e=(e||{})[a])&&(e=e.filter(e=>!n.includes(e[2])),t.forEach(e=>e.parentNode.removeChild(e)),(t={})[a]=e,await chrome.storage.session.set(t),Notification.show(r.cypriteName,r.crossPageConv.hintConversationDeleted,"middleTop","success",2e3))}}},ActionCenter.reAnswerRequest=async(i,o)=>{var s=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(s.cypriteName,s.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var[i,l]=getDialogPair(i);if("crossPageConversation"===o.frame.parentNode.getAttribute("group")){o=currentTabId+":crosspageConv";let n=await chrome.storage.session.get(o);if(n=(n||{})[o]){let a=[],r;if(n.some((e,t)=>(a.push(e),r=n[t+1],l.includes(e[2]))),r){running=!0;let t,e;e=Notification.show(s.cypriteName,s.conversation.waitForAI,"middleTop","message",864e5);try{t=await askAIandWait("crossPageConversation",a)}catch(e){t=null,Notification.show(s.cypriteName,e,"middleTop","error",5e3)}e._hide(),t?(r[1]=t,(i=i[1].querySelector(".chat_content")).innerHTML=marked.parse(t,{breaks:!0})||s.conversation.AIFailed,i._data=t,(i={})[o]=n,await chrome.storage.session.set(i),Notification.show(s.cypriteName,s.crossPageConv.hintRefreshSuccess,"middleTop","success",2e3)):Notification.show(s.cypriteName,s.crossPageConv.hintRefreshFailed,"middleTop","error",2e3),running=!1}}}}},ActionCenter.changeRequest=async(e,t)=>{var c=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];if(running)Notification.show(c.cypriteName,c.mentions.actionWhileRunning,"middleTop","warn",2e3);else{var e=e.parentNode.parentNode,d=e.getAttribute("chatID");if("crossPageConversation"===t.frame.parentNode.getAttribute("group")){let a=currentTabId+":crosspageConv",r=await chrome.storage.session.get(a);if(!(r=(r||{})[a]))return;let n,i=(r.some(e=>(n=e)[2]===d),e=>{var t=!1;"Escape"===e.key?(o.innerHTML=s,t=!0):"Enter"===e.key&&e.ctrlKey&&((e=getPageContent(o))?(o.innerHTML=marked.parse(e,{breaks:!0}),o._data=e,n[1]=e,(e={})[a]=r,chrome.storage.session.set(e).then(()=>{Notification.show(c.cypriteName,c.crossPageConv.hintChangeDialogSuccess,"middleTop","success",2e3)})):o.innerHTML=s,t=!0),t&&(o.contentEditable=!1,o.removeEventListener("keyup",i),l._hide())}),o=e.querySelector(".chat_content"),s=o.innerHTML,l=(o.addEventListener("keyup",i),o.innerText=o._data,o.contentEditable=!0,Notification.show(c.cypriteName,c.crossPageConv.hintModifyContent,"middleTop","mention",864e5));o.focus()}}},ActionCenter.onMayCopySearchResult=async(e,t,a)=>{"copySearchResult"===a.target.getAttribute("action")&&(await navigator.clipboard.writeText(searchResult),a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],Notification.show(a.cypriteName,a.mentions.contentCopied,"middleTop","success",2e3))},window.addEventListener("beforeunload",()=>{chrome.storage.session.remove(currentTabId+":crosspageConv")}),window.addEventListener("resize",resizeCurrentInputter),async()=>{var e=await Promise.all([chrome.storage.local.get("FilesOrderType"),getSearchRequestList(),getConfig()]);if(isArray(e[1])){let a=document.body.querySelector(".search_history");e[1].forEach(e=>{var t=newEle("li","search_result_item","more_question");t.innerText=e,t._question=e,a.appendChild(t)})}(e=(e[0]||{}).FilesOrderType)&&OrderTypes[e]&&(orderType=e),await getConfig(),updateAIModelList();e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],AIModelList=document.body.querySelector(".panel_model_chooser"),aiSearchInputter=document.body.querySelector(".panel_operation_area .search_inputter > div.inner"),await generateModelList(""),document.body.querySelector('input[name="translation_language"]').value=LangName[myInfo.lang],renderI18N("newTab"),document.querySelector("html").setAttribute("lang",myInfo.lang),setGroupSwitcher(),AIModelList.addEventListener("click",onChooseModel),document.body.querySelector(".result_panel .reference_panel").addEventListener("click",onSelectReference),registerAction(),[...document.body.querySelectorAll('[type="conversationArea"]')].forEach(e=>{var t,a=e.querySelector(".content_container"),r=e.querySelector(".input_container"),n=e.querySelector(".input_sender");r.addEventListener("keyup",e=>{e.ctrlKey&&"Enter"===e.key&&ActionCenter.sendMessage(n),t=t||setTimeout(()=>{onInputFinish(r,n,a),t=null},300)}),r.addEventListener("paste",onContentPaste),a.addEventListener("click",({target:e})=>{var t=e.getAttribute("action");t&&(t=ActionCenter[t])&&t(e,{frame:a,inputter:r,sender:n})})}),document.body.querySelector(".panel_article_list").addEventListener("click",onSelectArticleItem),aiSearchInputter.addEventListener("paste",onContentPaste),aiSearchInputter.addEventListener("keyup",e=>{e.ctrlKey&&"Enter"===e.key&&ActionCenter.startAISearch()}),document.body.querySelector(".articleManagerFileList").addEventListener("click",onClickFileItemOperator),addChatItem("crossPageConversation",e.newTab.crossPageConversationHint,"cyprite"),addChatItem("instantTranslation",e.translation.instantTranslateHint,"cyprite"),aiSearchInputter.parentNode.querySelector('.mode_chooser > li[mode="'+myInfo.searchMode+'"]').setAttribute("checked","true"),e=await chrome.tabs.getCurrent();currentTabId=e.id;e=(await chrome.storage.session.get(currentTabId+":mode"))[currentTabId+":mode"]||DefaultPanel;changeTab(e)});window.onload=init;