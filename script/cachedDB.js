globalThis.CachedDB=class{constructor(e,r){this._name=e,this._version=r,this.conn=null,this.db=null,this.cbUpdates=[],this.cbConnects=[],this.ready=!1,this.available=!1}connect(){return new Promise((r,t)=>{this.conn=indexedDB.open(this.name,this.version),this.conn.onupgradeneeded=e=>{this.db=this.conn.result,this.cbUpdates.forEach(e=>e(this))},this.conn.onsuccess=e=>{this.ready=!0,this.available=!0,this.db=this.conn.result,this.cbConnects.forEach(e=>e(this)),r(this)},this.conn.onerror=e=>{this.ready=!0,this.available=!1,t(e)}})}onConnect(e){this.cbConnects.push(e)}onUpdate(e){this.cbUpdates.push(e)}open(e,t="id",n){if(!this.db.objectStoreNames.contains(e)){let r=this.db.createObjectStore(e,{keyPath:t});r.createIndex(t,t,{unique:!0}),n&&0<n.length&&n.forEach(e=>{r.createIndex(e,e,{unique:!1})})}}set(s,a,o){return new Promise((r,t)=>{var e=this.db.transaction([s],"readwrite"),e=(e||t(new Error("Open IndexedDB Transaction Failed: "+s)),e.objectStore(s)),n=(s||t(new Error("Open IndexedDB ObjectStore Failed: "+s)),{}),e=([...e.indexNames].forEach(e=>{n[e]=o[e]}),n[e.keyPath]=a,n.data=o,e.put(n));e.onsuccess=e=>{r(e.result)},e.onerror=e=>{t(e)}})}get(n,s){return new Promise((r,t)=>{var e=this.db.transaction([n],"readonly"),e=(e||t(new Error("Open IndexedDB Transaction Failed: "+n)),e.objectStore(n));n||t(new Error("Open IndexedDB ObjectStore Failed: "+n));e=e.index(e.keyPath).get(s);e.onsuccess=e=>{e.target.result?r(e.target.result.data):r(void 0)},e.onerror=e=>{t(e)}})}all(a,o){return new Promise((n,r)=>{var e,t=this.db.transaction([a],"readonly"),s=(t||r(new Error("Open IndexedDB Transaction Failed: "+a)),t.objectStore(a));a||r(new Error("Open IndexedDB ObjectStore Failed: "+a));try{e=s.index(o||s.keyPath)}catch(e){return void r(e)}t=e.getAll();t.onsuccess=e=>{e=e.target.result;if(!e)return n(e);var r=!o||o===s.keyPath,t=r?{}:[];e.forEach(e=>{r?t[e[s.keyPath]]=e.data:t.push(e.data)}),n(t)},t.onerror=e=>{r(e)}})}del(n,s){return new Promise((r,t)=>{var e=this.db.transaction([n],"readwrite"),e=(e||t(new Error("Open IndexedDB Transaction Failed: "+n)),e.objectStore(n)),e=(n||t(new Error("Open IndexedDB ObjectStore Failed: "+n)),e.delete(s));e.onsuccess=e=>{r(e.result)},e.onerror=e=>{t(e)}})}clear(n){return new Promise((r,t)=>{var e=this.db.transaction([n],"readwrite"),e=(e||t(new Error("Open IndexedDB Transaction Failed: "+n)),e.objectStore(n)),e=(n||t(new Error("Open IndexedDB ObjectStore Failed: "+n)),e.clear());e.onsuccess=e=>{r(e.result)},e.onerror=e=>{t(e)}})}get name(){return this._name}get version(){return this._version}};