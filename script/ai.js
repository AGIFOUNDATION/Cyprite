import"./ai/prompts.js";import"./ai/gemini.js";import"./ai/claude.js";import"./ai/gpt.js";let ResMap=new Map,EmbeddingLimit=2024;var embedAIModel=AI.Gemini.embed,synchronousCount=0;globalThis.AIUsage={request:0,input:0,output:0},globalThis.showAIUsage=()=>{logger.log("AI USAGE","RequestCount: "+AIUsage.request,"OutputToken: "+AIUsage.output,"InputToken: "+AIUsage.input)},globalThis.resetAIUsage=()=>{AIUsage.request=0,AIUsage.input=0,AIUsage.output=0},globalThis.callAIandWait=(r,i)=>new Promise(async(t,a)=>{myInfo.inited||await getWSConfig();var s,n=newID();if(console.log("========>",JSON.parse(JSON.stringify(myInfo))),ForceBackend)if(sendMessage===DefaultSendMessage)a("No AI Server Available");else try{t(await callServer(r,i))}catch(e){a(e)}else{let e=!0;if(!myInfo.useLocalKV&&sendMessage!==DefaultSendMessage){e=!1;try{t(await callServer(r,i))}catch{e=!0}}e&&(myInfo.edgeAvailable?(s=EdgedAI[r])?(ResMap.set(n,[t,a]),s(n,i)):(t="NO such action: "+r,logger.error("AI",t),a(t)):(s=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],console.error(s.noAPIKey,JSON.parse(JSON.stringify(myInfo))),chrome.notifications.create({title:s.cypriteName,message:s.noAPIKey,type:"basic",iconUrl:"/images/icon1024.png"}),a(s.noAPIKey)))}});let replyRequest=(e,t,a)=>{var s=ResMap.get(e);s&&(ResMap.delete(e),a?s[1](a):s[0](t))},splitParagraph=(s,e)=>{var n=[],r=0;return(s="\n"+s).replace(new RegExp("\\n"+e+"\\s+","gi"),(e,t)=>{var a=s.substring(r,t);r=t,a=a.trim(),n.push(a)}),n.push(s.substring(r).trim()),n=(n=n.filter(e=>!!e)).map(e=>e.length>EmbeddingLimit?[!1,e]:[!0,e])},splitSentence=(s,e,a=!1)=>{var n=[],r=0,i=(s.replace(e,(e,...t)=>{t.some(e=>{if(isNumber(e))return a=e,!0}),a+=e.length;var a,t=s.substring(r,a);r=a,n.push(t)}),n.push(s.substring(r)),n=n.filter(e=>!!e.trim()),[]),l=0,o="",m=a?1:0;return n.forEach(e=>{var t=e.length;t>EmbeddingLimit?(i.push([!0,o.trim()]),o="",l=0,i.push([!1,e.trim()])):l=l+t+m>EmbeddingLimit?(i.push([!0,o.trim()]),o=e,t):(a?o=o+"\n"+e:o+=e,o.length)}),o.trim()&&i.push([!0,o.trim()]),i},batchize=e=>e=(e=(e=(e=splitParagraph(e,"#")).map(e=>e[0]?e[1]:e=(e=splitParagraph(e[1],"##")).map(e=>e[0]?e[1]:e=(e=splitParagraph(e[1],"###")).map(e=>e[0]?e[1]:e=(e=splitParagraph(e[1],"####")).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/(\r*\n\r*)+/g,!0)).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/[\.\?\!。？！…]['"’”]?/gi)).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/[,;，；]['"’”]?\s*/gi)).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/\s+/gi)).map(t=>{if(t[0])return t[1];t=t[1];var a=[],s=Math.ceil(t.length/EmbeddingLimit),n=Math.ceil(t.length/s);for(let e=0;e<s;e++){var r=e*n,r=t.substring(r,r+n);a.push(r)}return a}))))))))).flat(1/0)).filter(e=>!!e),callEdgeAI=async(e,t,a)=>{if(t=t.map(e=>[...e]),a=a||myInfo.model,console.log("xxxxxxxxxxxxxxxxx    1",a),a){var s,n,r=Model2AI[a],r=(console.log("xxxxxxxxxxxxxxxxx    2",r),AI[r]);if(console.log("xxxxxxxxxxxxxxxxx    3",r),r=r&&r.chat,console.log("xxxxxxxxxxxxxxxxx    4",r),r){synchronousCount++,logger.strong("AI-Start","Synchronous: "+synchronousCount);try{s=await r(t,a)}catch(e){n=isString(e)?new Error(e):e,s=null}synchronousCount--,logger.strong("AI-Finish","Synchronous: "+synchronousCount),replyRequest(e,s,n)}else replyRequest(e,null,new Error("No AI for Model "+a))}else replyRequest(e,null,new Error("AI Model not set."))},EdgedAI={sayHello:async e=>{return;var t=PromptLib.assemble(PromptLib.sayHello,{lang:LangName[myInfo.lang],name:myInfo.name,info:myInfo.info,time:timestmp2str(Date.now(),"YY年MM月DD日 :WDE: hh:mm")});callEdgeAI(e,[["human",t]])},summarizeArticle:async(e,t)=>{t=PromptLib.assemble(PromptLib.summarizeArticle,{article:t,lang:LangName[myInfo.lang]});callEdgeAI(e,[["human",t]])},embeddingArticle:async(e,a)=>{var t,s,n=[],r=a.article||a.summary;r.length>EmbeddingLimit?(r=batchize(r)).forEach((e,t)=>{n.push({title:a.title+"-"+(t+1),content:e})}):n.push({title:a.title,content:r});try{t=await embedAIModel(n)}catch(e){console.error(e),s=isString(e)?new Error(e):e}replyRequest(e,t,s)},findRelativeArticles:async(e,t)=>{var a,s=[],t=(s.push(["system",PromptLib.assemble(PromptLib.findRelativeArticlesSystem,t)]),s.push(["human",PromptLib.assemble(PromptLib.findRelativeArticlesRunning,t)]),Model2AI[myInfo.model]);(a=t?FastAI[t]:a)?callEdgeAI(e,s,a):replyRequest(e,null,new Error("No AI for Model "+t))},findRelativeWebPages:async(e,t)=>{var a,s=[],t=(s.push(["system",PromptLib.assemble(PromptLib.findRelativeWebPagesSystem,t)]),s.push(["human",PromptLib.assemble(PromptLib.findRelativeWebPagesRunning,t)]),Model2AI[myInfo.model]);(a=t?FastAI[t]:a)?callEdgeAI(e,s,a):replyRequest(e,null,new Error("No AI for Model "+t))},directAskAI:async(e,t)=>{callEdgeAI(e,t,myInfo.model)},translateSentence:async(e,t)=>{var a=[];a.push(["human",PromptLib.assemble(PromptLib.instantTranslation,t)]),callEdgeAI(e,a)}};