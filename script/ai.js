import"./ai/prompts.js";import"./ai/gemini.js";import"./ai/claude.js";import"./ai/gpt.js";let ResMap=new Map,EmbeddingLimit=2024;var embedAIModel=AI.Gemini.embed,synchronousCount=0;globalThis.AIUsage={request:0,input:0,output:0},globalThis.showAIUsage=()=>{logger.log("AI USAGE","RequestCount: "+AIUsage.request,"OutputToken: "+AIUsage.output,"InputToken: "+AIUsage.input)},globalThis.resetAIUsage=()=>{AIUsage.request=0,AIUsage.input=0,AIUsage.output=0},globalThis.callAIandWait=(i,r)=>new Promise(async(t,s)=>{var a=newID();if(console.log("========>",JSON.parse(JSON.stringify(myInfo))),ForceBackend)if(sendMessage===DefaultSendMessage)s("No AI Server Available");else try{t(await callServer(i,r))}catch(e){s(e)}else{let e=!0;if(!myInfo.useLocalKV&&sendMessage!==DefaultSendMessage){e=!1;try{t(await callServer(i,r))}catch{e=!0}}if(e)if(myInfo.edgeAvailable){var n=EdgedAI[i];n?(ResMap.set(a,[t,s]),n(a,r)):(t="NO such action: "+i,logger.error("AI",t),s(t))}else{console.error(e.noAPIKey,JSON.parse(JSON.stringify(myInfo)));let e=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];chrome.notifications.create({title:e.cypriteName,message:e.noAPIKey,type:"basic",iconUrl:"/images/icon1024.png"}),s(e.noAPIKey)}}});let replyRequest=(e,t,s)=>{var a=ResMap.get(e);a&&(ResMap.delete(e),s?a[1](s):a[0](t))},splitParagraph=(a,e)=>{var n=[],i=0;return(a="\n"+a).replace(new RegExp("\\n"+e+"\\s+","gi"),(e,t)=>{var s=a.substring(i,t);i=t,s=s.trim(),n.push(s)}),n.push(a.substring(i).trim()),n=(n=n.filter(e=>!!e)).map(e=>e.length>EmbeddingLimit?[!1,e]:[!0,e])},splitSentence=(a,e,s=!1)=>{var n=[],i=0,r=(a.replace(e,(e,...t)=>{t.some(e=>{if(isNumber(e))return s=e,!0}),s+=e.length;var s,t=a.substring(i,s);i=s,n.push(t)}),n.push(a.substring(i)),n=n.filter(e=>!!e.trim()),[]),l=0,o="",m=s?1:0;return n.forEach(e=>{var t=e.length;t>EmbeddingLimit?(r.push([!0,o.trim()]),o="",l=0,r.push([!1,e.trim()])):l=l+t+m>EmbeddingLimit?(r.push([!0,o.trim()]),o=e,t):(s?o=o+"\n"+e:o+=e,o.length)}),o.trim()&&r.push([!0,o.trim()]),r},batchize=e=>e=(e=(e=(e=splitParagraph(e,"#")).map(e=>e[0]?e[1]:e=(e=splitParagraph(e[1],"##")).map(e=>e[0]?e[1]:e=(e=splitParagraph(e[1],"###")).map(e=>e[0]?e[1]:e=(e=splitParagraph(e[1],"####")).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/(\r*\n\r*)+/g,!0)).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/[\.\?\!。？！…]['"’”]?/gi)).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/[,;，；]['"’”]?\s*/gi)).map(e=>e[0]?e[1]:e=(e=splitSentence(e[1],/\s+/gi)).map(t=>{if(t[0])return t[1];t=t[1];var s=[],a=Math.ceil(t.length/EmbeddingLimit),n=Math.ceil(t.length/a);for(let e=0;e<a;e++){var i=e*n,i=t.substring(i,i+n);s.push(i)}return s}))))))))).flat(1/0)).filter(e=>!!e),callEdgeAI=async(e,t,s)=>{if(s=s||myInfo.model){console.log("xxxxxxxxxxxxxxxxx    1",s);var a,n,i=Model2AI[s],r=(console.log("xxxxxxxxxxxxxxxxx    2",i),AI[i]);if(console.log("xxxxxxxxxxxxxxxxx    3",r),r=r&&r.chat,console.log("xxxxxxxxxxxxxxxxx    4",r),r){synchronousCount++,logger.strong("AI-Start","Synchronous: "+synchronousCount);try{a=await r(t,s)}catch(e){n=e.message||e.msg||e.data||(e.toString?e.toString():e||i+" Error"),a=null}synchronousCount--,logger.strong("AI-Finish","Synchronous: "+synchronousCount),replyRequest(e,a,n)}else replyRequest(e,null,"No AI for Model "+s)}else replyRequest(e,null,"AI Model not set.")},EdgedAI={sayHello:async e=>{var t=PromptLib.assemble(PromptLib.sayHello,{lang:LangName[myInfo.lang],name:myInfo.name,info:myInfo.info,time:timestmp2str(Date.now(),"YY年MM月DD日 :WDE: hh:mm")});callEdgeAI(e,[["human",t]])},summarizeArticle:async(e,t)=>{t=PromptLib.assemble(PromptLib.summarizeArticle,{article:t,lang:LangName[myInfo.lang]});callEdgeAI(e,[["human",t]])},embeddingArticle:async(e,s)=>{var t,a,n=[],i=s.article||s.summary;i.length>EmbeddingLimit?(i=batchize(i)).forEach((e,t)=>{n.push({title:s.title+"-"+(t+1),content:e})}):n.push({title:s.title,content:i});try{t=await embedAIModel(n)}catch(e){console.error(e),a=e.message||e.msg||e.data||(e.toString?e.toString():e||"Gemini Error")}replyRequest(e,t,a)},findRelativeArticles:async(e,t)=>{var s=[],t=(s.push(["system",PromptLib.assemble(PromptLib.findRelativeArticlesSystem,t)]),s.push(["human",PromptLib.assemble(PromptLib.findRelativeArticlesRunning,t)]),Model2AI[myInfo.model]);(t=t&&FastAI[t])?callEdgeAI(e,s,t):replyRequest(e,null)},findRelativeWebPages:async(e,t)=>{var s=[],t=(s.push(["system",PromptLib.assemble(PromptLib.findRelativeWebPagesSystem,t)]),s.push(["human",PromptLib.assemble(PromptLib.findRelativeWebPagesRunning,t)]),Model2AI[myInfo.model]);(t=t&&FastAI[t])?callEdgeAI(e,s,t):replyRequest(e,null)},directAskAI:async(e,t)=>{callEdgeAI(e,t,myInfo.model)},translateContent:async(e,t)=>{var s=[];s.push(["system",PromptLib.assemble(PromptLib.translationSystem,t)]),s.push(["human",PromptLib.assemble(PromptLib.translationRunning,t)]),callEdgeAI(e,s)},translateSentence:async(e,t)=>{var s=[];s.push(["system",PromptLib.assemble(PromptLib.instantTranslationSystem,t)]),s.push(["human",PromptLib.assemble(PromptLib.instantTranslationRunning,t)]),callEdgeAI(e,s)}};