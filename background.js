import"./components/jsrsasign.all.min.js";import"./script/i18n.js";import"./script/ai/config.js";import"./script/common.js";import"./script/cachedDB.js";import"./script/ai.js";let UtilList={notification:{js:["/components/notification.js"],css:["/components/notification.css","/components/mention.css"]},panel:{js:["/components/marked.min.js","/pages/inner.js"],css:["/components/panel.css"]}},SimilarLimit=20,updateAIModelList=(globalThis.myInfo={inited:!1,useLocalKV:!0,apiKey:"",lang:DefaultLang,name:"主人",info:"(Not set yet)",model:ModelList[0]},()=>{var e,a=!1;for(e in ModelList.splice(0),myInfo.apiKey)myInfo.apiKey[e]&&(a=!0,AI2Model[e])&&ModelList.push(...AI2Model[e]);myInfo.edgeAvailable=a}),callLLMOneByOne=(globalThis.getWSConfig=async()=>{var[e,a]=await Promise.all([chrome.storage.local.get(["wsHost","apiKey","AImodel"]),chrome.storage.sync.get(["name","info","lang"])]),t=(logger.em("EXT","Config Loaded"),[]);return myInfo.inited=!0,myInfo.name=a.name||myInfo.name,myInfo.info=a.info||myInfo.info,myInfo.lang=a.lang,myInfo.lang&&(myInfo.lang=myInfo.lang.toLowerCase(),i18nList.includes(myInfo.lang))||(myInfo.lang=DefaultLang),myInfo.lang!==a.lang&&t.push(chrome.storage.sync.set({lang:myInfo.lang})),myInfo.apiKey=e.apiKey||{},isString(myInfo.apiKey)&&(a={},myInfo.apiKey&&(a.gemini=myInfo.apiKey),myInfo.apiKey=a,t.push(chrome.storage.local.set({apiKey:myInfo.apiKey}))),myInfo.useLocalKV=!ForceBackend&&!e.wsHost,myInfo.model=e.AImodel||myInfo.model||ModelList[0],updateAIModelList(),logger.em("EXT",myInfo),0<t.length&&await Promise.all(t),e.wsHost},async(e,a,t=!0,n="CallAI")=>{var i,r;for(r of e){var s=Date.now();try{i=await callAIandWait("directAskAI",{conversation:a,model:r})}catch(e){i=null,logger.error(n+": "+r,e);continue}s=Date.now()-s,logger.info(n,r+" : "+s+"ms"),t&&(i=parseReplyAsXMLToJSON(i));break}return i}),DBs={},initDB=async()=>{let e=new CachedDB("PageInfos",1);e.onUpdate(()=>{e.open("tabInfo","tid"),e.open("pageInfo","url"),e.open("notifyChecker","url"),e.open("pageConversation","url"),logger.info("DB","Updated")}),e.onConnect(()=>{globalThis.dbPageInfos=e,logger.info("DB","Connected")}),await e.connect(),DBs.pageInfo=e},gotoUniquePage=(globalThis.DefaultSendMessage||(globalThis.DefaultSendMessage=()=>{}),globalThis.sendMessage||(globalThis.sendMessage=DefaultSendMessage),async e=>{console.log(">>>>>>>>>>>>>>>>    1",e);var a=(a=await chrome.tabs.query({url:e}))&&a[0];return console.log(">>>>>>>>>>>>>>>>    2",a),a?(console.log(">>>>>>>>>>>>>>>>    4"),await chrome.tabs.update(a.id,{active:!0,highlighted:!0})):(console.log(">>>>>>>>>>>>>>>>    3"),a=await chrome.tabs.create({url:e})),a}),configureCyberButler=()=>{gotoUniquePage(chrome.runtime.getURL("pages/config.html"))},showSystemNotification=(globalThis.checkAvailability=async()=>{myInfo.inited||await getWSConfig();var e=!0;return(e=myInfo.useLocalKV?myInfo.edgeAvailable:!!await getWSConfig())||configureCyberButler(),e},e=>{var a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];isString(e)||(e=e.message||e.msg||e.data||e.toString()),chrome.notifications.create({title:a.cypriteName,message:e,type:"basic",iconUrl:"/images/cyprite.png"})}),isPageForbidden=(chrome.runtime.onInstalled.addListener(async()=>{var e,a,t=(await chrome.storage.sync.get("lang")).lang||DefaultLang,t=(I18NMessages[t]||I18NMessages[DefaultLang]).contextMenus,t=(chrome.contextMenus.create({id:"launchCyprite",title:t.launch,contexts:["all"]}),chrome.contextMenus.create({id:"translateSelection",title:t.translate,contexts:["selection"]}),chrome.contextMenus.create({id:"autoWrite",title:t.autoWrite,contexts:["editable"],enabled:!1}),chrome.runtime.getManifest().content_scripts);for(e of t)for(a of await chrome.tabs.query({url:e.matches}))if(!a.url.match(/^chrome/i))try{await chrome.scripting.executeScript({files:e.js,target:{tabId:a.id,allFrames:e.all_frames},injectImmediately:"document_start"===e.run_at})}catch{}}),chrome.storage.local.onChanged.addListener(e=>{e.AImodel?.newValue&&(myInfo.model=e.AImodel.newValue)}),chrome.storage.sync.onChanged.addListener(e=>{e.lang?.newValue&&(e=e.lang.newValue||myInfo.lang,e=(I18NMessages[e]||I18NMessages[DefaultLang]).contextMenus,chrome.contextMenus.update("launchCyprite",{title:e.launch}),chrome.contextMenus.update("translateSelection",{title:e.translate}),chrome.contextMenus.update("autoWrite",{title:e.autoWrite}))}),e=>!e||0===e.indexOf("chrome://")),onPageActivityChanged=async(a,t)=>{if(a){var n=await getTabInfo(a);if(n.active){if("show"===t)return}else if("hide"===t)return;try{i=await chrome.tabs.get(a)}catch{i=null}if(!i){if(await delTabInfo(a),"close"!==t)return;i={}}var{title:i,url:r,active:e}=i,s=Date.now();if(["open","show","active","update","loaded"].includes(t))if(e)if(isPageForbidden(r))await inactivePage(n,s,!0);else{let e="open"===t;r!==n.url&&(e=!0,await inactivePage(n,s,!0)),n.active&&"open"!==t||(n.open=s),n.title||(n.title=i),n.active=!0,n.url=r,e&&n.isArticle&&!n.requested&&(n.requested=!0,dispatchEvent({event:"requestCypriteNotify",target:"FrontEnd",tid:a})),await setTabInfo(a,n)}else await inactivePage(n,s);else["hide","idle"].includes(t)?await inactivePage(n,s):"close"===t&&(await inactivePage(n,s,!0),await delTabInfo(a))}},inactivePage=async(e,a,t=!1)=>{var n=!!e.url;0<e.open?e.duration+=a-e.open:n=!1,e.open=-1,e.active=!1,n&&await onPageDurationUpdated(t,e.url,e.duration,e.title),t&&(e.duration=0)},onPageDurationUpdated=async(e,a,t,n)=>{logger.log("PageActivity","Save Data: "+a),await savePageActivities(a,t,n,e);try{sendMessage("SavePageActivity",{url:a,duration:t,title:n,closed:e},"BackEnd")}catch{}},savePageActivities=async(e,a,t,n)=>{var i=await getPageInfo(e);i.reading=!n,i.title||(i.title=t),i.viewed++,i.totalDuration+=a,i.currentDuration=a,i.timestamp=timestmp2str("YYYY/MM/DD hh:mm:ss :WDE:"),console.log(i),await setPageInfo(e,i)},getPageInfo=async e=>{if(e.match(/^chrome/i))return{totalDuration:0,viewed:0};e=parseURL(e);var a=TabInfo[e];return a||(DBs.pageInfo||await initDB(),a=await DBs.pageInfo.get("pageInfo",e),logger.log("DB","Get Page Info: "+e),a=a||{totalDuration:0,viewed:0}),a},setPageInfo=async(e,a,t=!1)=>{e.match(/^chrome/i)||(a.url=e,e=parseURL(e),DBs.tmrPageInfos&&clearTimeout(DBs.tmrPageInfos),t?(delete DBs.tmrPageInfos,DBs.pageInfo||await initDB(),await DBs.pageInfo.set("pageInfo",e,a),logger.log("DB","Set Page Info: "+e)):DBs.tmrPageInfos=setTimeout(async()=>{delete DBs.tmrPageInfos,DBs.pageInfo||await initDB(),await DBs.pageInfo.set("pageInfo",e,a),logger.log("DB","Set Page Info: "+e)},200))},delPageInfo=async(e,a=!1)=>{var t=parseURL(e);DBs.tmrPageInfos&&clearTimeout(DBs.tmrPageInfos),a?(delete DBs.tmrPageInfos,delete TabInfo[t],DBs.pageInfo||await initDB(),await DBs.pageInfo.del("pageInfo",t),logger.log("DB","Del Page Info: "+t)):DBs.tmrPageInfos=setTimeout(async()=>{delPageInfo(e,!0)},200)},getTabInfo=async e=>{var a=TabInfo[e];return a||(DBs.pageInfo||await initDB(),DBs.pageInfo&&(a=await DBs.pageInfo.get("tabInfo","T-"+e),logger.log("DB","Get TabInfo: "+e)),a=a||{active:!1,duration:0,open:-1}),a},setTabInfo=async(e,a)=>{TabInfo[e]=a,DBs.tmrTabInfos&&clearTimeout(DBs.tmrTabInfos),DBs.tmrTabInfos=setTimeout(async()=>{delete DBs.tmrTabInfos,DBs.pageInfo||await initDB(),await DBs.pageInfo.set("tabInfo","T-"+e,a),logger.log("DB","Set TabInfo: "+e)},200)},delTabInfo=async e=>{for(var a in delete TabInfo[e],DBs.tmrTabInfos&&(clearTimeout(DBs.tmrTabInfos),delete DBs.tmrTabInfos),DBs.pageInfo||await initDB(),await DBs.pageInfo.all("tabInfo")){var t=a.replace(/^T\-/,"");try{await chrome.tabs.get(+t)}catch{await DBs.pageInfo.del("tabInfo",a),logger.log("DB","Del TabInfo: "+t)}}},TabInfo={};var LastActiveTab=null;let TabPorts=new Map;chrome.tabs.onActivated.addListener(e=>{LastActiveTab=e.tabId,chrome.tabs.connect(LastActiveTab)}),chrome.tabs.onRemoved.addListener(e=>{LastActiveTab===e&&(LastActiveTab=null),onPageActivityChanged(e,"close"),removeAIChatHistory(e),chrome.storage.session.remove(e+":mode")}),chrome.idle.onStateChanged.addListener(e=>{logger.info("Ext","Idle State Changed: "+e),LastActiveTab&&("idle"===e?onPageActivityChanged(LastActiveTab,"idle"):(onPageActivityChanged(LastActiveTab,"active"),chrome.tabs.connect(LastActiveTab)))}),chrome.runtime.onMessage.addListener((e,a)=>{"PopupEnd"!==e.sender&&(a=a.tab?.id,e.sid=a,"me"===e.tid)&&(e.tid=a),dispatchEvent(e)}),chrome.runtime.onConnect.addListener(e=>{var a;"cyberbutler_contentscript"===e.name&&(a=e.sender?.tab?.id)&&(logger.info("PORT","Connect: "+a),TabPorts.set(a,e),e.onMessage.addListener(e=>{"PopupEnd"!==e.sender&&(e.sid=a,"me"===e.tid)&&(e.tid=a),dispatchEvent(e)}),e.onDisconnect.addListener(()=>{logger.info("PORT","Disconnect: "+a),TabPorts.delete(a)}))}),chrome.action.onClicked.addListener(async()=>{var e,a;await checkAvailability()&&([e]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0}),isPageForbidden(e?.url)?await gotoUniquePage(chrome.runtime.getURL("/pages/newtab.html")):((a=await getTabInfo(e.id)).requested=!0,await setTabInfo(e.id,a),dispatchEvent({event:"requestCypriteNotify",data:{forceShow:!0},target:"FrontEnd",tid:e.id})))}),chrome.contextMenus.onClicked.addListener((e,a)=>{0!==e.pageUrl.indexOf("chrome")&&0!==e.frameUrl.indexOf("chrome")&&dispatchEvent({event:"onContextMenuAction",data:{action:e.menuItemId,text:e.selectionText},target:"FrontEnd",tid:a.id})});var lastRequest=[];let EventHandler={},CacheLimit=(globalThis.dispatchEvent=async a=>{if(a.sender=a.sender||"BackEnd","ServerEnd"===a.target)try{sendMessage(a.event,a.data,a.sender,a.sid)}catch{}else if("FrontEnd"===a.target||"PageEnd"===a.target){let e=a.tid;if(e||([t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0}),t&&(e=t.id)),e=e||LastActiveTab){var t=TabPorts.get(e);if(t)try{await t.postMessage(a)}catch{}}}else if("BackEnd"===a.target){t=EventHandler[a.event];if(!t)return logger.log("SW","Got Event",a);t(a.data,a.sender,a.sid,a.target,a.tid)}else{t=a.tid;if(t)try{await chrome.tabs.sendMessage(t,a)}catch{}}},EventHandler.gotServerReply=e=>{e.ok?getReplyFromServer(e.taskId,e.data):getReplyFromServer(e.taskId,void 0,e.err)},EventHandler.SetConfig=async(e,a,t)=>{if("ConfigPage"===a&&(logger.log("WS","Set Host: "+e.wsHost),myInfo.name=e.name||"",myInfo.info=e.info||"",myInfo.lang=e.lang||DefaultLang,myInfo.apiKey=e.apiKey,myInfo.useLocalKV=!0,updateAIModelList(),myInfo.useLocalKV)){globalThis.sendMessage=DefaultSendMessage,chrome.tabs.sendMessage(t,{event:"connectWSHost",data:{wsHost:e.wsHost,ok:!0},target:a,sender:"BackEnd"});try{AIHandler.sayHello()}catch(e){logger.error("AI:SayHello",e)}}},EventHandler.PageStateChanged=async(e,a,t)=>{"FrontEnd"===a&&(logger.log("Page","State Changed: "+e.state),a=await getTabInfo(t),e&&e.pageInfo&&(a.title=e.pageInfo.title||a.title,a.isArticle=(isBoolean(e.pageInfo.isArticle)?e.pageInfo:a).isArticle,await setTabInfo(t,a)),onPageActivityChanged(t,e.state))},EventHandler.VisibilityChanged=(e,a,t)=>{"FrontEnd"===a&&onPageActivityChanged(t,e)},EventHandler.MountUtil=async(e,a,t)=>{var n;"FrontEnd"===a&&((a=UtilList[e])&&(n=[],a.css&&n.push(chrome.scripting.insertCSS({target:{tabId:t},files:a.css})),a.js&&n.push(chrome.scripting.executeScript({target:{tabId:t},files:a.js,injectImmediately:!0})),await Promise.all(n),logger.log("Page","Notification has mounted!")),dispatchEvent({event:"utilMounted",data:e,target:"FrontEnd",tid:t}))},EventHandler.AskAIAndWait=async(a,e,t)=>{lastRequest[0]=e,lastRequest[1]=t;var n={id:a.id},i="";if(a.action){var r=AIHandler[a.action];try{var s=await r(a.data,e,t);n.result=s,logger.log("AI","Task "+a.action+" Finished")}catch(e){n.result="",i=e.message||e.msg||e.data||e.toString?e.toString():e,logger.error("AI","Task "+a.action+" Failed:"),console.error(e),showSystemNotification(i)}}dispatchEvent({event:"replyAskAndWait",data:{ok:!i,data:n,error:i},target:e,tid:t})},EventHandler.AskSWAndWait=async(a,e,t)=>{lastRequest[0]=e,lastRequest[1]=t;var n={id:a.id},i="";if(a.action){var r=EventHandler[a.action];try{var s=await r(a.data,e,t);n.result=s,logger.log("SW","Task "+a.action+" Finished")}catch(e){n.result="",i=e.message||e.msg||e.data||e.toString?e.toString():e,logger.error("SW","Task "+a.action+" Failed:",i)}}dispatchEvent({event:"replyAskAndWait",data:{ok:!i,data:n,error:i},target:e,tid:t})},EventHandler.SavePageSummary=async(e,a,t)=>{var n=await getTabInfo(t),i=await getPageInfo(n.url);i.title||(i.title=e.title||i.title),e.content&&(i.content=e.content),i.description=e.summary||i.description,i.hash=e.hash||i.hash,i.embedding=e.embedding||i.embedding,await Promise.all([setTabInfo(t,n),setPageInfo(n.url,i)])},EventHandler.GotoConversationPage=async()=>{var e={};e[(await gotoUniquePage(chrome.runtime.getURL("/pages/newtab.html"))).id+":mode"]="crossPageConversation",await chrome.storage.session.set(e)},EventHandler.CalculateHash=async e=>{var a,t=e.content;return t?a=e.algorithm:t=e,calculateHash(t,a)},EventHandler.CheckPageNeedAI=async e=>getPageNeedAIInfo(e),EventHandler.UpdatePageNeedAIInfo=async e=>{var a=await getPageNeedAIInfo(e);a.page.visited++,a.path.visited++,a.host.visited++,e.need&&(a.page.need++,a.path.need++,a.host.need++),await updatePageNeedAIInfo(e,a)},EventHandler.LoadPageSummary=async(e,a,t)=>{t=await chrome.tabs.get(t);return t&&!isPageForbidden(t.url)?getPageInfo(t.url):null},EventHandler.FindSimilarArticle=async e=>{var a=e.vector,t=parseURL(e.url||"");if(!a)return[];DBs.pageInfo||await initDB();var n,i=await DBs.pageInfo.all("pageInfo"),r=[];for(n in i)if(n!==t){var s=i[n];if(s&&s.embedding&&(!e.needContent||s.content)){var o,l={};for(o in s)l[o]=s[o];var g=calculateSimilarityRate(l.embedding,a);0<(l.similar=g)&&r.push(l)}}return logger.log("SIMI",e.url||"(NONE)"),(r=r.filter(e=>.05<=e.similar)).sort((e,a)=>a.similar-e.similar),console.table(r.map(e=>({title:e.title,similar:e.similar}))),r},EventHandler.FindRelativeArticles=async(e,a,t)=>{if(e.url=parseURL(e.url||""),e.url){var n=RelativeHandler[t];if(n!==e.url){RelativeHandler[t]=e.url;var i,n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];e.isWebPage=!1,dispatchEvent({event:"updateCurrentStatus",data:n.crossPageConv.statusFindingSimilarFiles,target:a,tid:t});try{e.articles=await EventHandler.FindSimilarArticle(e),i=await findRelativeArticles(e,a,t)}catch{i=null}dispatchEvent({event:"updateCurrentStatus",target:a,tid:t}),i&&(dispatchEvent({event:"foundRelativeArticles",data:i,target:"FrontEnd",tid:t}),await wait(ColdDownDuration),logger.log("SW","Cold Down finished for "+e.url))}delete RelativeHandler[t]}},EventHandler.GetConversation=async e=>{e=parseURL(e),DBs.pageInfo||await initDB();e=await DBs.pageInfo.get("pageConversation",e);return e?e.conversation:null},EventHandler.ClearSummaryConversation=async e=>{e=parseURL(e);try{return DBs.pageInfo||await initDB(),await DBs.pageInfo.del("pageConversation",e),!0}catch{return!1}},EventHandler.GetArticleInfo=async e=>{DBs.pageInfo||await initDB();var a,t,n=await DBs.pageInfo.all("pageInfo"),n=Object.keys(n).map(e=>n[e]),i=null,r=!1;return isArray(e)?(a=e[0],t=e[1],!1===a?r=!1:!0!==a&&isArray(a)?(r=!0,i=a):r=!0):e||(r=!0),r&&(n=n.filter(e=>!!e.content&&!!e.hash)),i&&(n=n.filter(e=>i.includes(e.url))),"LastVisit"===t?(n.forEach(e=>{var a=e.timestamp;e._time=a?new Date(a.replace(/\s+[a-z]+$/i,"")).getTime():Date.now()}),n.sort((e,a)=>a._time-e._time)):n.sort((e,a)=>a.totalDuration-e.totalDuration),n},EventHandler.SearchGoogle=async e=>{e=encodeURIComponent(e);var{key:a,cx:t}=myInfo.apiKey?.google||{};if(a&&t){logger.log("GoogleSearch","Search By API");a=`https://www.googleapis.com/customsearch/v1?key=${myInfo.apiKey.google.key}&cx=${myInfo.apiKey.google.cx}&q=${e}&num=10&sort=date-sdate:d:s`;try{var r,n=await waitUntil(fetchWithCheck(a));r=(r=await n.json()).error?(logger.error("GoogleSearch["+r.error.code+"]",r.error.message),null):(logger.info("GoogleSearch",r),r.items?r.items.map(e=>({title:e.title,url:e.link,summary:(e.snippet||"").trim()})):null)}catch(e){logger.error("GoogleSearch",e),r=null}}if(!r){logger.log("GoogleSearch","Search Via Crab");t=`https://www.google.com/search?q=${e}&hl=en-US&start=0&num=10&ie=UTF-8&oe=UTF-8&gws_rd=ssl`;try{let n=await waitUntil(fetchWithCheck(t));for(n=(n=(n=await n.text()).replace(/<![^>]*?>/gi,"").replace(/<(noscript|script|title|style|header|footer|head|ul|ol)[\w\W]*?>[\w\W]*?<\/\1>/gi,"").replace(/<(meta|input|img)[\w\W]*?>/gi,"").replace(/<[^\/\\]*?[\/\\]>/gi,"").replace(/<\/?(html|body)[^>]*?>/gi,"").replace(/<\/?span[^>]*?>/gi,"").replace(/<\/?(div|br|hr)[^>]*?>/gi,"\n")).replace(/<a[^>]*href=('|")([^'"]*)\1[^>]*>([\w\W]*?)<\/a>/gi,(e,a,t,n)=>t.match(/^https?:\/\/.*?\.google/)||t.match(/^\s*\//)&&!t.match(/^\s*\/url\?/)?"":e);;){var s=n.replace(/<([\w\-_]+)[^>]*?>[\s\r\t\n]*<\/\1>/gi,"");if(n===s)break;n=s}n=n.replace(/^[\w\W]*?<a/i,"<a").replace(/Related searches[\w\W]*?$/i,"").replace(/[\s\r\t]*\n+[\s\r\t]*/g,"\n").replace(/\n+/g,"\n");let i=[];n.replace(/<a[^>]*?>[\s\r\n]*/gi,(e,a)=>{i.push(a)}),i.push(n.length);for(let t=0;t<i.length-1;t++){var o=i[t],l=i[t+1];let e=n.substring(o,l),a=e.match(/^[\s\r\n]*<a[^>]*?href=('|")?([^'"]*?)\1[^>]*?>/i);if(a&&a[2]&&(a=a[2]).match(/^(f|ht)tps?/)){var g,c=parseParams(a);for(g in c){var d=c[g];if(d.match(/^https?/i)){a=decodeURI(d);break}}e=e.replace(/<h3[^>]*>/gi,"\n  Title: ").replace(/<\/h3[^>]*>/gi,"\n  Description: ").replace(/<\/?\w+[^>]*?>/gi,"").replace(/[\s\r\t]*\n+[\s\r\t]*/g,"\n").replace(/\n+/g,"\n").replace(/^\n+|\n+$/g,"").replace(/\n  Title:\s*\n\s*/gi,"\n  Title: ").replace(/\n  Description:\s*\n\s*/gi,"\n  Description: ").replace(/&#(\d+);/g,(e,a)=>{var t;try{t=String.fromCharCode(+a)}catch{t=e}return t}),i[t]=[a,e]}}(i=i.filter(e=>isArray(e))).length?(r=[],i.forEach(e=>{var a,n;e&&e[0]&&(a=(a=(a=e[1]||"").split("\n")).map(e=>e.replace(/^\-\s*/,"\n  ")).join("\n  "),n={url:e[0]},a.replace(/Title:\s*([\w\W]*?)\s*Description:|Title:\s*([\w\W]*?)\s*$/i,(e,a,t)=>{a=a||t;a&&(n.title=a)}),a.replace(/Description:\s*([\w\W]*?)\s*Title:|Description:\s*([\w\W]*?)\s*$/i,(e,a,t)=>{a=a||t;a&&(n.summary=a)}),n.title||(n.title=e[1]||""),n.summary||(n.summary=e[1]||""),r.push(n))})):r=[]}catch(e){return logger.error("GoogleCrab",e),[]}}return r},EventHandler.ReadWebPage=async e=>{var a;try{a=await(a=await waitUntil(fetch(e))).text()}catch{return null}return a},EventHandler.RemovePageInfo=async e=>{await delPageInfo(e,!0)},EventHandler.RemovePageInfos=async e=>{DBs.pageInfo||await initDB();var a,t=await DBs.pageInfo.all("pageInfo"),n=(console.log(t),[]);for(a in t){var i=t[a];e?i.content||n.push(a):i.hash&&i.embedding||n.push(a)}console.log(n),await Promise.all(n.map(async e=>{await delPageInfo(e,!0)}))},EventHandler.ChangePageTitle=async e=>{var a=await getPageInfo(e.url);a.title=e.title,await setPageInfo(e.url,a,!0)},globalThis.AIHandler={},432e5),removeAIChatHistory=async e=>{var a,t=[];if(e&&(a=Tab2Article[e])){delete Tab2Article[e],DBs.pageInfo||await initDB();for(var n of a)t.push(DBs.pageInfo.del("pageConversation",n));t.length&&(await Promise.all(t),logger.log("Chat","Remove Inside Tab History:",a))}var i,t=[],r=Date.now(),s=(DBs.pageInfo||await initDB(),[]);for(i in a=await DBs.pageInfo.all("pageConversation"))r-a[i].timestamp>=CacheLimit&&(s.push(i),t.push(DBs.pageInfo.del("pageConversation",i)));t.length&&(await Promise.all(t),logger.log("Chat","Remove Expired History:",s))},parseReplyAsXMLToJSON=(r,e=!0)=>{var s={_origin:r.trim()},o=-1,l=0;let g=/<(\/?)([^>\n\r\t ]+?[^>\n\r]*?)>/gi;if(e){let i=[],n=0,e=(r.replace(g,(e,a,t)=>{(a=!!a)?n--:n++,i.push([t,a,n])}),!0);for(;e;){let t=[],n=[];i.forEach((e,a)=>{e[0]===t[0]&&!t[1]&&e[1]&&(n.push(a-1),n.push(a)),t=e}),0===n.length||0===i.length?e=!1:(e=!0,n.reverse(),n.forEach(e=>i.splice(e,1)))}let a=[],t=[];i.some(e=>{if(!e[1])return!0;a.push(e[0])}),i.reverse().some(e=>{if(e[1])return!0;t.push(e[0])}),a.forEach(e=>{r="<"+e+">"+r}),t.forEach(e=>{r=r+"</"+e+">"})}return r.replace(g,(e,a,t,n)=>{var i;(a=!!a)?0===--l&&0<=o?(a=r.substring(o,n).trim(),o=-1,a.match(g)?s[t]=parseReplyAsXMLToJSON(a,!1):"true"===(i=a.toLowerCase())?s[t]=!0:"false"===i?s[t]=!1:a.match(/^(\d+|\d+\.|\.\d+|\d+\.\d+)$/)?s[t]=+a:s[t]=a):l<0&&(l=0):1===++l&&(o=n+e.length)}),s},Tab2Article=(AIHandler.sayHello=async()=>{var e=timestmp2str("YYYY/MM/DD"),a=(await chrome.storage.session.get("lastHello")).lastHello;a&&a===e||(chrome.storage.session.set({lastHello:e}),a=await callAIandWait("sayHello"),showSystemNotification(a))},AIHandler.summarizeArticle=async e=>{var a,t;if(await checkAvailability())return[a,t]=await Promise.all([callAIandWait("summarizeArticle",e.article),(async()=>{try{return await callAIandWait("embeddingArticle",e)}catch(e){logger.error("SummarizeArticle",e)}})()]),{summary:a,embedding:t}},AIHandler.embeddingContent=async e=>await callAIandWait("embeddingArticle",e),AIHandler.askArticle=async(a,e,t)=>{var n=Tab2Article[t],i=parseURL(a.url),t=(n||(n=[],Tab2Article[t]=n),n=null,DBs.pageInfo||await initDB(),n=(n=await DBs.pageInfo.get("pageConversation",i))?n.conversation:[],{lang:LangName[myInfo.lang]});if(t.content="<currentArticle>\n"+a.content.trim()+"\n</currentArticle>",a.related){let e=await Promise.all(a.related.map(async e=>{var a=await getPageInfo(parseURL(e.url));return a?'<referenceMaterial title="'+(e.title||a.title)+'" url="'+a.url+'">\n'+a.description.trim()+"\n</referenceMaterial>":null}));e=e.filter(e=>!!e),t.related=e.join("\n")}else t.related="(No Reference Material)";t=PromptLib.assemble(PromptLib.askPageSystem,t),(n=n.filter(e=>"system"!==e[0])).unshift(["system",t]),n.push(["human",a.question]),console.log(n),t=await callAIandWait("directAskAI",[...n]);return n.push(["ai",t]),DBs.pageInfo||await initDB(),await DBs.pageInfo.set("pageConversation",i,{conversation:n,timestamp:Date.now()}),removeAIChatHistory(),t},AIHandler.translateContent=async(e,a,t)=>{if(!await checkAvailability())return"";var n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang];e.requirement=e.requirement||"(No Extra Requirement)",e.myLang=LangName[myInfo.lang]||myInfo.lang;var i=[["human",PromptLib.assemble(PromptLib.firstTranslation,e)]],i=await callAIandWait("directAskAI",i),r=parseReplyAsXMLToJSON(i),s=(logger.log("Translate",r),r.translation&&(i=r.translation._origin||r.translation),dispatchEvent({event:"updateCurrentStatus",data:n.translation.afterFirstTranslate,target:a,tid:t}),dispatchEvent({event:"finishFirstTranslation",data:i,target:a,tid:t}),e.translation=i,r=PromptLib.assemble(PromptLib.reflectTranslation,e),await callAIandWait("directAskAI",[["human",r]]));return(s=parseReplyAsXMLToJSON(s)).needOptimize&&(s.deficiencies||s.suggestions)&&(dispatchEvent({event:"updateCurrentStatus",data:n.translation.afterReflect,target:a,tid:t}),(n=[]).push("#\tDeficiencies"),s.deficiencies?(s.deficiencies=s.deficiencies._origin||s.deficiencies,n.push(s.deficiencies)):n.push("(No deficiency be mentioned.)"),n.push("#\tSuggestions"),s.suggestions?(s.suggestions=s.suggestions._origin||s.suggestions,n.push(s.suggestions)):n.push("(No suggestion be provided.)"),e.suggestions=n.join("\n\n"),r=PromptLib.assemble(PromptLib.deepTranslation,e),console.log(r),i=await callAIandWait("directAskAI",[["human",r]])),dispatchEvent({event:"updateCurrentStatus",data:"",target:a,tid:t}),i},AIHandler.translateSentence=async(e,a,t)=>{var n;if(await checkAvailability())return e.myLang=LangName[myInfo.lang]||myInfo.lang,e=await callAIandWait("translateSentence",e),n=parseReplyAsXMLToJSON(e),logger.log("Translate",n),e=(e=(n||{}).translation||e)._origin?e._origin:e},AIHandler.selectArticlesAboutConversation=async(e,a,t)=>{var n,i,r=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],s=SimilarLimit;isObject(e)&&(s=e.limit||s,e=e.request),dispatchEvent({event:"updateCurrentStatus",data:r.crossPageConv.statusAnalyzeRequest,target:a,tid:t});try{var o=await AIHandler.embeddingContent({article:e});dispatchEvent({event:"updateCurrentStatus",data:r.crossPageConv.statusFindingSimilarFiles,target:a,tid:t}),n=await EventHandler.FindSimilarArticle({vector:o,needContent:!0})}catch{DBs.pageInfo||await initDB();let a=await DBs.pageInfo.all("pageInfo");(a=(a=Object.keys(a).map(e=>a[e])).filter(e=>!!e.content&&!!e.hash)).forEach(e=>e._time=new Date(e.timestamp.replace(/\s+[a-z]+$/i,"")).getTime()),a.sort((e,a)=>a._time-e._time),n=a}try{i=await findRelativeArticles({articles:n,requests:[e],isWebPage:!0,limit:s},a,t)}catch{i=[]}return dispatchEvent({event:"updateCurrentStatus",target:a,tid:t}),i},AIHandler.crossPageConversation=async e=>await callAIandWait("directAskAI",e),AIHandler.getSearchKeyWord=async e=>{var a=[],e=(a.push(["human",PromptLib.assemble(PromptLib.analyzeSearchKeyWords,{tasks:e,time:timestmp2str("YYYY/MM/DD hh:mm :WDE:")})]),getFunctionalModelList("analyzeSearchKeywords")),t=await callLLMOneByOne(e,a,!0,"SearchKeywords");return["search","arxiv","wikipedia"].forEach(e=>{var a=(a=t[e]||"").replace(/[\n\r]+/g,"\n").split("\n").map(e=>e.replace(/^[\s\-]*|\s*$/gi,"")).filter(e=>!!e&&!e.match(/^\s*\(?\s*(none|n\/a|null|nil)\s*\)?\s*$/i));t[e]=a}),logger.info("SearchKeywords",t.search.length+t.arxiv.length+t.wikipedia.length+" / "+t.search.length+" / "+t.arxiv.length+" / "+t.wikipedia.length),t},AIHandler.callLLMForSearch=async e=>{var a,t;for(t of SearchAIModel){var n,i=t.toLowerCase();if("ernie"===i){var r=myInfo.apiKey[i];if(!r||!r.api||!r.secret)continue}else if(!myInfo.apiKey[i])continue;try{if((n=await AI[t].search(e))&&n.length){a=n;break}}catch(e){logger.error("LLMSearch["+t+"]",e)}}return a||[]},AIHandler.findRelativeWebPages=async(e,a,t)=>(e.isWebPage=!0,findRelativeArticles(e,a,t)),AIHandler.replyBasedOnSearch=async e=>{logger.info("ReplyBasedOnSearch","Start"),e.webpages=e.webpages.map(e=>{var a=["<webpage>"];return a.push("<title>"+e.title+"</title>"),a.push("<url>"+e.url+"</title>"),e.summary&&(a.push("<summary>"),a.push(e.summary),a.push("</summary>")),a.push("</webpage>"),a.join("\n")}).join("\n\n");var a=PromptLib.assemble(PromptLib.replyBasedOnSearch,{lang:LangName[myInfo.lang]||myInfo.lang,request:e.request}),t=a.indexOf("{{webpages}}"),n=t+"{{webpages}}".length,t=a.substring(0,t),n=a.substring(n),t=[["human",a=t+e.webpages+n]],e=(logger.info("ReplyBasedOnSearch","Prompt Assembled",t),await callAIandWait("directAskAI",t));return(e=parseReplyAsXMLToJSON(e)).reply?e.reply=e.reply._origin||e.reply:e={reply:e._origin},e.more=(e.more||"").replace(/[\n\r]+/g,"\n").split("\n").map(e=>e.replace(/(^\s*([\-\+\*]\s+)*|\s*$)/g,"")).filter(e=>!!e),logger.info("ReplyBasedOnSearch","Got Reply:",e),e},AIHandler.replyAISearch=async e=>{logger.info("AdvAISearch","Start"),e.webpages=e.webpages.map(e=>{var a=["<article>"];return a.push("<title>"+e.title+"</title>"),a.push("<url>"+e.url+"</title>"),a.push("<content>"),a.push(e.content),a.push("</content>"),a.push("</article>"),a.join("\n")}).join("\n\n");var a=PromptLib.assemble(PromptLib.replySearchRequest,{lang:LangName[myInfo.lang]||myInfo.lang,request:e.request}),t=a.indexOf("{{webpages}}"),n=t+"{{webpages}}".length,t=a.substring(0,t),n=a.substring(n),t=[["human",a=t+e.webpages+n]],e=(logger.info("AdvAISearch","Prompt Assembled",t),await callAIandWait("directAskAI",t));return logger.info("AdvAISearch","Got Reply"),e},AIHandler.preliminaryThinking=async(e,a,t)=>{var n,i=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],e={lang:LangName[myInfo.lang]||myInfo.lang,request:e.request,time:timestmp2str("YYYY/MM/DD hh:mm :WDE:")},e=[["human",PromptLib.assemble(PromptLib.deepThinkingStep0,e)]];logger.info("PreliminaryThinking","Prompt Assembled",[...e]);try{n=(n=await callAIandWait("directAskAI",e)).trim(),logger.info("PreliminaryThinking","Got Reply:\n",n)}catch(e){logger.error("PreliminaryThinking",e),n=i.aiSearch.msgPreliminaryThinkingFailed}return n},AIHandler.deepThinking=async(e,a,t)=>{var n=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],i={lang:LangName[myInfo.lang]||myInfo.lang,request:e.request,time:timestmp2str("YYYY/MM/DD hh:mm :WDE:")},r=(e.webpages=e.webpages.map(e=>{var a=["<article>"];return a.push("<title>"+e.title.replace(/\s+/g," ")+"</title>"),a.push("<url>"+e.url+"</title>"),a.push("<responseOrSummary>"),a.push(e.reply),a.push("</responseOrSummary>"),a.push("</article>"),a.join("\n")}).join("\n\n"),e.basicAnswer||""),s="",o="",l="",g=(logger.info("DeepThinking","Start Deep Thingking"),dispatchEvent({event:"updateDeepThinkingStatus",data:n.aiSearch.msgLearningMaterial,target:a,tid:t}),PromptLib.assemble(PromptLib.deepThinkingStep1,i)),c=g.indexOf("{{webpages}}"),d=c+"{{webpages}}".length,m=g.substring(0,c),p=g.substring(d),h=[["human",g=m+e.webpages+p]];logger.info("DeepThinking","LRM Prompt Assembled",[...h]);try{console.log("LM:",h),s=(l=await callAIandWait("directAskAI",h)).trim(),logger.info("DeepThinking","LRM Got Reply:\n",s),s=s&&"# "+n.aiSearch.hintLearnFromInternet+"\n\n"+s}catch(e){return logger.error("DeepThinking",e),[""]}dispatchEvent({event:"updateDeepThinkingStatus",data:n.aiSearch.msgDeepThinking,target:a,tid:t}),d=(c=(g=PromptLib.assemble(PromptLib.deepThinkingStep2System,i)).indexOf("{{webpages}}"))+"{{webpages}}".length,m=g.substring(0,c),p=g.substring(d),h=[["system",g=m+e.webpages+p]],g=PromptLib.assemble(PromptLib.deepThinkingStep2Summary,i),h.push(["human",g]),h.push(["ai",s]);a={};r?(a.otheropinion=r,r="# "+n.aiSearch.hintMyPreliminaryThinking+"\n\n"+r):a.otheropinion=n.aiSearch.hintNoOpinion,g=PromptLib.assemble(PromptLib.deepThinkingStep2Running,i,a),h.push(["human",g]),logger.info("DeepThinkingStep2","DT Prompt Assembled",[...h]);try{console.log("DT:",h),l=(l=await callAIandWait("directAskAI",h)).trim(),logger.info("DeepThinkingStep2","DT Got Reply:\n",l);var u=parseReplyAsXMLToJSON(l);o=(o=(u.more||{})._origin||u.more||"").replace(/[\n\r]+/g,"\n").split("\n").map(e=>e.replace(/(^\s*([\-\+\*]\s+)*|\s*$)/g,"")).filter(e=>!!e),l=(u.reply||{})._origin||u.reply||l||n.refreshHint}catch(e){logger.error("DeepThinking",e),l=n.refreshHint}return h.pop(),g=PromptLib.assemble(PromptLib.deepThinkingStep2Replace,i,a),h.push(["human",g]),h.push(["ai",l]),h.push(["human",PromptLib.deepThinkingStep3Running]),h.push(["ai",PromptLib.deepThinkingStep3Reply]),console.log("ED:",h),l=["# "+n.aiSearch.hintMyResponseAfterReflection+"\n\n"+l],s&&l.unshift(s),r&&l.unshift(r),[l=l.join("\n\n----\n\n"),h,o]},AIHandler.raedAndReply=async e=>{logger.info("SummaryAndReply","Start");var a=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],t=PromptLib.assemble(PromptLib.replyRequestBasedOnArticle,{lang:myInfo.lang,request:e.request}),n=t.indexOf("{{content}}"),i=n+"{{content}}".length,n=t.substring(0,n),i=t.substring(i);t=[["human",t=n+e.content+i]],logger.info("SummaryAndReply","Prompt Assembled");n=(n=await callAIandWait("directAskAI",t)).trim(),e=parseReplyAsXMLToJSON(n);return e.summary?e.summary=e.summary._origin||e.summary:e.summary="",e.reply=e.reply?e.reply._origin||e.reply:n,logger.info("SummaryAndReply","Got Reply"),console.log(e),e.relevant?e.reply&&(i=[],e.summary&&i.push("## "+a.aiSearch.hintPageSummary+"\n\n"+e.summary.trim()),i.push("## "+a.aiSearch.hintPageReply+"\n\n"+e.reply.trim()),n=i.join("\n\n")):n="",n},{}),RelativeHandler={},ColdDownDuration=3e5,WaitDuration=5e3,RelativeArticleRange=40,getPageNeedAIInfo=(globalThis.waitUntil=s=>new Promise((a,t)=>{var[e,n]=lastRequest;let i=setInterval(()=>{logger.log("Ext","Reactive and waiting..."),dispatchEvent({event:"requestHeartBeating",target:e,tid:n}),dispatchEvent({event:"requestHeartBeating",target:"FrontEnd",tid:LastActiveTab}),dispatchEvent({event:"requestHeartBeating",target:"HomeScreen",tid:LastActiveTab})},WaitDuration);if(isFunction(s))if(isAsyncFunction(s))s().then(e=>{a(e)}).catch(e=>{t(e)}).finally(()=>{clearInterval(i)});else{clearInterval(i);try{var r=s();a(r)}catch(e){t(e)}}else s.then(e=>{a(e)}).catch(e=>{t(e)}).finally(()=>{clearInterval(i)})}),globalThis.fetchWithCheck=(e,r,s,o)=>new Promise((a,t)=>{o=o||5e3,s=s||((s=e.match(/\w+:\/+[^\/]+\//))?s[0]:e);var n=!1,i=(fetch(e,r).then(e=>{n||(n=!0,clearTimeout(i),a(e))}).catch(e=>{n||(n=!0,clearTimeout(i),t(e))}),fetch(s).then(()=>{n||clearTimeout(i)}).catch(e=>{n||(n=!0,clearTimeout(i),t(e))}),setTimeout(()=>{n||(n=!0,t(new Error("Check Connection Timeout: "+s)))},o))}),async e=>{DBs.pageInfo||await initDB();e=await Promise.all([DBs.pageInfo.get("notifyChecker",e.page),DBs.pageInfo.get("notifyChecker",e.path),DBs.pageInfo.get("notifyChecker",e.host)]);return(e={page:e[0],path:e[1],host:e[2]}).page||(e.page={need:0,visited:0}),e.path||(e.path={need:0,visited:0}),e.host||(e.host={need:0,visited:0}),e}),updatePageNeedAIInfo=async(e,a)=>{DBs.pageInfo||await initDB(),await Promise.all([DBs.pageInfo.set("notifyChecker",e.page,a.page),DBs.pageInfo.set("notifyChecker",e.path,a.path),DBs.pageInfo.set("notifyChecker",e.host,a.host)])},manhattanOfVectors=(a,t)=>{var n=Math.min(a.length,t.length),i=0;for(let e=0;e<n;e++)i=Math.max(i,Math.abs(a[e]-t[e]));return i},innerProductOfVectors=(a,t)=>{var n=Math.min(a.length,t.length),i=0;for(let e=0;e<n;e++)i+=a[e]*t[e];return i},calculateSimilarityRate=(r,e)=>{var i,a,s,o,l;return r&&e?(s=a=i=0,r.forEach(e=>{e.weight>i&&(i=e.weight)}),e.forEach(e=>{e.weight>a&&(a=e.weight),s+=e.weight**2}),s/=a,o=0,l=[],e.forEach(t=>{var e,a=t.weight,n=(t=t.vector,0),i=-1;r.forEach((e,a)=>{e=e.vector;e=innerProductOfVectors(e,t);n<e&&(i=a,n=e)}),i<0||((e=l[i])||(l[i]=e=[]),e.push([a,n]))}),i=0,l.forEach((e,a)=>{var t,n;e&&(t=r[a].weight,i<t&&(i=t),n=0,e.forEach(e=>{n+=t*e[0]*e[1]}),o+=n/i/s)}),o):0},initInjectScript=async()=>{var e="CypriteInjection";0<(await chrome.userScripts.getScripts({ids:[e]})).length||(chrome.userScripts.configureWorld({messaging:!0}),await chrome.userScripts.register([{id:e,matches:["*://*/*"],js:[{file:"inject.js"}],world:"MAIN"}]))},decomposePackage=(a,e=20)=>{a=[...a];var t=Math.floor(a.length/e);if(0===t)return[a];var n=[];for(let e=0;e<t;e++){var i=Math.round(a.length/(t-e)),i=a.splice(0,i);n.push(i)}return n},getIrrelevants=async(t,e,a,n,i)=>{var r=[],s=[],o=n?PromptLib.excludeIrrelevantsOnTopic:PromptLib.excludeIrrelevantsOnArticle,l={content:a};return n||(l.summary=i),await Promise.all(e.map(async e=>{l.list=e.map(e=>"- ["+e.title+"]("+e.url+")").join("\n");let a=[["human",PromptLib.assemble(o,l)]],n;n=(n=await callLLMOneByOne(t,a,!0,"ExcludeIrrelevants"))||{},["unrelated","related"].forEach(e=>{var a=n[e]||"",t=[],a=a.replace(/[\r\n]+/g,"\n").split(/\n+/).forEach(e=>{var a=(e=e.replace(/^\s*\-\s+/i,"").trim()).match(/\(\s*(https?:[^\[\] ]+[^\\\[\] ])(\\\\)*\)/);if(a)e=a[1];else{if(!(a=e.match(/https?:[^\[\] ]+/)))return;e=a[0]}t.push(e)});n[e]=t}),n.unrelated.forEach(e=>{r.push(e)}),n.related.forEach(e=>{s.push(e)})})),[r,s]},getRelevants=async(a,e,t,n,i)=>{var r=[],s=n?PromptLib.filterRelevantsOnTopic:PromptLib.filterRelevantsOnArticle,o={content:t};return n||(o.summary=i),await Promise.all(e.map(async e=>{o.list=e.map(e=>{var a="<webpage>\n<title>"+e.title+"</title>\n<url>"+e.url+"</url>";return(e.description||e.summary)&&(a=a+"\n<summary>\n"+(e.description||e.summary)+"\n</summary>"),a+="\n</webpage>"}).join("\n");e=[["human",PromptLib.assemble(s,o)]],e=("\n"+await callAIandWait("directAskAI",{conversation:e,model:a})+"\n").match(/[\-\+]\s+[^\n\r]+?[\n\r]/gi);e&&e.forEach(e=>{(e=e.replace(/[\-\+]\s+/i,"").trim()).match(/^\[[^\n\r]+?\]\(/)&&(e=e.replace(/^\[[^\n\r]+?\]\(/,"").replace(/\)$/,"").trim()),r.includes(e)||r.push(e)})})),r},findRelativeArticles=async(i,e,a)=>{if(myInfo.inited||await getWSConfig(),await checkAvailability()){for(var t=I18NMessages[myInfo.lang]||I18NMessages[DefaultLang],n=!isBoolean(i.isWebPage)||i.isWebPage,r=(i.requests||[]).join("\n\n")||"(NONE)",s=(i.content||[]).map(e=>"<summary>\n"+e.trim()+"\n</summary>").join("\n\n")||"(NONE)",o=(logger.log("SW",i.articles.length+" Similar Articles for "+(i.url||"(NONE)")),dispatchEvent({event:"updateCurrentStatus",data:t.crossPageConv.hintExcludeIrrelevants,target:e,tid:a}),getFunctionalModelList("excludeIrrelevants")),l=[...i.articles],g=0,c=[],d=Date.now();;){g++;let e=decomposePackage(l,70),a,t;try{[a,t]=await getIrrelevants(o,e,r,n,s)}catch(e){a=[],t=[],console.error(e)}if(logger.info("Filter Irrelevants","Excludes("+g+"): "+a.length+" / "+t.length),a.forEach(e=>{c.includes(e)||c.push(e)}),l=(l=l.filter(e=>!a.includes(e.url))).filter(e=>!t.includes(e.url)),3<=g||l.length<=20||a.length+t.length<=7)break}d=Date.now()-d,logger.info("Exclude Irrelevants",d+"ms, "+c.length);for(var m,l=i.articles.filter(e=>!c.includes(e.url)),p=i.limit||RelativeArticleRange,h=(l.length>p&&l.splice(p),i.articles=[...l],console.log(l.map(e=>"-\t"+e.title+" : "+e.url).join("\n")),dispatchEvent({event:"updateCurrentStatus",data:t.crossPageConv.statusFindingRelatedFiles,target:e,tid:a}),(o=getFunctionalModelList("identityRelevants"))[0]),u=0,g=0,f=[],d=Date.now();;){g++;let e=decomposePackage(l,5),a;for(;;){logger.log("Identify Relevants","Curent Model: "+h);try{a=await getRelevants(h,e,r,n,s);break}catch(e){if(logger.error("Identify Relevants",e),a=[],++u>=o.length){m=e;break}h=o[u]}}if(logger.info("Identify Relevants","Filter("+g+"): "+a.length),m){showSystemNotification(m);break}if(a.forEach(e=>{f.push(parseURL(e))}),l=l.filter(e=>!a.includes(e.url)),2<=g||a.length<=2||l.length<=3)break}if(d=Date.now()-d,logger.info("Identify Relevants",h+" : "+d+"ms, "+f.length),n){let t=[];f.forEach(a=>{i.articles.some(e=>{if(e.url===a)return t.push(e),!0})}),f=t}else f=(f=await Promise.all(f.map(async e=>{var a=await getPageInfo(e);if(!a||!a.hash||a.hash===i.hash)return null;var t,n={};for(t in a)n[t]=a[t];return n.similar=100,n}))).filter(e=>!!e);return console.log(f.map(e=>"-\t"+e.title+" : "+e.url).join("\n")),dispatchEvent({event:"updateCurrentStatus",target:e,tid:a}),f}},parseParams=e=>{var t={};return(e=(e||"").split("?")).shift(),(e=(e||"").join("?").split("&")).forEach(e=>{var a=(e=e.split("=")).shift();a&&(e=e.join("="),t[a]=e)}),t};initDB(),EventHandler.notify=(e,a,t)=>{var n="Server";"BackEnd"===a?n="Background":"FrontEnd"===a?n="Content":"PageEnd"===a&&(n="Injection"),isString(e)||isNumber(e)||isBoolean(e)||(e=JSON.stringify(e)),logger.log("Notify | "+n,e)};